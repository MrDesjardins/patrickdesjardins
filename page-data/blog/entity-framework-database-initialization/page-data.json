{
    "componentChunkName": "component---src-pages-blog-mdx-slug-tsx",
    "path": "/blog/entity-framework-database-initialization",
    "result": {"data":{"mdx":{"frontmatter":{"title":"Entity Framework Database Initialization","date":"May 27, 2014"},"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Entity Framework Database Initialization\",\n  \"date\": \"2014-05-27\",\n  \"categories\": [\"entity-framework\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"Initializing a database with Entity Framework is essential. It creates the database, tables and all constrains. In a previous article, we saw that is it possible to generate the database when the context specify to the database to initialize itself or when adding an entity to the database. However, when the database exist and that we have changed model classes, how can we control how the database schema is altering? This is the goal of this article. We will see how we can control Entity Framework to create and especially how to update database schema.\"), mdx(\"p\", null, \"We have already see the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"default initializer\"), \". It is named \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"CreateDatabaseIfNotExists\"), \". This is only interesting when you start a brand new application. The reason is that a small change like adding a new property to a class will throw an exception. The reason is that Entity Framework realize that the model from the code is not anymore synchronized with the table schema. This result to an \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"InvalidOperationException\"), \" that look like this:\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"Additional information: The model backing the 'YourContext' context has changed since the database was created. Consider using Code First Migrations to update the database.\")), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"400px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/deff2569d9fb860f1c267c83a4f3ea53/e17e5/InvalidOperationExceptionModelBackingChanged-400x224.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"55.99999999999999%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACTElEQVQoz22S7W7VOBCGc617DcsNrFi4Ai5kEVuKhFaAFroFFQqlYvk4bU9PzontxIkTO07sfDzopGX5syO9GksjveN5ZhKtK6QQSCmRSiGEQGtNjJFxnJjniRh7fB/pQsT34b8c4sgwzsRxYhgn4jCSaN1T2xrnHG3b0rZuMfoRxhiOjv7m6bNjXrx8w8ujE46O3y3vNydnfPj4mQ9nn3l/9oXT8xVJZQKqaZdO0wTjuNfINN2YllXDo1crHr5a8eh4zeGp4vCd5Mmp5OCt4OAkW/Jfp1s+rbYk3g/ookdrQ6EtxgS6zjNNMzCTV447hwO//AG/HvTce5xz/0nBvcOCuwc5vz/O+e1PxYPnFc/ONQnzhK4lV+KSXZniYsPEze/2/Fzr+fgt4+TflLOvKUIW5HlBWRTkSiGFRGSCXSa5us5IWh+xLhIHCBHcLcfplqP3Hc6HRfvFuDARhpn/i026JXFtIBOBqprZ7jKUysm1pel6nPd0fU/tB5o9GhvQjV+aWOcxjaMyFl01FGXNOs1I5mnCe0+WXSC2/6Dla0r1lkK9psrPCX0gk5qL9Y6rVJGXDXlhEKokkyVpVrDeKi7W2aIkxmG5uRgDQ+wZYssQHUNomcbAvr663LDZCqQqEDJnlymutxKRV+ykZrPLudrIG0PbRJQKWAuNHWjbDtfux+3pY2QYR2TVYVxcGBrboY2jNBZZmMUwzXLWqeTyWpDs761pRup6oK5rrOtp2gHjPdY5Qt+TloFvouXLzrLJLanaM2tQhfk59q3hd4jsOUmoMUVDAAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"InvalidOperationExceptionModelBackingChanged 400x224\",\n    \"title\": \"InvalidOperationExceptionModelBackingChanged 400x224\",\n    \"src\": \"/static/deff2569d9fb860f1c267c83a4f3ea53/e17e5/InvalidOperationExceptionModelBackingChanged-400x224.png\",\n    \"srcSet\": [\"/static/deff2569d9fb860f1c267c83a4f3ea53/5a46d/InvalidOperationExceptionModelBackingChanged-400x224.png 300w\", \"/static/deff2569d9fb860f1c267c83a4f3ea53/e17e5/InvalidOperationExceptionModelBackingChanged-400x224.png 400w\"],\n    \"sizes\": \"(max-width: 400px) 100vw, 400px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"If you want to use that type of initializer, you have to manually delete the whole database for every modification of your context. For your information, the default intializer could also be explicitly specify in the contructor of your DbContext.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" public YourContext(): base(\\\"DefaultConnection\\\") { Database.SetInitializer<YourContext>(new CreateDatabaseIfNotExists<YourContext>()); //Default one } \\n\")), mdx(\"p\", null, \"Instead of having to delete yourself every times the database, you can use the second initializer that will drop for you the database if any changes has been detected. This second initializer the drop the database for you is named \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"DropCreateDatabaseIfModelChanges\"), \".\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" public YourContext(): base(\\\"DefaultConnection\\\") { Database.SetInitializer<YourContext>(new DropCreateDatabaseIfModelChanges<YourContext>()); //Drop database if changes detected } \\n\")), mdx(\"p\", null, \"It is important to note that this initializer will not delete the database if you do not change model. If you run your application multiple time, it could start to have a lot of data that you may not want. In the scenario you would prefer to erase every data of your database even if you do not change the model, than you have to use a third initializer. \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"DropCreateDatabaseAlways\"), \" drop the database every time the application start.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" public YourContext(): base(\\\"DefaultConnection\\\") { Database.SetInitializer<YourContext>(new DropCreateDatabaseAlways<YourContext>()); //Drop database every times } \\n\")), mdx(\"p\", null, \"The problem with all these initializer is that all of them at some point let you down with default value. You have to have a SQL script to fill up tables with initial data. This is where the most useful initializer exist. It is the custom initializer. You can create you own initializer and inherit from one of the three we just discussed. For example, you can drop all the database every times the schema as changed which will create all tables but also in this custom initializer tell Entity Framework to insert default demo values. You can also create one that does not inherit any of the three but inherit from \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"IDatabaseInitializer\"), \". The advantage of inheriting from an existing initializer is that you can use the leverage of basic functionnality and only override the Seed method to push data into the website.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" public YourContext(): base(\\\"DefaultConnection\\\") { Database.SetInitializer<YourContext>(new CustomInitializer<YourContext>()); //Custom if model changed and seed values } //... public class CustomInitializer<T> : DropCreateDatabaseIfModelChanges<YourContext> { protected override void Seed(YourContext context) { base.Seed(context); } } \\n\")), mdx(\"p\", null, \"The CustomInitializer method override the Seed method. This is where you can use the context passed by parameter to insert data into your database. You do not have to call SaveChanges to save anything because the class that call the seed method call the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"SaveChanges\"), \" right after calling the seeding method.\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"400px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/e9d68bb085eaba19a29f008af42c0f90/e17e5/CustomInitializer-400x178.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"44.66666666666667%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB6klEQVQoz3WRaWsTURSG5+/7tUoXhbZBtMa0VK1CraCtrdqC4Adjk9hm32bpTObOfu/cmUcyoegXX3g474HD4SxGHOfMXRvbt7CFz2Lh4HkmQeQhpCDKBG3fYet2xEZvztrPG9aaNzy67rHeWtJns91nszOsolGUmnEwo383ZOD0mYUWs9BkcDenYw8YLIZ8nXR5enTO4dtTjk6uOPpwyYtXp2zvvePJ3gk7++fsvflM7eAjhhASy4sRSUoQBMSxwnEyHCdG5iVL/RjZ7NZf0u9c0ml9o926oNk8Y6feYL32nMfPGuzWD9iq1TFEmGCJBW7i4wYevZHDZO6iC0VZrhpe3Y5oHH+pfNe0EVnC/2QIoZCyRGqN6ycEYYoqCiKZE6SyKvr0q8vO/vvKX89Nxr5PrgtkritUrimKAq0LjDDM8YUmTmH5oDhLiaQiTmLyQldNzls9thvHlfdTSagkiVIk+Yo0z/9OqFTBdHrHdGoxs1y8xYJQhAjLw3MFeSY5a/Z5WHsNWuK5LnEUIbOMLE1JkxVxnFQYea7JspwkSVBKASVKaeJYEkUSLUtOvv/mwcYhpu1y2+0xnoyZzec4joNpjpjO+pjmENueYNwf/l7/5iUrf9Ferry6YSYlWmuklBVFsaIsFUWh+APxiZq1g7bn2QAAAABJRU5ErkJggg==')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"CustomInitializer 400x178\",\n    \"title\": \"CustomInitializer 400x178\",\n    \"src\": \"/static/e9d68bb085eaba19a29f008af42c0f90/e17e5/CustomInitializer-400x178.png\",\n    \"srcSet\": [\"/static/e9d68bb085eaba19a29f008af42c0f90/5a46d/CustomInitializer-400x178.png 300w\", \"/static/e9d68bb085eaba19a29f008af42c0f90/e17e5/CustomInitializer-400x178.png 400w\"],\n    \"sizes\": \"(max-width: 400px) 100vw, 400px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"If the database already exist, you may stumble into the case of having an error. The exception \\\"Cannot drop database because it is currently in use\\\" can raise. This problem occurs when an active connection remains connected to the database that it is in the process of being deleting. A trick is to override the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"InitializeDatabase\"), \" method and to alter the database. This tell the database to close all connection and if a transaction is open to rollback this one.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" public class CustomInitializer<T> : DropCreateDatabaseAlways<YourContext> { public override void InitializeDatabase(YourContext context) { context.Database.ExecuteSqlCommand(TransactionalBehavior.DoNotEnsureTransaction , string.Format(\\\"ALTER DATABASE {0} SET SINGLE_USER WITH ROLLBACK IMMEDIATE\\\", context.Database.Connection.Database)); base.InitializeDatabase(context); }\\n\\nprotected override void Seed(YourContext context) { var person = new Person() {Name = \\\"SeededPerson\\\", BirthDate = new DateTime(1900, 1, 1)}; context.Persons.Add(person); base.Seed(context); } } \\n\")), mdx(\"p\", null, \"The last configuration is to remove all initialization. This will not check if the database has changed, neither check if something is not synchronized between tables and model classes. This is perfect if you have an existing database that is not handled by Entity Framework for the creation and insertion of initial values.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" public YourContext(): base(\\\"DefaultConnection\\\") { Database.SetInitializer<YourContext>(null); //No initialization } \\n\")), mdx(\"p\", null, \"Before concluding, I have to say that any of the initializer should have been set in the static constructor of your context. The static constructor is called before any constructors and is executed once. This is what we want. The reason is that in some of your application, you may initialize more than once the context. You do not want to execute all the process to check if the database if ready to be changed or not.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" static YourContext() { //Database.SetInitializer<YourContext>(new CreateDatabaseIfNotExists<YourContext>()); //Default one //Database.SetInitializer<YourContext>(new DropCreateDatabaseIfModelChanges<YourContext>()); //Drop database if changes detected //Database.SetInitializer<YourContext>(new DropCreateDatabaseAlways<YourContext>()); //Drop database every times //Database.SetInitializer<YourContext>(new CustomInitializer<YourContext>()); //Custom if model changed and seed values Database.SetInitializer<YourContext>(null); //Nothing is done } \\n\")), mdx(\"p\", null, \"We have see how to use Entity Framework to initialize a database but also how to seed it with testing values. We have see many different way to initialize the database, tables and model classes with Entity Framework. So far, we have not discussed about Entity Framework Migration Tool to initialize the database. This tool allow to have manual call to with Entity to the database to perform initialization. It has the advantage to have the full control of when and what is done but has the disadvantage to have more to do. Information about Migration tool will be discussed later. You can find all code discussed in this article at \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/MrDesjardins/EntityFrameworkTestConsole/tree/dd74613a51e8533d833aac6706d6b067c859b7e0\"\n  }, \"GitHub\"), \" or download the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/MrDesjardins/EntityFrameworkTestConsole/archive/dd74613a51e8533d833aac6706d6b067c859b7e0.zip\"\n  }, \"Zip file here\"), \".\"));\n}\n;\nMDXContent.isMDXComponent = true;"}},"pageContext":{"id":"b1e38120-520c-5a63-9eb4-e7ca38d695fc"}},
    "staticQueryHashes": ["3159585216"]}