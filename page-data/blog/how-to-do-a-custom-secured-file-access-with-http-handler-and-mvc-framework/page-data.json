{
    "componentChunkName": "component---src-templates-blog-article-tsx",
    "path": "/blog/how-to-do-a-custom-secured-file-access-with-http-handler-and-mvc-framework",
    "result": {"data":{"mdx":{"frontmatter":{"title":"How to do a custom secured file access with Http Handler and MVC framework","date":"September 15, 2012"},"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"How to do a custom secured file access with Http Handler and MVC framework\",\n  \"date\": \"2012-09-15\",\n  \"categories\": [\"asp-mvc\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"In diverse scenario you could require to give to your user files. You can let them access them directly by having a directory of files and give the complete path to the file but this can lead to different issue. First of all, this will bind the server folders/files structures to the url that you give the the user which might not be interesting. Second, it doesn't give you any control over the files shared. Third, you may want to add algorithm for caching or give expiry to some files. All those customs code can't be done by giving a direct access to files, the solution : using Http Handler.\"), mdx(\"p\", null, mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"./how-to-access-session-information-from-httphandler-ashx-file%22\"\n  }, \"HttpHandler was there in Asp.Net traditional\"), \" and in Asp.Net MVC is even easier because not configuration is required for IIS.\"), mdx(\"p\", null, \"First, you need to add a new route to let know the MVC routing system that the url sent is not going to go to a traditional controller but to go to your http handler.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \"public class ExternalFileRouteHandler : IRouteHandler { \\n  public IHttpHandler GetHttpHandler(RequestContext requestContext) { } \\n} \\n\")), mdx(\"p\", null, \"Inside the Global.asax.cs you need to add your route. You need to put the new route BEFORE the default route because otherwise it won't trig the route. The reason is that because the default route has default parameter that 2 parameters will automatically goes inside the Default route. But, if you set the FilesRoute before, the condition will match and this one will be executed.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \"public static void RegisterRoutes(RouteCollection routes) { \\n  routes.IgnoreRoute(\\\"{resource}.axd/{*pathInfo}\\\"); \\n  routes.Add(\\\"FilesRoute\\\", new Route(\\\"files/{uniqueidentifier}\\\", new ExternalFileRouteHandler())); \\n  routes.MapRoute( \\\"Default\\\", \\n    // Route name \\n    \\\"{controller}/{action}/{id}\\\", \\n    // URL with parameters \\n    new { controller = \\\"Home\\\", action = \\\"Index\\\", id = UrlParameter.Optional\\n    } \\n    // Parameter defaults \\n  );\\n} \\n\")), mdx(\"p\", null, \"At this moment, the code doesn't compile because our \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"IRouteHandler\"), \" doesn't return anything from the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"GetHttpHandler\"), \". This is why we need to create a class that will inherit of \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"IHttpHandler\"), \".\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \"public class ExternalFileHandler : IHttpHandler {\\n\\npublic void ProcessRequest(HttpContext context) { }\\n\\npublic bool IsReusable { get; private set; } }\\n\\npublic class ExternalFileRouteHandler : IRouteHandler { \\n  public IHttpHandler GetHttpHandler(RequestContext requestContext) { \\n    return new ExternalFileHandler(); \\n  } \\n} \\n\")), mdx(\"p\", null, \"At this point, we have nothing to do anymore from the perspective of the url. Every call will look like this:\"), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"http://yourwebsite.com/files/yourIdenfierHere.abc\")), mdx(\"p\", null, \"Now, you need to get the file but first let's get some information about the request like the request itself, the response where we will send back the image and some information about the server and what file is requested.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \"public class ExternalFileHandler : IHttpHandler { \\n  public void ProcessRequest(HttpContext context) {\\n\\n    var response = context.Response; \\n    var request = context.Request; \\n    var server = context.Server; \\n    var uniqueFileIdentifier = RequestContext.RouteData.Values[\\\"uniqueidentifier\\\"].ToString(); \\n  }\\n\\n  public bool IsReusable { get; private set; } \\n} \\n\")), mdx(\"p\", null, \"If we debug we can see that if the request is sent with the good url that the http handler catch the request with the good value.\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"400px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/066f0ff84e113f9ee2a5dcd5d34e3fd3/e17e5/ExternalFileHandlerSimple-400x123.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"30.66666666666667%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/ElEQVQY05XQyU7DQAyA4bz/A4FACLUU0ah0EdC0KekRpXszWybNMvOjhAPHgqXPsg+2ZAfHQ83pCOfMcdKWozJsMsXZWEResFU5J51TVTXe+6sC5xpEVnMpINclWgqUEJjcklcNtqzRUqKkwjuHuyJotzYOigoudUntPUJrMik5i4zGe/4TQZuMKJj334ieBiyfh4Q3d4xu75k8PJIuYnarhF38a9/2y8/OPm4lP1ZrgqapMdmBTZSQzmPSjwXx6zuT3pBp74VpP2QxmhGFY2aDIfNwzFcUd8Pbdulq3enqOCFony0E2BKMbZBGoW2BMqAtCAXKeByOvxz/DV9zx4dseRuSAAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"ExternalFileHandlerSimple 400x123\",\n    \"title\": \"ExternalFileHandlerSimple 400x123\",\n    \"src\": \"/static/066f0ff84e113f9ee2a5dcd5d34e3fd3/e17e5/ExternalFileHandlerSimple-400x123.png\",\n    \"srcSet\": [\"/static/066f0ff84e113f9ee2a5dcd5d34e3fd3/5a46d/ExternalFileHandlerSimple-400x123.png 300w\", \"/static/066f0ff84e113f9ee2a5dcd5d34e3fd3/e17e5/ExternalFileHandlerSimple-400x123.png 400w\"],\n    \"sizes\": \"(max-width: 400px) 100vw, 400px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"The next step is to check if the file really exist. In fact, we need to check if the unique identifier match a file. If it's not the case, in a scenario of a people trying to get some body else file, it should return a message.\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"395px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/692ce30b54fbbe09b0378c8d0aac14a4/2cb6c/filenotfound.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"32.33333333333333%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAp0lEQVQY052NvQ6CMBhF+zK48BQsGgaeUQZKDBs+BTShXydJlP45aukiI22NSowj8eTm3uUkF+22uziOo2iTpmmSJFmWNU0zXM6EkK7rTn2vlOKccyGklIILKcQwDFpfrbUo3+dlecAYFwWuqqquj21LABgssG8oBUopAFAKjL0EZO43M9rRGKX1Y5pCCN77sA707sV3zs3z7FeDPuO8d86t//x9/pMnDb9DbckN9icAAAAASUVORK5CYII=')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"filenotfound\",\n    \"title\": \"filenotfound\",\n    \"src\": \"/static/692ce30b54fbbe09b0378c8d0aac14a4/2cb6c/filenotfound.png\",\n    \"srcSet\": [\"/static/692ce30b54fbbe09b0378c8d0aac14a4/5a46d/filenotfound.png 300w\", \"/static/692ce30b54fbbe09b0378c8d0aac14a4/2cb6c/filenotfound.png 395w\"],\n    \"sizes\": \"(max-width: 395px) 100vw, 395px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \"public void ProcessRequest(HttpContext context) {\\n\\n  var response = context.Response; \\n  var request = context.Request; \\n  var server = context.Server; \\n  var uniqueFileIdentifier = request.RequestContext.RouteData.Values[\\\"uniqueidentifier\\\"].ToString();\\n\\n  FileInformation file = GetFromPersistenceStorage(uniqueFileIdentifier); \\n  if (file == null) { \\n    response.Write(\\\"File not found\\\"); \\n  } \\n} \\n\")), mdx(\"p\", null, \"As you can see, the file came from GetFromPersistenceStorage method. This method in reality would go into the database and search the file from the unique file identifier. This field in the database should be indexed and unique.\"), mdx(\"p\", null, \"The next step is to check if the file is really on the server. It might be stored correctly into the database but not available on the server.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \"public void ProcessRequest(HttpContext context) {\\n\\n  var response = context.Response; \\n  var request = context.Request; \\n  var server = context.Server; \\n  var uniqueFileIdentifier = request.RequestContext.RouteData.Values[\\\"uniqueidentifier\\\"].ToString();\\n\\n  FileInformation file = GetFromPersistenceStorage(uniqueFileIdentifier);\\n\\n  //Validate the file exist in the persistence storage \\n  if (file == null) { \\n    response.Write(\\\"File not found\\\"); return; \\n  }\\n\\n  //Validate the the file exist on the server physically \\n  string completeFilePath = Path.Combine(file.PathOnServer, file.FileName); \\n  if(!File.Exists(completeFilePath)) { \\n    response.Write(\\\"File not on the server\\\"); \\n    return; \\n  }\\n\\n  //Prepare to send the file \\n  response.Clear(); \\n  response.ContentType = file.FileType; \\n  response.TransmitFile(completeFilePath); \\n  response.End();\\n} \\n\")), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"385px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/2fc6eec4f00ff09a26edacce7cab26a1/409e6/filenotfoundserver.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"27.333333333333332%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAi0lEQVQY06XLsQ2DMBCFYY9DzQguiIJXZBVkKZTcWYpxgUjvO8OZESBylDIFUr7m/c1Tza2p67qqqnvbaq2NMV3Xhclba/u+fwwDOufQISIgOldmHAEAQggKAL2f5nlGxGfhl+XFzKlYU0pETMTFJ77NHCOpLELMIpkibdsqIpL347xEnX9Qxy8Xz2+jOgtOylZjIgAAAABJRU5ErkJggg==')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"filenotfoundserver\",\n    \"title\": \"filenotfoundserver\",\n    \"src\": \"/static/2fc6eec4f00ff09a26edacce7cab26a1/409e6/filenotfoundserver.png\",\n    \"srcSet\": [\"/static/2fc6eec4f00ff09a26edacce7cab26a1/5a46d/filenotfoundserver.png 300w\", \"/static/2fc6eec4f00ff09a26edacce7cab26a1/409e6/filenotfoundserver.png 385w\"],\n    \"sizes\": \"(max-width: 385px) 100vw, 385px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"Finally, if the file is present, we will receive its content.\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"380px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/6293761e34bf95a2fd3529850b3d971c/3f520/messagefromfile.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"20%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAuklEQVQI133CPQ6CMBgAUK7CBTiCBhJOoYtu8nMljB4EFgoOzOIgSCp8XxdAEkypYDU6G1+eYhiGpmmqqpqmqev6fDbfel5d16f0mKZpds7KsgSorpQCIgAiMoAKEBljysayVuvVYrm0bdt1Xdtxdrt9kiT+R+D7AYm+SEQ+CYmiMCRhSOL4oFTXEoExhk3TIEDb3iill6LI8rzrOs55/9P93ve9IoQYhmHgfBzHhxDjl3zKaZqklK+/3kziwoU8WmLcAAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"messagefromfile\",\n    \"title\": \"messagefromfile\",\n    \"src\": \"/static/6293761e34bf95a2fd3529850b3d971c/3f520/messagefromfile.png\",\n    \"srcSet\": [\"/static/6293761e34bf95a2fd3529850b3d971c/5a46d/messagefromfile.png 300w\", \"/static/6293761e34bf95a2fd3529850b3d971c/3f520/messagefromfile.png 380w\"],\n    \"sizes\": \"(max-width: 380px) 100vw, 380px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"You can now secure the file. This can be done in many ways. First, I suppose that the database table that contain every files will have some kind of relation between the user and files. Let say that every files has the possibility to allow many users, that mean the you should have 3 tables : User, UsersFiles and Files. UsersFiles table contain the id of the User that can access the file and the id of the file.\"), mdx(\"p\", null, \"So the FileInformation class that we have defined earlier would have a List that can access the file. A small modification will be required to get the current user from the session and to check if the file allow the user. \"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \"public void ProcessRequest(HttpContext context) {\\n\\n  var response = context.Response; \\n  var request = context.Request; \\n  var server = context.Server; \\n  var uniqueFileIdentifier = request.RequestContext.RouteData.Values[\\\"uniqueidentifier\\\"].ToString();\\n\\n  FileInformation file = GetFromPersistenceStorage(uniqueFileIdentifier);\\n\\n  //Validate the file exist in the persistence storage \\n  if (file == null) { \\n    response.Write(\\\"File not found\\\"); \\n    return; \\n  }\\n\\n  //Validate if the current logged user can access the file \\n  if (!file.UserIdAuthorized.Contains(SessionUserId)) { \\n    response.Write(\\\"You are not authorized to see this file.\\\"); \\n    return; \\n  }\\n\\n  //Validate the the file exist on the server physically \\n  string completeFilePath = Path.Combine(file.PathOnServer, file.FileName); \\n  if(!File.Exists(completeFilePath)) { \\n    response.Write(\\\"File not on the server\\\"); \\n    return; \\n  }\\n\\n  //Prepare to send the file \\n  response.Clear(); \\n  response.ContentType = file.FileType; \\n  response.TransmitFile(completeFilePath); \\n  response.End(); \\n}\\n\\npublic class FileInformation { \\n  public string PathOnServer { get; set; } \\n  public string FileName { get; set; } \\n  public string FileType { get; set; } \\n  public List<int> UserIdAuthorized { get; set; } \\n} \\n\")), mdx(\"p\", null, \"And that's it. You can from here add any other type of validation or expiry or caching. The method \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"GetFromPersistenceStorage()\"), \" could store into the cache the content of the file and if the file is requested again would get it from the cache instead of the server. You could also add expiry for file that may be deleted later by setting a timespan on the FileInformation and having a generated DateTime inside the table that contain the file information. A simple validation inside \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ProcessRequest\"), \" will do the job.\"), mdx(\"p\", null, \"You are now limitless about what to do with files on your server.\"));\n}\n;\nMDXContent.isMDXComponent = true;"}},"pageContext":{"id":"6e128bbd-13a4-55f6-a9ac-6e520c4d5ceb","totalPages":76}},
    "staticQueryHashes": ["3159585216"]}