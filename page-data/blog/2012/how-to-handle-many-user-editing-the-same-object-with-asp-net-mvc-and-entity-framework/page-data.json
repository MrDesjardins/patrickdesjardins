{
    "componentChunkName": "component---src-pages-blog-mdx-slug-tsx",
    "path": "/blog/2012/how-to-handle-many-user-editing-the-same-object-with-asp-net-mvc-and-entity-framework/",
    "result": {"data":{"mdx":{"frontmatter":{"title":"How to handle many user editing the same object with Asp.Net MVC and Entity Framework","date":"October 3, 2012"},"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"How to handle many user editing the same object with Asp.Net MVC and Entity Framework\",\n  \"date\": \"2012-10-03\",\n  \"categories\": [\"asp-mvc\", \"entity-framework\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"The web is stateless and usually have the particularity to have many users. In some application, a single information can or could be modified by more than one person. This has the side effect that conflict could occur.\"), mdx(\"p\", null, \"Let say that user A want to edit the product 123 and few seconds later, the user B edit the same product. By the time user A save the product, the user B might have changed some information. If the user A save and later the user B save this could create some conflict.\"), mdx(\"p\", null, \"In normal web situation, the user B would have override the user A changes. In fact, this is totally acceptable in a lot of situation. This is called \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"\\\"Client Wins\\\"\"), \" By this, I mean that if the user B decided that the product 123 name should be called \\\"product 12345\\\" and that this user is the last to edit the product that he should be the one with the latest information about what should be the name of this product. If many user want to change something and change it for a different value, let say user A wanted to called if \\\"prod 12345\\\" and user B \\\"product 12345\\\" than it's more a logic problem by the enterprise than a software problem.\"), mdx(\"p\", null, \"Nevertheless, in some situation, the first user must have the privilege to be no override. Since we cannot lock the entry and for good we can't, an other approach is to simply let know the second user that someone has changed the information since the load of the entity. This situation is called \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"\\\"Server Wins\\\"\"), \" and solve the problem of \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"concurrency conflict\"), \".\"), mdx(\"h2\", null, \"How to handle concurrency conflict with Entity Framework and Asp.Net MVC with Server Wins approach\"), mdx(\"p\", null, \"We do not want to lock an entry from the database because some entry could be lock when the system crash and it also cause performance problem. The best way is to use optimistic approach. With Microsoft Sql Server, we can use a column of type TimeStamp or RowVersion. In both case, it will contains an incremental sequential number that will increase every time the entry is modified. This approach let you know that if you load an entity with the number 23 and when you save you are at 24 that someone has done something to the entity because it should be remain to 23.\"), mdx(\"p\", null, \"To be able to apply this strategy to your entities, you need to configure your BaseEntity.cs class (a class that every model will inherit). You need to add a TimeStamp property with the TimeStamp and ConcurrencyCheck attribute.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \"public class BaseEntity { public int Id { get; set; }\\n\\n[ConcurrencyCheck] [Timestamp] \\npublic Byte[] Timestamp { get; set; } } \\n\")), mdx(\"p\", null, \"To be able to use this value we need to add it into the view in a hidden field. This hidden field will give back the Timestamp to the server and will be used to compare with the database version when saving.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" @Html.HiddenFor(model => model.Timestamp) \\n\")), mdx(\"p\", null, \"So, the whole view look like this: \"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" @using (Html.BeginForm()) { @Html.HiddenFor(model => model.Timestamp) @Html.ValidationSummary(true) <fieldset> <legend>Customer</legend>\\n\\n<div class=\\\"editor-label\\\"> @Html.LabelFor(model => model.FirstName) </div> <div class=\\\"editor-field\\\"> @Html.EditorFor(model => model.FirstName) @Html.ValidationMessageFor(model => model.FirstName) </div>\\n\\n<div class=\\\"editor-label\\\"> @Html.LabelFor(model => model.LastName) </div> <div class=\\\"editor-field\\\"> @Html.EditorFor(model => model.LastName) @Html.ValidationMessageFor(model => model.LastName) </div>\\n\\n@Html.HiddenFor(model => model.Id)\\n\\n<p> <input type=\\\"submit\\\" value=\\\"Save\\\" /> </p> </fieldset> } \\n\")), mdx(\"p\", null, \"The model look like:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" public class Customer:BaseEntity { public string FirstName { get; set; } public string LastName { get; set; } } public class BaseEntity { public int Id { get; set; } [ConcurrencyCheck] [Timestamp] public Byte[] Timestamp { get; set; } } \\n\")), mdx(\"p\", null, \"And the controller which contain the compare code: \"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \"[HttpPost] \\npublic ActionResult Edit(Customer customer) { if (ModelState.IsValid) { db.Entry(customer).State = EntityState.Modified; try { db.SaveChanges(); } catch (DbUpdateConcurrencyException ex) { var entry = ex.Entries.Single(); var databaseValues = (Customer)entry.GetDatabaseValues().ToObject(); var clientValues = (Customer)entry.Entity; if (databaseValues.FirstName != clientValues.FirstName) ModelState.AddModelError(\\\"Name\\\", \\\"Current value: \\\" + databaseValues.FirstName); if (databaseValues.LastName != clientValues.LastName) ModelState.AddModelError(\\\"Budget\\\", \\\"Current value: \\\" + databaseValues.LastName);\\n\\nModelState.AddModelError(string.Empty, \\\"The record you attempted to edit \\\" + \\\"was modified by another user after you got the original value. The \\\" + \\\"edit operation was canceled and the current values in the database \\\" + \\\"have been displayed. If you still want to edit this record, click \\\" + \\\"the Save button again. Otherwise click the Back to List hyperlink.\\\");\\n\\ncustomer.Timestamp = databaseValues.Timestamp; } return RedirectToAction(\\\"Index\\\"); }\\n\\nViewBag.Id = new SelectList(db.Licenses, \\\"Id\\\", \\\"Name\\\", customer.Id); return View(customer); } \\n\")), mdx(\"p\", null, \"As you can see if you open 2 tabs of a single entity if you save in the first tab and try to save in the second you will see the error message (the exception message is from \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"http://www.asp.net/mvc/tutorials/getting-started-with-ef-using-mvc/handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application\"\n  }, \"Asp.net website\"), \").\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"400px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/1ff7bc5b5fd9b27468299e5ffdb19b94/e17e5/concurrencyException-400x382.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"95.66666666666666%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB60lEQVQ4y6VUi26bQBD0/3+Y60SK4wf4AXHVFmSTxOCjNsbgu5lq7wx+JFLbGGnE3i43zD7uOrx4ANyNTlEUDIKAucodqTHnD8Ru1n+zzQVhGIb8vds5wjvRafNVikjXRJoS65TYbIj3d+L1lVivnS2xPCeSFRHHhOyR+Grlvjkc2BGZRqR/XxDPA8L3iacn4rlPPD4SvR4xHBITnxiNnL/fJ7rfiPHYxd7eiCQ5EUr+Ine5dBs8nxgMiNnMkU9nRBgS84AIAsLzXFyIxD+bEsvVOeWW8OcPott1pPPTxsmUmE6JyYQYDV1MfiIxgT9x5OLbbhtCuBpGETkYkr5HBCHhjR2RqBI185nbLD8IXxyJrMeeq6vWJ0KAWmuW+71Fvd+7oCg/Hgmjz+vm3dh1zTbD0xxbwt1uxziO+SuKuFHKCjbG2Ga1kPUtLv1a27clPBwOzJWiUso6rwfWXKu4xM0psYSipsgV8zimURse05Q6y65QZ5kbDZk3GQ+ZvVMTPhCKUVcVt0qx2G6pq4qmrj8AVUWUpZ01C6nhZwrFKMs9kySx9TtKLdrauPrp/0nZ1rAsmWUb2wzp+C2O0u1/uGnONSwKLhYLRlF0bsoX0BIqlfOh1+NYzibw5bvREjZzdO8l2/B0Ph3YO/AHihTFlFTqZk4AAAAASUVORK5CYII=')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"concurrencyException 400x382\",\n    \"title\": \"concurrencyException 400x382\",\n    \"src\": \"/static/1ff7bc5b5fd9b27468299e5ffdb19b94/e17e5/concurrencyException-400x382.png\",\n    \"srcSet\": [\"/static/1ff7bc5b5fd9b27468299e5ffdb19b94/5a46d/concurrencyException-400x382.png 300w\", \"/static/1ff7bc5b5fd9b27468299e5ffdb19b94/e17e5/concurrencyException-400x382.png 400w\"],\n    \"sizes\": \"(max-width: 400px) 100vw, 400px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"If we go check in the database, we will see that the table contains a hexadecimal value inside the TimeStamp.\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"378px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/877faa3fb4b006f22a5ada2a5fb7a07f/f0991/timstampdatabase.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"20.333333333333332%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAzElEQVQI1zXJ7WqDMBQAUN//teoQh2zIpqk2mhi0id7c+JVIhZkMBjt/T3Rv5Nd3dSeEcVGUdZ7nWZYRUhljpmkCAEQEAPUPAIwxWutxHKNl2RHnvh8YF3GcJEmapu/x7a2qqFJT14mGtsNTOXdY66x1Sqm6fjAmtMZoXTdjFspE2zDO+bKs1jpSEiGGbdvLorjFcfbxSdvmQWnfS9Sm491Tjq/zFe3bbq0FnJ1z13WFEM7zdMcRQvD+WtcZUQNMUkmpJOJ8/Vze+7/1v3Q52J96m3YoAAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"timstampdatabase\",\n    \"title\": \"timstampdatabase\",\n    \"src\": \"/static/877faa3fb4b006f22a5ada2a5fb7a07f/f0991/timstampdatabase.png\",\n    \"srcSet\": [\"/static/877faa3fb4b006f22a5ada2a5fb7a07f/5a46d/timstampdatabase.png 300w\", \"/static/877faa3fb4b006f22a5ada2a5fb7a07f/f0991/timstampdatabase.png 378w\"],\n    \"sizes\": \"(max-width: 378px) 100vw, 378px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"h2\", null, \"Conclusion\"), mdx(\"p\", null, \"You can have a quick and easy way to control concurrency conflict with a timespan field located inside every entities. You only need to add this field in a base model class, modify your controller to handle the exception and add an hidden field into the view.\"), mdx(\"h2\", null, \"Edit February 2th, 2013\"), mdx(\"p\", null, \"In the Workout website I have used concurrency and I have found few details that were not written in the above blog article. First of all, you must have the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"ConcurrencyCheck\"), \" attribute and not only the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Timestamp\"), \" attribute over the property that will take care of the concurrency. If you do the modification, do not forget to regenerate the database to have the database having this field (which should be not nullable). Entity Framework will take care to compute to correct value to set into this field automatically. Second, you need to not load the entity from the database just before using SetValues (to update scalar property of your object). This would result to alter the Timestamp and to override the one that came from the form (ViewModel to Model) to the value of the one from the database. This cause the mechanism to not detect the concurrency. Here is what I had previously which work to update the scalar value but doesn't work with the concurrency. Following will be the new code which work in both case.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" public int Update(Muscle entity) { Muscle fromDatabase = Get(entity.Id); DatabaseContext.Entry(fromDatabase).CurrentValues.SetValues(entity); DatabaseContext.Entry(fromDatabase).State = EntityState.Modified; } \\n\")), mdx(\"p\", null, \"By this: \"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" public int Update(Muscle entity) { this.Set<Muscle>().Attach(entity); this.ChangeTracker.Entries<Muscle>().Single(d => d.Entity == entity).State = EntityState.Modified; } \\n\")), mdx(\"p\", null, \"Hope this detail will help someone else who is struggling with Asp.Net MVC concurrency with Entity Framework.\"));\n}\n;\nMDXContent.isMDXComponent = true;"}},"pageContext":{"id":"64e86e16-7bf6-587b-9591-2ad99934c405","slug":"2012/how-to-handle-many-user-editing-the-same-object-with-asp-net-mvc-and-entity-framework","__params":{"slug":"2012"}}},
    "staticQueryHashes": ["3159585216"]}