{
    "componentChunkName": "component---src-templates-blog-article-tsx",
    "path": "/blog/complex-type-cannot-have-reference-to-entities",
    "result": {"data":{"mdx":{"frontmatter":{"title":"Complex Type cannot have reference to entities","date":"March 18, 2014"},"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Complex Type cannot have reference to entities\",\n  \"date\": \"2014-03-18\",\n  \"categories\": [\"entity-framework\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"If you have a \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"complex type\"), \", you cannot have within this one any reference to other entities. Let's imagine that I have a money class.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" public class Money { public decimal Value { get; set; } public CurrencyType Currency { get; set; } } \\n\")), mdx(\"p\", null, \"Has you can see, it has a reference to another class, named CurrencyType. This type is abstract and must be set to a Currency class like USD or CND. However, this bring Entity Framework with a ModelValidationException.\"), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"System.Data.Entity.ModelConfiguration.ModelValidationException: One or more validation errors were detected during model generation:\"), mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"DataAccess.Contexts.Implementations.CurrencyType: Name: Each type name in a schema must be unique. Type name 'CurrencyType' is already defined.\")), mdx(\"p\", null, \"It is not possible to have this configuration. It would be very practical because you can have the Money in any of you class and the table would have the Money_Value and Money_CurrencyId.\"), mdx(\"p\", null, \"One option is to remove the currency from the Money or to have both property of the Currency class inside the Money class. However, the strong positive that we had with CurrencyType was that this one was using Value Object pattern. This mean that it was strongly typed in the code and had a reference to a Currency table which had USD and CDN currency.\"), mdx(\"p\", null, \"The question is how to use \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Entity Framework\"), \" and still have an association between the amount of the money (value) and the currency without losing the strongly association with the table that has all currencies? This lead us to a second option that is to remove the money from the entity that has the money. Instead of having the money directly into the class, you can have all money into a separated table. This remove the use if complex type on the money table. Of course, this cause some overhead by having more tables and more joins to do to get all the information. It also has the problem of having the ID of the Money inside your Entity.\"), mdx(\"p\", null, \"A possible solution that I have used is to loss the strong Foreign Key but still have the data directly into the entity that use the money. This way, less tables, more speed, and in the code we use the value object pattern. Here is the money class and the value object class for currency.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" public class Money { public decimal Value { get; set; } public int CurrencyTypeId { get { return this.Currency.Id; } set { this.Currency = CurrencyType.GetCurrencyFromId(value); } } /// /// This is ignored by EntityFramework /// public CurrencyType Currency { get; set; } }\\n\\npublic abstract class CurrencyType : ValueObject {\\n\\npublic static readonly CurrencyType Canada = new CanadianCurrency(); public static readonly CurrencyType UnitedStatesOfAmerica = new USACurrency();\\n\\npublic static CurrencyType GetCurrencyFromId(int value) { Type type = typeof(CurrencyType);\\n\\nvar fields = type.GetFields(BindingFlags.Public | BindingFlags.Static); foreach (var field in fields) { var fieldValue = field.GetValue(null) as CurrencyType; if (fieldValue != null) { if (fieldValue.Id == value) { return fieldValue; } } } throw new KeyNotFoundException(string.Concat(value, \\\" cannot be found in any static fields.\\\")); } } \\n\")), mdx(\"p\", null, \"As you can see, the money class does have the value and the CurrencyType property. This property is ignored by Entity Framework so Money can be as \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Complex Type\"), \". However, we have an integer field that can be used but should not since we have a strongly typed currency property. Here is how to make it works with Entity configuration.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" public class MoneyConfiguration : ComplexTypeConfiguration { public MoneyConfiguration() { this.Ignore(d => d.Currency); } } \\n\")), mdx(\"p\", null, \"How to use this money class? The best way is to check the unit tests.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \"[TestMethod] \\npublic void GivenAnInteger_WhenIntegerIsAKeyOfACurrency_ThenReturnConcreteCurrency() { \\n  // Arrange \\n  var idOfCanada = CurrencyType.Canada.Id; var expected = CurrencyType.Canada;\\n\\n  // Act \\n  var found = CurrencyType.GetCurrencyFromId(idOfCanada);\\n\\n  //Assert \\n  Assert.IsInstanceOfType(found,typeof(CanadianCurrency)); \\n  Assert.AreEqual(expected.Id,found.Id); \\n} \\n\")), mdx(\"p\", null, \"This is required because when we will load from Entity Framework, we will only get the integer. But, in the business logic the code will use the property. This is why the property of CurrencyTypeId is tightly bound with Currency with the reflection code. In the case that the Id is not legit (does not exist), an exception is thrown. This should never occur but we should still test the case.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \"[TestMethod] \\npublic void GivenAnInteger_WhenIntegerIsNotAnExistingKeyOfACurrency_ThenThrowException() { \\n  // Arrange \\n  const int idNonExisting = -1;\\n\\n  // Act & Assert \\n  TestExtensions.Thrown(() => CurrencyType.GetCurrencyFromId(idNonExisting)); \\n} \\n\")), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"400px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/335823177e9a3e933d828529855e3f88/e17e5/UnitTestPassed-400x38.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"9.333333333333334%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAXklEQVQI122MQQqAIBQFu//5LNAffEFBWkSQOy0nKoKIBh682Uw3qOCsRURIKZFzptbKTaO1xpvTvzvZ9g2/KF1aJ8xg6E2PyIhz7op771FVQgjXDzFSSvmNPkGZhQM8rJh52kWw5gAAAABJRU5ErkJggg==')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"UnitTestPassed 400x38\",\n    \"title\": \"UnitTestPassed 400x38\",\n    \"src\": \"/static/335823177e9a3e933d828529855e3f88/e17e5/UnitTestPassed-400x38.png\",\n    \"srcSet\": [\"/static/335823177e9a3e933d828529855e3f88/5a46d/UnitTestPassed-400x38.png 300w\", \"/static/335823177e9a3e933d828529855e3f88/e17e5/UnitTestPassed-400x38.png 400w\"],\n    \"sizes\": \"(max-width: 400px) 100vw, 400px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")));\n}\n;\nMDXContent.isMDXComponent = true;"}},"pageContext":{"id":"590796b3-336e-5b5b-94c3-b53dddf06d87","totalPages":76}},
    "staticQueryHashes": ["3159585216"]}