{
    "componentChunkName": "component---src-templates-blog-article-tsx",
    "path": "/blog/poco-proxy-and-lazy-loading",
    "result": {"data":{"mdx":{"frontmatter":{"title":"POCO Proxy and Lazy Loading","date":"October 6, 2011"},"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"POCO Proxy and Lazy Loading\",\n  \"date\": \"2011-10-06\",\n  \"categories\": [\"c-sharp\", \"entity-framework\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"POCO objects using Entity Framework as ORM require the creation of a proxy. When the proxy is created, the rest is exactly the same as if you were using standard entity from the object context.\"), mdx(\"h2\", null, \"Creating the proxy\"), mdx(\"p\", null, \"In fact, the proxy will be generated by the Entity Framework (in runtime). To be more accurate, each of the POCO classes have a proxy. This proxy will derive from your POCO classes. This will let the Entity Framework keeping track of the state change and enable the use of lazy loading. Since the proxy class derive from POCO classes, these one must not be sealed, private or abstract.\"), mdx(\"p\", null, \"We have said that the proxy is created in the runtime and this is a good thing because we can enable and disable the proxy. If you desire to enable the proxy, you must use the \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"ProxyCreationEnabled\"), \" to true. This property reside inside the context object, inside the context option.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" var db = new NorthWindContext(); db.ContextOptions.ProxyCreationEnabled = true; //Enable the proxy creation in runtime \\n\")), mdx(\"p\", null, \"This is not always enabled because in some case, like while using serialization with WCF, only \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"[known]\"), \" class can be serialized. This won't be the case of the runtime generated proxy.\"), mdx(\"p\", null, \"From here, you need to do some changes in your POCO class and the change varies depending if you want only the lazy loading or also the change tracking.\"), mdx(\"h2\", null, \"Lazy Loading\"), mdx(\"p\", null, \"To have lazy loading enable the navigation properties (the one that link to an other object that need to be loaded or a collection to be loaded) must be public and virtual and not sealed. This way, it's possible for the proxy to change some call to add the lazy loaded statement.\"), mdx(\"h2\", null, \"Change Tracking\"), mdx(\"p\", null, \"The first step is to make you POCO class legit for lazy loading. So, all information in the previous paragraph must remain true. Each collection of object must return a type that derive from a generic ICollection. It's also require to use the CreateObject method instead of using new to create your class.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" var db = new NorthWindContext(); var myPoco = db.CreateObject<MyPocoObject>(); \\n\")), mdx(\"p\", null, \"You can fine further information on \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"http://msdn.microsoft.com/en-us/library/dd468057.aspx\",\n    \"title\": \"MSDN for POCO and Lazy Loading\"\n  }, \"MSDN\"), \".\"), mdx(\"h2\", null, \"Complete example\"), mdx(\"p\", null, \"Let's make this theory in practice. We are gonna use the Northwind database and the table Customers and Orders.\"), mdx(\"h3\", null, \"Preparation\"), mdx(\"p\", null, \"Lets create a new ADO.NET entity data model and use the generator creating the model for us. Do not forget to remove the Custom Tool text on the Edmx file.\"), mdx(\"p\", null, \"After that, lets create the 2 POCO classes.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" namespace PocoAndLazy.POCO { public class Customer { public string CustomerID { get; set; } public string CompanyName { get; set; } public string ContactName { get; set; } public string ContactTitle { get; set; } public string Address { get; set; } public string City { get; set; } public string Region { get; set; } public string PostalCode { get; set; } public string Country { get; set; } public string Phone { get; set; } public string Fax { get; set; }\\n\\npublic virtual List<Order> Orders { get; set; } //Virtual + ICollection<T> } } \\n``` and \\n```csharp\\n namespace PocoAndLazy.POCO { public class Order { public int OrderID { get; set; } public string CustomerID { get; set; } public int EmployeeID { get; set; } public DateTime? OrderDate { get; set; } public DateTime? RequiredDate { get; set; } public DateTime? ShippedDate { get; set; } public int? ShipVia { get; set; } public decimal? Freight { get; set; } public string ShipName { get; set; } public string ShipAddress { get; set; } public string ShipCity { get; set; } public string ShipRegion { get; set; } public string ShipCountry { get; set; } public string ShipPostalCode { get; set; } } } \\n\")), mdx(\"p\", null, \"After the ObjectContext class.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" namespace PocoAndLazy { public class ModelContext : ObjectContext { private ObjectSet<Customer> customers; private ObjectSet<Order> orders;\\n\\npublic ModelContext(): base(\\\"name=NorthwindEntities\\\", \\\"NorthwindEntities\\\") { customers = CreateObjectSet<Customer>(); orders = CreateObjectSet<Order>(); }\\n\\npublic ObjectSet<Customer> Customers { get { return customers; } }\\n\\npublic ObjectSet<Order> Order { get { return orders; } } } } \\n\")), mdx(\"p\", null, \"And lets do a quick test.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" ModelContext db = new ModelContext(); var bigCustomers = db.Customers.Where(c => c.Orders.Count > 20); foreach (var customer in bigCustomers) { Debug.WriteLine(\\\"Customer#\\\" + customer.CustomerID); } \\n``` Output: ``` \\n Customer#ERNSH Customer#QUICK Customer#SAVEA \\n\")), mdx(\"p\", null, \"This display the list of customer that have over 10 orders. I have not given the explication of how to create POCO objets with Entity Framework here because this is covered in an other article. The important information is that we have now a stable structure to continue to the core of the goal : lazy loading.\"), mdx(\"p\", null, \"Currently, no order can be show if we loop through the list of order of each of these 3 clients. The reason is the default value is eager loading the use of \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"Include\"), \" is missing and no explicit loading with \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"Load\"), \" is provided.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" ModelContext db = new ModelContext(); var bigCustomers = db.Customers.Where(c => c.Orders.Count > 20); foreach (var customer in bigCustomers) { Debug.WriteLine(\\\"Customer#\\\" + customer.CustomerID); foreach (var order in customer.Orders) { Debug.WriteLine(\\\"---Order#\\\" + order.OrderID); } } \\n\")), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"400px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/ea739b5fa8acfd31a4b693708ee4c358/e17e5/POCO_List_Not_Loaded-400x225.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"56.333333333333336%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACE0lEQVQoz2WSeW/TUBDE8/2/SlVERQ9ACPVSEVAJKK1L4iZxbjv2s9/h69mxfygugZauNFpp/5idmd1eWWakpkEpSA0oDUZDmkNSWvJ6Q5YZwjAkjmO01iR5ya7atn2GXlmWWLtBqYZYtKgEZAJxrJBaEicGmbQoaZBxTF5aRFZiCostyxekPWttN8yyilhVCGOJTU0UC2SiiKKSSG1I0gKhNFlRkFc1ua2oquqlwrquadtuD+uo4W4Qcj+c0XcnTCczxt6a++GUO3eAM3BxXZcizzDGdBFsoaTquknTR8I/aZCmNVo15EVNmhZIKUiNIdc5SkgyU6B1QVU1nbptXFs0TfNc4S4HaAilZTRL8RchK18QBWvSYI3wTkjCU2ajA+beGUpphHhUaO2j9S3xf4SgtWXlFyhdd4cQIqLILXniolc/KcwDUoyobNlZbzY1T+uJZboNdW1Zhj733owbx8Xpj3FHM7xxwGiwYDwV3Pan3PVH3DgPOAOPRZCwXEuW62R3lJa63l0Nbh2Hg5Mz9o+vePPhC6/ffmLv6IJX767YOzxn//iSvcMLjj5e8/78O6efHS6v+1x87dMri4It6Waz+WvbDwTfbn7x43bQ9a1Sb7piPFkyHM+7PhhOGU2WzJchk3mAN/MZT1f/FD590DTLWIcRfhCxWPr4QUieFx2yLMekGdpkSGWIE4XY/mssCUXCb3lyQLJsu8sgAAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"POCO List Not Loaded 400x225\",\n    \"title\": \"POCO List Not Loaded 400x225\",\n    \"src\": \"/static/ea739b5fa8acfd31a4b693708ee4c358/e17e5/POCO_List_Not_Loaded-400x225.png\",\n    \"srcSet\": [\"/static/ea739b5fa8acfd31a4b693708ee4c358/5a46d/POCO_List_Not_Loaded-400x225.png 300w\", \"/static/ea739b5fa8acfd31a4b693708ee4c358/e17e5/POCO_List_Not_Loaded-400x225.png 400w\"],\n    \"sizes\": \"(max-width: 400px) 100vw, 400px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"Of course we can add in the constructor of the Customer the initialization of the Orders collection. \"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" public Customer() { Orders = new List<Order>(); } \\n``` But, you and me understand that it still does not load the list of orders. Let for fun just enable the Lazy Loading.\\n\\n\\n```csharp\\n ModelContext db = new ModelContext(); db.ContextOptions.LazyLoadingEnabled = true; var bigCustomers = db.Customers.Where(c => c.Orders.Count > 20); foreach (var customer in bigCustomers) { Debug.WriteLine(\\\"Customer#\\\" + customer.CustomerID); foreach (var order in customer.Orders) { Debug.WriteLine(\\\"---Order#\\\" + order.OrderID); } } \\n``` We can not see in the output: ``` \\n Customer#ERNSH ---Order#10258 ---Order#10263 ---Order#10351 ---Order#10368 ---... Customer#QUICK ---Order#10273 ---Order#10285 ---Order#10286 ---... Customer#SAVEA ---Order#10324 ---Order#10393 ---Order#10398 --- ... \\n```  If we check the SQL profiler we see N+1 call to the database (1 to get all customers and 3 to gets each of their orders).\\n\\n![](images/sqlprofilerpocolazy.png)\\n\\nWith the use of eager loading, a single query is done. \\n```csharp\\n protected void Page_Load(object sender, EventArgs e) { ModelContext db = new ModelContext(); db.ContextOptions.LazyLoadingEnabled = false; var bigCustomers = db.Customers.Include(\\\"Orders\\\").Where(c => c.Orders.Count > 20); foreach (var customer in bigCustomers) { Debug.WriteLine(\\\"Customer#\\\" + customer.CustomerID); foreach (var order in customer.Orders) { Debug.WriteLine(\\\"---Order#\\\" + order.OrderID); } } } \\n\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sql\"\n  }, \" SELECT [Project2].[C1] AS [C1], [Project2].[CustomerID] AS [CustomerID], [Project2].[CompanyName] AS [CompanyName], [Project2].[ContactName] AS [ContactName], ... FROM ( SELECT [Project1].[CustomerID] AS [CustomerID], [Project1].[CompanyName] AS [CompanyName], [Project1].[ContactName] AS [ContactName], [Project1].[ContactTitle] AS [ContactTitle], ... 1 AS [C1], [Extent3].[OrderID] AS [OrderID], [Extent3].[CustomerID] AS [CustomerID1], [Extent3].[EmployeeID] AS [EmployeeID], [Extent3].[OrderDate] AS [OrderDate], [Extent3].[RequiredDate] AS [RequiredDate], [Extent3].[ShippedDate] AS [ShippedDate], ... FROM (SELECT [Extent1].[CustomerID] AS [CustomerID], [Extent1].[CompanyName] AS [CompanyName], [Extent1].[ContactName] AS [ContactName], [Extent1].[ContactTitle] AS [ContactTitle], ... (SELECT COUNT(1) AS [A1] FROM [dbo].[Orders] AS [Extent2] WHERE [Extent1].[CustomerID] = [Extent2].[CustomerID]) AS [C1] FROM [dbo].[Customers] AS [Extent1] ) AS [Project1] LEFT OUTER JOIN [dbo].[Orders] AS [Extent3] ON [Project1].[CustomerID] = [Extent3].[CustomerID] WHERE [Project1].[C1] > 20 ) AS [Project2] ORDER BY [Project2].[CustomerID] ASC, [Project2].[C2] ASC \\n\")), mdx(\"p\", null, \"So without Lazy Loading, nothing is shown until explicit load is called, with Lazy loading N+1 query is done to the database and with Eager loading a single query is done to the database.\"));\n}\n;\nMDXContent.isMDXComponent = true;"}},"pageContext":{"id":"335730c2-da99-5dfb-b562-cf155cb77ef5","totalPages":74}},
    "staticQueryHashes": ["3159585216"]}