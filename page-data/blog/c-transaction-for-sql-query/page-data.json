{
    "componentChunkName": "component---src-pages-blog-mdx-slug-tsx",
    "path": "/blog/c-transaction-for-sql-query",
    "result": {"data":{"mdx":{"frontmatter":{"title":"C# Transaction for SQL query","date":"September 30, 2011"},"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"C# Transaction for SQL query\",\n  \"date\": \"2011-09-30\",\n  \"categories\": [\"ado-net\", \"c-sharp\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"Transaction lets you rollback if a problem occur. That mean that if you insert 100 entries into the database and 1 of them is wrong, the whole list of entry will be not saved in the persistence. This is very interesting because most of the time you want to have your action to be \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"http://en.wikipedia.org/wiki/ACID#Atomicity\",\n    \"title\": \"Wikipedia Atomicity\"\n  }, \"atomic\"), \".\"), mdx(\"p\", null, \"This is an example of a good practice method that should been in a data access layer. To simplify, all will be written in the same file and the database used is the Northwind database.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" public class Customer { public string Id { get; set; } public string Name { get; set; } public bool IsNew { get; set; } }\\n\\npublic partial class_Default : System.Web.UI.Page { protected void Page_Load(object sender, EventArgs e) { List<Customer> customers = new List<Customer>(){ new Customer(){Id=\\\"ID001\\\", Name=\\\"Name001\\\", IsNew=true} , new Customer(){Id=\\\"ID002\\\", Name=\\\"Name002\\\", IsNew=true} , new Customer(){Id=\\\"ID003\\\", Name=\\\"Name003\\\", IsNew=true} }; SaveCustomers(customers); }\\n\\npublic int SaveCustomers(IEnumerable<Customer> customers) { ConnectionStringSettings connectionStringSettings = ConfigurationManager.ConnectionStrings[\\\"ApplicationServices\\\"];\\n\\nint rowsAffected=0; using (var connection = new SqlConnection(connectionStringSettings.ConnectionString)) { connection.Open(); var transaction = connection.BeginTransaction(); using (var command = new SqlCommand()) { command.Transaction = transaction; command.Connection = connection; try { foreach (var customer in customers) { if (customer.IsNew) { command.CommandText = \\\"INSERT INTO customers (CustomerID, CompanyName) VALUES (@id, @name)\\\"; } else { command.CommandText = \\\"UPDATE customers SET CompanyName = @name WHERE CustomerID = @id\\\"; } command.CommandType = System.Data.CommandType.Text; command.Parameters.Clear(); //Remove command.Parameters.Add(new SqlParameter(\\\"id\\\", customer.Id)); command.Parameters.Add(new SqlParameter(\\\"name\\\", customer.Name)); rowsAffected += command.ExecuteNonQuery(); } transaction.Commit(); } catch { transaction.Rollback(); } } connection.Close();\\n\\n}\\n\\nreturn rowsAffected; } } \\n\")), mdx(\"p\", null, \"This code contain some interesting things. First, to create a transaction you must have a connection already open. This is required. Otherwise you will have an exception that will told you that the connection is close.\"), mdx(\"p\", null, \"Second, you must know that if you forget to commit once you are done querying that even if all queries were legit that the database won't have your data. That's right, even if the \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"rowsAffected += command.ExecuteNonQuery();\"), \" add number in the rowAffected, this won't be real until you commit. The code above works because all customers have IsNew to true. If you run this code and change one to False you will tell the Save method to use the Update statement. The command will Update but the database won't find the customer and throw an exception. What it means is that the code will go in the catch and RollBack the transaction. Even if the rowsAffected is at 1, you will have 0 rows added or updated in the database.\"), mdx(\"h2\", null, \"Type of isolation\"), mdx(\"p\", null, \"To create a transaction you need to get it from the DbCommand. The reason is simple, a transaction is different between database provider. So, when using the SqlDbCommand, you will have more option of transaction for the Microsoft Sql Server Database. Also, transaction code will do isolation on the database. Sql Server let you do different type of transaction.\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"388px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/a37202be473a561d053c645c1094c761/96c67/typetransctionsql.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"46%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABJklEQVQoz3WRYW+DIBCG/f8/blmypYIgYkWx1tpeQQUUWFyXrWm7N3ef7p57c3cJ24u3j08umoIxIYSUddudutHI69jp+ajnXk8XAO9DCDHcyfuQnGbXz8swGQCIrxRCnCZljbZmcvY35lFDch6G/tj1xyPA9bs1PLAxxroiBX0vGDbT2c3gDIRlgr5KSEbS3Y5SppR6abzBosgpyjAS1T6nhDEa/Doqlfhtmy3ja93gvGCEUlaWJeccYzwMw7azMc6YaMx2FbiCse4ZFhUtWIZxlqYpQkhKGWN0ziWjNkrFy3mQUrZtq/V4O9KD875klOYYY631rbAsS9LIxjkb/9UPzAuSZYRz7r3/gwFgWdf7Fz4PaJqqritCCELocDiEENZ1tdZ+AYtuAh8hJ/2jAAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"typetransctionsql\",\n    \"title\": \"typetransctionsql\",\n    \"src\": \"/static/a37202be473a561d053c645c1094c761/96c67/typetransctionsql.png\",\n    \"srcSet\": [\"/static/a37202be473a561d053c645c1094c761/5a46d/typetransctionsql.png 300w\", \"/static/a37202be473a561d053c645c1094c761/96c67/typetransctionsql.png 388w\"],\n    \"sizes\": \"(max-width: 388px) 100vw, 388px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"ReadUncommitted\\nThis is a very weak transaction and should not be used. In fact, this type doesn't lock anything in the database. It's possible that the data changes or be deleted by the time the commit is done. This can lead to unpredictable reaction. This type of isolation will produce for a Select statement this query: \")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sql\"\n  }, \" SELECT * FROM CUSTOMERS WITH (NOLOCK) \\n\")), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"ReadCommitted\\nThis one try to have a share-lock on the data. If it succeed, it will protect any change from the external into those values.- RepeatableRead\\nAll the data implicate in the transaction are lock.- Serializable\\nAll the table is lock. This prevent adding other rows to the table. This is the best isolation but it comes with the cost of being not performant. Locking more value than desire can lead to reduce the speed to all other connection that need to read or edit these rows.- Snapshot\\nIf your database is Sql Server 2005 and over you can use this type of transaction that will do a copy of the affected row. To be more accurate, rows are versionned and when others connection want to access these rows instead of locking a copy is made. This keep the system in good shape without creating any slow time for anyone.\")), mdx(\"h2\", null, \"Transaction Type\"), mdx(\"p\", null, \"This type of transaction is known as \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Lightweight Transaction Manager (LTM)\"), \" because only one connection is required. Sometime, you may use one connection to read and while it's looping you could open an other connection to update. Anytime you have two connections open, the transaction type become \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Distributed Transaction (DT)\"), \". Microsoft Windows operating system have a Distributed Transaction Coordinator (DTC) that is a service that run in the background of your computer. The Distributed Transaction Coordinator (DTC) requires the use of System.Transactions that will be discussed in a later article or to use explicit code to execute the code under DTC. To use DTC developers have to create classes that inherited from the ServicedComponent class in the System.EnterpriseServices namespace. This won't be discussed because it's easier now to simply use the System.Transactions that handle implicitly if it really require to be DTC or LTM.\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"382px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/7d6b56d74da40938fc4f9d71933849ae/77edc/dtc.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"29.000000000000004%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABO0lEQVQY03XPS06DQACAYe7o2oXRVI0H8QLGZRPjQk18NOpWTbqwUWzLo0BbBsoMwwClPGbAtkJhXKhLv/wX+AXgBmhmzwBwLIAcxwGgLEv+n6bhnGdx5GPoObYwcUNVA7IOhqo5MZ3RBBkmNExo2t7YwmzdLCuernmQ15LpiTryaDV1k9eh+a7awoOxanWqg055eF/v3latzmbvZr19tdq5Lvfvvo4e+dZlc/y8uhh8njwFpy/zs4/luVi0e1m7RwUVRl0JimP/TfeteOMVnBQcUQ4pRxmHaTONarLIc5ZrqgaRlxfLjOaUFZQVwoxEEcEEQeK6oYeTRRgFJInmoY+b38+aMrZIKSZ+MI+TjMUp/UnQHV+W5L7YVyRZUUYDsS/LsqqohjY2dAO7eFPXjLE0TS0ALGBRSrM/3z4NO7sTXuALAAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"dtc\",\n    \"title\": \"dtc\",\n    \"src\": \"/static/7d6b56d74da40938fc4f9d71933849ae/77edc/dtc.png\",\n    \"srcSet\": [\"/static/7d6b56d74da40938fc4f9d71933849ae/5a46d/dtc.png 300w\", \"/static/7d6b56d74da40938fc4f9d71933849ae/77edc/dtc.png 382w\"],\n    \"sizes\": \"(max-width: 382px) 100vw, 382px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")));\n}\n;\nMDXContent.isMDXComponent = true;"}},"pageContext":{"id":"759798cd-a963-5ce0-b51f-b74f700bbc3b"}},
    "staticQueryHashes": ["3159585216"]}