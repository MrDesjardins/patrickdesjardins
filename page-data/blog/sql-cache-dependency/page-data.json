{
    "componentChunkName": "component---src-pages-blog-mdx-slug-tsx",
    "path": "/blog/sql-cache-dependency",
    "result": {"data":{"mdx":{"frontmatter":{"title":"SQL Cache Dependency and Sql Cache Dependency Admin","date":"August 6, 2013"},"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"SQL Cache Dependency and Sql Cache Dependency Admin\",\n  \"date\": \"2013-08-06\",\n  \"categories\": [\"ado-net\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"SQL Server since few years (2005) can push notifications when data has changed. The notification of this push use the Sql Cache Dependency. Before, the SQL Cacche Dependency has to continually poll the database, now, it's really push. To make it works, SQL Server you must enable Microsoft SQL Server Service Broker.\"), mdx(\"p\", null, \"Once everything is installed property (Sql Server), you must enable your database to works with a service broker.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sql\"\n  }, \" ALTER DATABASE YourDatabase SET ENABLE_BROKER GO \\n\")), mdx(\"p\", null, \"By doing this SQL statement, you may have error like this one : \\\"error 9772: The Service Broker in database 'YourDatabase' cannot be enabled because there is already an enabled Service Broker with the same ID\\\". If this happen, just execute : \"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sql\"\n  }, \" ALTER DATABASE YourDatabase SET ENABLE_BROKER WITH ROLLBACK IMMEDIATE GO ALTER DATABASE YourDatabase SET NEW_BROKER GO \\n\")), mdx(\"p\", null, \"Next move is to enable notification with IIS.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sql\"\n  }, \" GRANT SUBSCRIBE QUERY NOTIFICATIONS TO \\\"TESTSERVER\\\\\\\\ASPNET\\\" \\n\")), mdx(\"p\", null, \"The next step is within the code. You need to setup the notification to listen the database. This can be set in the global.asax\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" SqlDependency.Start(ConfigurationManager.ConnectionStrings[\\\"yourConnectionString\\\"].ConnectionString); \\n\")), mdx(\"p\", null, \"You can also make it stop.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" SqlDependency.Stop(ConfigurationManager.ConnectionStrings[\\\"yourConnectionString\\\"].ConnectionString); \\n\")), mdx(\"p\", null, \"In both case, this should be setup once for your application. Here is an example.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \"\\n\\nstring tableName = \\\"YourTable\\\"; string connectionString = \\\"...\\\"; var result = HttpContext.Current.Cache[tableName] as List<T>;\\n\\nif (result == null) { using (var cn = new SqlConnection(connectionString)) { cn.Open(); var cmd = new SqlCommand(\\\"SELECT * FROM ...\\\", cn); cmd.Notification = null; cmd.NotificationAutoEnlist = true; SqlCacheDependencyAdmin.EnableNotifications(connectionString); if (!SqlCacheDependencyAdmin.GetTablesEnabledForNotifications(connectionString).Contains(tableName)) { SqlCacheDependencyAdmin.EnableTableForNotifications(connectionString, tableName); }\\n\\nvar dependency = new SqlCacheDependency(cmd); SqlDataReader reader = command.ExecuteReader(); try { while (reader.Read()) { // Load the list into result } } finally { // Always call Close when done reading. reader.Close(); }\\n\\nHttpContext.Current.Cache.Insert(tableName, result, dependency); } } \\n\")), mdx(\"p\", null, \"As you can see, it checks if the table exist. If not, it creates a table called AspNet_SqlCacheTablesForNotification where every table name will have a row. If a value change, the entry in this table will be removed.\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"329px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/patrickdesjardins/static/11cd2464fc3bf1aff3a5c6a346b909f3/004a5/sqltablenotification.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"23.333333333333332%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAz0lEQVQY042Jy27CMBRE/f+f00UXiFY0xSV1HGHAsa/jBJeXlFYJkBATFsCtKFLXHI2OZjRkbXtFsZ4a2/gWES+I1wdyhywl/5n2F3yQjWcbpVeJNoyfdw36Ex6ON/sOW4/tfz9i++fLlZSRdOPE0AgCamkoei9q8A7BxxeLHYv1G81HbBkL9xmnwxEEt2lDXvEJbmtSRGIhHNCJ6r9mw5A9PVcSash2Kq0hKyVsE9OYfK/tt5D3q5TQmTn6jhRllW/2iV0BqNRaDXruHD7GL1U+Dywubx5DAAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"sqltablenotification\",\n    \"title\": \"sqltablenotification\",\n    \"src\": \"/patrickdesjardins/static/11cd2464fc3bf1aff3a5c6a346b909f3/004a5/sqltablenotification.png\",\n    \"srcSet\": [\"/patrickdesjardins/static/11cd2464fc3bf1aff3a5c6a346b909f3/5a46d/sqltablenotification.png 300w\", \"/patrickdesjardins/static/11cd2464fc3bf1aff3a5c6a346b909f3/004a5/sqltablenotification.png 329w\"],\n    \"sizes\": \"(max-width: 329px) 100vw, 329px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"This is quite interesting for distributed scenario where multiple source can change the value. The SQL Server act as a gateway where reside the information if the data is cached or not.\"), mdx(\"p\", null, \"To conclude, we have seen that we can use the SqlCacheDependencyAdmin to enable the notification and also to create the table. We have seen that we can use the SqlCacheDependency with the cache to synchronize data between the database and the caching system. When the database chance, the cache will be flushed.\"), mdx(\"h2\", null, \"If your notification is not trigged\"), mdx(\"p\", null, \"I suggest that you search for a table called sys.transmission_queue in your database. Your notification should be stored here but was not delivered. The cause can be a lot of thing but you should try to verify if you are allowed to create the table by code which require to be able to use the EXECUTE statement.\"));\n}\n;\nMDXContent.isMDXComponent = true;"}},"pageContext":{"id":"c53e8d9c-5be9-5195-a232-e67e9a6d35f1"}},
    "staticQueryHashes": ["3159585216"]}