3:I[6405,[],""]
5:I[5337,[],""]
6:I[156,["156","static/chunks/156-2b9f703633e98ef7.js","836","static/chunks/836-7e37630a3372363c.js","308","static/chunks/app/blog/%5Bslug%5D/page-2829e3c199d313ca.js"],""]
4:["slug","azure-docker-container-repository-github","d"]
0:["uxaAHTPmWrrayFP1PRPBZ",[[["",{"children":["blog",{"children":[["slug","azure-docker-container-repository-github","d"],{"children":["__PAGE__?{\"slug\":\"azure-docker-container-repository-github\"}",{}]}]}]},"$undefined","$undefined",true],["",{"children":["blog",{"children":[["slug","azure-docker-container-repository-github","d"],{"children":["__PAGE__",{},[["$L1","$L2",[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/be8a59717d6d5849.css","precedence":"next","crossOrigin":"$undefined"}],["$","link","1",{"rel":"stylesheet","href":"/_next/static/css/97e0a79122e618e4.css","precedence":"next","crossOrigin":"$undefined"}]]],null],null]},[null,["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children","$4","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]],null]},[[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/dabd5e64a469b0e1.css","precedence":"next","crossOrigin":"$undefined"}]],["$","div",null,{"className":"layout_blogbodystyle___Uc1w","children":["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined"}]}]],null],null]},[[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/4cb872a2a77e328a.css","precedence":"next","crossOrigin":"$undefined"}]],["$","html",null,{"lang":"en","className":"layout_htmlstyle__PseMz","children":["$","body",null,{"className":"layout_bodystyle__4ncsS","children":["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":["$","div",null,{"style":{"display":"flex","alignItems":"center","justifyContent":"center","height":"100vh"},"children":["$","div",null,{"style":{"width":"50%","height":"20%","backgroundColor":"#ffeded","borderRadius":12,"padding":12,"textAlign":"center"},"children":[["$","h1",null,{"children":"Not Found"}],["$","p",null,{"children":"Could not find requested resource"}],["$","$L6",null,{"href":"/","children":"Return Home"}]]}]}],"notFoundStyles":[]}]}]}]],null],null],["$L7",null]]]]
8:I[836,["156","static/chunks/156-2b9f703633e98ef7.js","836","static/chunks/836-7e37630a3372363c.js","308","static/chunks/app/blog/%5Bslug%5D/page-2829e3c199d313ca.js"],"Image"]
2:["$","div",null,{"className":"BlogBody_BlogBody__600mT","children":[["$","header",null,{"className":"BlogBody_siteTitle__f7uyb","children":"Patrick Desjardins Blog"}],["$","nav",null,{"children":["$","ul",null,{"className":"BlogBody_navLinks__ZV12t","children":["$","li",null,{"className":"BlogBody_navLinkItem__Pml2e","children":[["$","$L6",null,{"className":"BlogBody_navLinkText__ZtH2y","href":"/","children":"Main Page"}],["$","$L6",null,{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog","children":"Blog"}],["$","$L6",null,{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/search","children":"Search"}],[["$","$L6","2026",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2026","children":2026}],["$","$L6","2025",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2025","children":2025}],["$","$L6","2024",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2024","children":2024}],["$","$L6","2023",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2023","children":2023}],["$","$L6","2022",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2022","children":2022}],["$","$L6","2021",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2021","children":2021}],["$","$L6","2020",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2020","children":2020}],["$","$L6","2019",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2019","children":2019}],["$","$L6","2018",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2018","children":2018}],["$","$L6","2017",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2017","children":2017}],["$","$L6","2016",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2016","children":2016}],["$","$L6","2015",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2015","children":2015}],["$","$L6","2014",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2014","children":2014}],["$","$L6","2013",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2013","children":2013}],["$","$L6","2012",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2012","children":2012}],["$","$L6","2011",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2011","children":2011}]]]}]}]}],["$","div",null,{"className":"BlogBody_blogPictureContainer__IAbPL","children":["$","$L8",null,{"className":"BlogBody_blogTopPicture__L6lao","alt":"Patrick Desjardins picture from a conference","src":"/images/backgrounds/patrickdesjardins_conference_bw.webp","width":800,"height":260}]}],["$","main",null,{"className":"BlogBody_main__XrdKY","children":[["$","h1",null,{"className":"BlogBody_heading__bYRBe","children":"How to use Kubernetes with Microsoft Azure and GitHub and how to debug if it does not workout"}],["$","div",null,{"className":"Page_blogPostContainer__AUIcf","children":[["$","p",null,{"className":"Page_blogPostDate__wVWWB","children":["Posted on: ","2022-07-28"]}],[["$","p",null,{"children":"Kubernetes is a convenient way to deploy an infrastructure of services in a central place. Once you have your service Docker images built and deployed you can use Kubernetes to deploy multiple instances across the cloud. In this article, we will see how Microsoft Azure can use a Kubernetes configuration generated with Helm and deploy many images from Azure Registry Container."}],"\n",["$","h1",null,{"children":"Create an Azure Kubernetes Service (AKS)"}],"\n",["$","p",null,{"children":"There are two ways to create a Azure Kubernetes Services: Azure Cli and Azure Portal."}],"\n",["$","h2",null,{"children":"Azure Cli"}],"\n",["$","p",null,{"children":["A few pieces of information is required that were built when we created our Azure Docker Image Repository.\nYou need to use the Azure resource group name after ",["$","code",null,{"children":"--resource-group"}],". The name of the Kubernetes service is after ",["$","code",null,{"children":"--name"}],". The ",["$","code",null,{"children":"--attach-acr"}]," is the name of the Azure Container Registry (acr)."]}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":["$","span",null,{"className":"code-line","children":"az aks create --resource-group realtimepixel_resourcegroup --name realpixelask --location eastus --attach-acr realtimepixel --generate-ssh-keys\n"}]}]}],"\n",["$","p",null,{"children":"There are a few things to know:"}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":"The name cannot have an underscore. Even if you enclose with double quote, it does not work"}],"\n",["$","li",null,{"children":"The command takes a while to run. Expect at least 1 minute."}],"\n"]}],"\n",["$","h2",null,{"children":"Azure Portal"}],"\n",["$","p",null,{"children":["Many online tutorials show the Azure CLI (",["$","code",null,{"children":"az"}]," command), but it is also possible to create the Kubernetes service on the Microsoft Azure Portal."]}],"\n",["$","p",null,{"children":["$","img",null,{"src":"/images/blog/azure_kbs_creation.png","alt":""}]}],"\n",["$","p",null,{"children":"I personally prefer to use a web interface. For creating a Kubernetes cluster, the Azure Portal guides you through several steps, which in my opinion worth doing that step that you will rarely do compared to operation Azure CLI command."}],"\n",["$","h1",null,{"children":"Configure Github Workflow"}],"\n",["$","p",null,{"children":["You can edit the existing Github workflow defined ",["$","a",null,{"href":"./azure-docker-container-repository-github","children":"previously"}]," that was building the image and pushing it into Azure Container Registry (ACR). However, I created a new workflow to manually decide when to push the image into production."]}],"\n",["$","p",null,{"children":["Here is the entire Github workflow that I store in the repository in ",["$","code",null,{"children":".github/workflows/k8sdeploy.yml"}]]}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":[["$","span",null,{"className":"code-line","children":"name: Kubernetes Prod Deployment\n"}],["$","span",null,{"className":"code-line","children":"on:\n"}],["$","span",null,{"className":"code-line","children":"  workflow_dispatch:\n"}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":"# Environment variables available to all jobs and steps in this workflow\n"}],["$","span",null,{"className":"code-line","children":"env:\n"}],["$","span",null,{"className":"code-line","children":"  REGISTRY_NAME: realtimepixel\n"}],["$","span",null,{"className":"code-line","children":"  CLUSTER_NAME: realpixelask2\n"}],["$","span",null,{"className":"code-line","children":"  CLUSTER_RESOURCE_GROUP: realtimepixel_resourcegroup\n"}],["$","span",null,{"className":"code-line","children":"  NAMESPACE: realtimepixel-prod\n"}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":"jobs:\n"}],["$","span",null,{"className":"code-line","children":"  build:\n"}],["$","span",null,{"className":"code-line","children":"    runs-on: ubuntu-latest\n"}],["$","span",null,{"className":"code-line","children":"    steps:\n"}],["$","span",null,{"className":"code-line","children":"      - uses: actions/checkout@main\n"}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":"      # Set the target Azure Kubernetes Service (AKS) cluster.\n"}],["$","span",null,{"className":"code-line","children":"      - uses: azure/aks-set-context@v1\n"}],["$","span",null,{"className":"code-line","children":"        with:\n"}],["$","span",null,{"className":"code-line","children":"          creds: ${{ secrets.AZURE_CREDENTIALS }}\n"}],["$","span",null,{"className":"code-line","children":"          cluster-name: ${{ env.CLUSTER_NAME }}\n"}],["$","span",null,{"className":"code-line","children":"          resource-group: ${{ env.CLUSTER_RESOURCE_GROUP }}\n"}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":"      # Create namespace if doesn't exist\n"}],["$","span",null,{"className":"code-line","children":"      - run: |\n"}],["$","span",null,{"className":"code-line","children":"          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o json | kubectl apply -f -\n"}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":"      - name: Helm tool installer\n"}],["$","span",null,{"className":"code-line","children":"        uses: Azure/setup-helm@v1\n"}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":"      - name: Azure Login\n"}],["$","span",null,{"className":"code-line","children":"        uses: Azure/login@v1.1\n"}],["$","span",null,{"className":"code-line","children":"        with:\n"}],["$","span",null,{"className":"code-line","children":"          creds: ${{ secrets.AZURE_CREDENTIALS }}\n"}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":"      - name: Get Latest Tag Redis\n"}],["$","span",null,{"className":"code-line","children":"        id: latesttagredis\n"}],["$","span",null,{"className":"code-line","children":"        run: |\n"}],["$","span",null,{"className":"code-line","children":"          tag_redis=$(az acr repository show-tags --name ${{env.REGISTRY_NAME}} --repository realtimepixel_redis --top 1 --orderby time_desc -o tsv)\n"}],["$","span",null,{"className":"code-line","children":"          echo \"::set-output name=tag_redis::$tag_redis\"\n"}],["$","span",null,{"className":"code-line","children":"      \n"}],["$","span",null,{"className":"code-line","children":"      - name: Tag Redis\n"}],["$","span",null,{"className":"code-line","children":"        run: echo \"Tag Redis is ${{ steps.latesttagredis.outputs.tag_redis }}\"\n"}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":"      - name: Get Latest Tag Backend\n"}],["$","span",null,{"className":"code-line","children":"        id: latesttagbackend\n"}],["$","span",null,{"className":"code-line","children":"        run: |\n"}],["$","span",null,{"className":"code-line","children":"          tag_backend=$(az acr repository show-tags --name ${{env.REGISTRY_NAME}} --repository realtimepixel_backend --top 1 --orderby time_desc -o tsv)\n"}],["$","span",null,{"className":"code-line","children":"          echo \"::set-output name=tag_backend::$tag_backend\"\n"}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":"      - name: Tag Backend\n"}],["$","span",null,{"className":"code-line","children":"        run: echo \"Tag Backend is ${{ steps.latesttagbackend.outputs.tag_backend }}\"\n"}],["$","span",null,{"className":"code-line","children":"      \n"}],["$","span",null,{"className":"code-line","children":"      - name: Get Latest Tag Frontend\n"}],["$","span",null,{"className":"code-line","children":"        id: latesttagfrontend\n"}],["$","span",null,{"className":"code-line","children":"        run: |\n"}],["$","span",null,{"className":"code-line","children":"          tag_frontend=$(az acr repository show-tags --name ${{env.REGISTRY_NAME}} --repository realtimepixel_frontend --top 1 --orderby time_desc -o tsv)\n"}],["$","span",null,{"className":"code-line","children":"          echo \"::set-output name=tag_frontend::$tag_frontend\"\n"}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":"      - name: Tag Frontend\n"}],["$","span",null,{"className":"code-line","children":"        run: echo \"Tag Frontend is ${{ steps.latesttagfrontend.outputs.tag_frontend }}\"\n"}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":"      - name: Deploy\n"}],["$","span",null,{"className":"code-line","children":"        run: >\n"}],["$","span",null,{"className":"code-line","children":"          helm upgrade realtimepixel ./kubernetes/realtimepixel \n"}],["$","span",null,{"className":"code-line","children":"          --install \n"}],["$","span",null,{"className":"code-line","children":"          --namespace=${{ env.NAMESPACE }} \n"}],["$","span",null,{"className":"code-line","children":"          --set namespace=${{env.NAMESPACE}}\n"}],["$","span",null,{"className":"code-line","children":"          --set image.pullPolicy=Always\n"}],["$","span",null,{"className":"code-line","children":"          --set image.redis.repository=${{env.REGISTRY_NAME}}.azurecr.io/realtimepixel_redis\n"}],["$","span",null,{"className":"code-line","children":"          --set image.redis.tag=${{ steps.latesttagredis.outputs.tag_redis }}\n"}],["$","span",null,{"className":"code-line","children":"          --set image.backend.repository=${{env.REGISTRY_NAME}}.azurecr.io/realtimepixel_backend\n"}],["$","span",null,{"className":"code-line","children":"          --set image.backend.tag=${{ steps.latesttagbackend.outputs.tag_backend }}\n"}],["$","span",null,{"className":"code-line","children":"          --set image.frontend.repository=${{env.REGISTRY_NAME}}.azurecr.io/realtimepixel_frontend\n"}],["$","span",null,{"className":"code-line","children":"          --set image.frontend.tag=${{ steps.latesttagfrontend.outputs.tag_frontend }}\n"}]]}]}],"\n",["$","p",null,{"children":"Here is a description of what is going on:"}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":["\n",["$","p",null,{"children":["The first section, called ",["$","code",null,{"children":"env"}],", is variable that can be used across the workflow. It is a simple way to configure data in a central place for the script. It defined the registry (Azure Container Registry) name, the Kubernetes cluster name created in this blog post, the Azure resource group (previous article), and the Kubernetes namespace."]}],"\n"]}],"\n",["$","li",null,{"children":["\n",["$","p",null,{"children":"The second section connects to AKS: Azure Kubernetes Service"}],"\n"]}],"\n",["$","li",null,{"children":["\n",["$","p",null,{"children":"We create the namespace"}],"\n"]}],"\n",["$","li",null,{"children":["\n",["$","p",null,{"children":"We then connect with Helm and Azure Login. From now, we are ready to perform some commands"}],"\n"]}],"\n",["$","li",null,{"children":["\n",["$","p",null,{"children":"First, we get the latest image tag for each image"}],"\n"]}],"\n",["$","li",null,{"children":["\n",["$","p",null,{"children":["Finally, we use ",["$","strong",null,{"children":"Helm"}]," to install or update the Kubernetes configuration. What is important is to override a lot of values from ",["$","code",null,{"children":"kubernetes\\realtimepixel\\values.yaml"}]," (Helm values file)"]}],"\n"]}],"\n"]}],"\n",["$","h1",null,{"children":"Verification"}],"\n",["$","p",null,{"children":["At this point, the Helm command pushes the instruction to Azure Kubernetes Service. Going in the portal you can see under ",["$","code",null,{"children":"Workloads"}]," the deployment."]}],"\n",["$","p",null,{"children":["$","img",null,{"src":"/images/blog/azure_k8s_workloads.png","alt":""}]}],"\n",["$","p",null,{"children":["Everything should be running as expected! The screenshot shows three orange symbols next to my three deployments because there is an issue with the Kubernetes configuration, which is outside the goal of this post. However, it is still interesting to know that you can drill and see the error reason being: ",["$","code",null,{"children":"ErrImageNeverPull"}],"."]}],"\n",["$","h2",null,{"children":"Debug Azure Kubernetes ErrImageNeverPull"}],"\n",["$","p",null,{"children":"The first steps are to access the reason the image is not pulling. You need to get one of the pods under the deployment that is falling."}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":[["$","span",null,{"className":"code-line","children":"kubectl get pods -n realtimepixel-prod\n"}],["$","span",null,{"className":"code-line","children":"kubectl describe pod redis-deployment-6495cd48cc-fhzjg -n realtimepixel-prod\n"}]]}]}],"\n",["$","p",null,{"children":["The last command gives more information saying the policy is to ",["$","code",null,{"children":"Never"}]]}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":[["$","span",null,{"className":"code-line","children":"Events:\n"}],["$","span",null,{"className":"code-line","children":"Type     Reason             Age                    From               Message\n"}],["$","span",null,{"className":"code-line","children":"----     ------             ----                   ----               -------\n"}],["$","span",null,{"className":"code-line","children":"Normal   Scheduled          59m                    default-scheduler  Successfully assigned realtimepixel-prod/redis-deployment-6495cd48cc-fhzjg to aks-agentpool-28884595-vmss000002\n"}],["$","span",null,{"className":"code-line","children":"Warning  Failed             57m (x12 over 59m)     kubelet            Error: ErrImageNeverPull\n"}],["$","span",null,{"className":"code-line","children":"Warning  ErrImageNeverPull  4m36s (x260 over 59m)  kubelet            Container image \"realtimepixel.azurecr.io/realtimepixel_redis:67dfbf27b868bd0b9e7c77aefafb596f2adb3ca0\" is not present with pull policy of Never\n"}]]}]}],"\n",["$","p",null,{"children":["So, once we know the problem is the ",["$","code",null,{"children":"Never"}],", we can see what is happening between Helm and Azure Kubernetes. Trying to see what is sent to Kubernetes is by using the ",["$","code",null,{"children":"template"}]," command of Helm."]}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":["$","span",null,{"className":"code-line","children":"helm template realtimepixel ./kubernetes/realtimepixel --set namespace=realtimepixel-prod --set image.pullPolicy=Always --set image.redis.repository=realtimepixel.azurecr.io/realtimepixel_redis --set image.redis.tag=123123 --set image.backend.repository=realtimepixel.azurecr.io/realtimepixel_backend --set image.backend.tag=123123 --set image.frontend.repository=realtimepixel.azurecr.io/realtimepixel_frontend --set image.frontend.tag=123123 > temp.yaml\n"}]}]}],"\n",["$","p",null,{"children":["I found a case-sensitive issue with the ",["$","code",null,{"children":"image.pullPolicy"}]," where the ",["$","code",null,{"children":"p"}]," was lowercase and needed to be uppercase."]}],"\n",["$","h2",null,{"children":"How to Debug with Azure Kubernetes Containers"}],"\n",["$","p",null,{"children":["The first issue was out of the way, and a second appeared. This time, the Azure Kubernetes was showing the pods having a ",["$","code",null,{"children":"CrashLoopBackOff"}],".There is a command to get the health of all your pods. In my case, some of them were crashing:"]}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":["$","span",null,{"className":"code-line","children":"kubectl get pods -n realtimepixel-prod\n"}]}]}],"\n",["$","p",null,{"children":"Resulted with:"}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":[["$","span",null,{"className":"code-line","children":"NAME                                   READY   STATUS             RESTARTS         AGE\n"}],["$","span",null,{"className":"code-line","children":"backend-deployment-69c99548d9-g2w5d    0/1     CrashLoopBackOff   10 (3m28s ago)   30m\n"}],["$","span",null,{"className":"code-line","children":"backend-deployment-69c99548d9-wrhzp    0/1     CrashLoopBackOff   10 (3m42s ago)   30m\n"}],["$","span",null,{"className":"code-line","children":"backend-deployment-7dfbc4f7f8-m99kl    0/1     CrashLoopBackOff   10 (3m51s ago)   109m\n"}],["$","span",null,{"className":"code-line","children":"backend-deployment-7dfbc4f7f8-vbp24    0/1     CrashLoopBackOff   10 (4m4s ago)    109m\n"}],["$","span",null,{"className":"code-line","children":"frontend-deployment-6f88fdb587-2p2lk   1/1     Running            0                30m\n"}],["$","span",null,{"className":"code-line","children":"redis-deployment-5d48cc44bd-8w869      1/1     Running            0                30m\n"}]]}]}],"\n",["$","p",null,{"children":"It is possible to see the logs of the deployment:"}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":[["$","span",null,{"className":"code-line","children":"kubectl describe pod backend-deployment-69c99548d9-g2w5d -n realtimepixel-prod\n"}],["$","span",null,{"className":"code-line","children":"kubectl logs backend-deployment-69c99548d9-g2w5d -n realtimepixel-prod\n"}]]}]}],"\n",["$","p",null,{"children":"The output:"}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":[["$","span",null,{"className":"code-line","children":"> start:production\n"}],["$","span",null,{"className":"code-line","children":"> node -r ts-node/register/transpile-only -r tsconfig-paths/register build/backend/src/index.js\n"}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":"Error: Cannot find module '/node/build/backend/src/index.js'\n"}],["$","span",null,{"className":"code-line","children":"    at Function.Module._resolveFilename (node:internal/modules/cjs/loader:933:15)\n"}],["$","span",null,{"className":"code-line","children":"    at Function.Module._resolveFilename.sharedData.moduleResolveFilenameHook.installedValue (/node/node_modules/@cspotcode/source-map-support/source-map-support.js:679:30)\n"}],["$","span",null,{"className":"code-line","children":"    at Function.Module._resolveFilename (/node/node_modules/tsconfig-paths/src/register.ts:90:36)\n"}],["$","span",null,{"className":"code-line","children":"    at Function.Module._load (node:internal/modules/cjs/loader:778:27)\n"}],["$","span",null,{"className":"code-line","children":"    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:77:12)\n"}],["$","span",null,{"className":"code-line","children":"    at node:internal/main/run_main_module:17:47 {\n"}],["$","span",null,{"className":"code-line","children":"  code: 'MODULE_NOT_FOUND',\n"}],["$","span",null,{"className":"code-line","children":"  requireStack: []\n"}],["$","span",null,{"className":"code-line","children":"}\n"}]]}]}],"\n",["$","p",null,{"children":"My instinct was to get into the container."}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":["$","span",null,{"className":"code-line","children":"kubectl exec -it backend-deployment-69c99548d9-g2w5d -n realtimepixel-prod -- sh\n"}]}]}],"\n",["$","p",null,{"children":"But was producing:"}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":["$","span",null,{"className":"code-line","children":" error: unable to upgrade connection: container not found...\n"}]}]}],"\n",["$","p",null,{"children":["The problem is that the issue is on the ",["$","code",null,{"children":"run"}]," command of the container that is failing because the starting file (index.js) is not present. However, because it cannot start the command, the container closes not letting me accessing the container to inspect the folder structures and files."]}],"\n",["$","p",null,{"children":"You can test it by creating a Pod for the problematic image that will not restart using the following commands:"}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":[["$","span",null,{"className":"code-line","children":"kubectl run debug-demo -n realtimepixel-prod --image=realtimepixel.azurecr.io/realtimepixel_backend:67dfbf27b868bd0b9e7c77aefafb596f2adb3ca0 --restart=Never\n"}],["$","span",null,{"className":"code-line","children":"kubectl get pods -n realtimepixel-prod\n"}],["$","span",null,{"className":"code-line","children":"kubectl exec -it debug-demo -n realtimepixel-prod -- sh\n"}]]}]}],"\n",["$","p",null,{"children":"However, the problem will remain that when the Kube Control runs the image that it will crash. However, the log above provides good information. In my case, I realized two things:"}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":["When testing locally, I wasn't testing correctly. The build was passing because I had a ",["$","code",null,{"children":"node_modules"}]," with a dependency that was installed when performing ",["$","code",null,{"children":"npm run install"}]," which was adding all the ",["$","code",null,{"children":"devDependencies"}],". On Github, performing the same command, with the ",["$","code",null,{"children":"NODE_ENV"}]," to ",["$","code",null,{"children":"production"}]," was causing ",["$","code",null,{"children":"npm install"}]," to install only the ",["$","code",null,{"children":"dependencies"}]," without the ",["$","code",null,{"children":"devDependencies"}],"."]}],"\n",["$","li",null,{"children":["I added the ",["$","code",null,{"children":"--target"}]," in the build for the multi-stage. I had the impression that it would start the build with the target, but it is saying that it will be the latest. Oddly, using ",["$","code",null,{"children":"docker-compose"}],", the build step is only the one in the target but using the docker command runs the developer portions and the production."]}],"\n"]}],"\n",["$","h1",null,{"children":"Still Not Working! What to do next?"}],"\n",["$","p",null,{"children":["In my case, it was still not green. Same error about ",["$","code",null,{"children":"CrashLoopBackOff"}]," on the startup of the container. Time to get back locally."]}],"\n",["$","p",null,{"children":["Instead of using ",["$","code",null,{"children":"docker-compose"}],", I decided to mimic what I was doing on the Github workflow."]}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":["$","span",null,{"className":"code-line","children":"docker build -f ./services/backend/Dockerfile --target production --build-arg NODE_ENV=production .\n"}]}]}],"\n",["$","p",null,{"children":"Then get the image built and run it."}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":[["$","span",null,{"className":"code-line","children":"docker images\n"}],["$","span",null,{"className":"code-line","children":"docker run 40d4941a9092\n"}],["$","span",null,{"className":"code-line","children":"docker ps\n"}]]}]}],"\n",["$","p",null,{"children":["Take the ",["$","em",null,{"children":"image id"}]," from the ps command:"]}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":["$","span",null,{"className":"code-line","children":"docker run -it 40d4941a9092 bash\n"}]}]}],"\n",["$","p",null,{"children":"I could see the error, but like Kubernetes, the container shut down. So now, time to make the container crash but to hang it there in an infinite loop:"}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":["$","span",null,{"className":"code-line","children":"docker run 40d4941a9092 /bin/sh -c \"while true; do sleep 2; df -h; done\"\n"}]}]}],"\n",["$","p",null,{"children":"In another terminal window, you can connect."}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":["$","span",null,{"className":"code-line","children":"docker run -it 40d4941a9092 bash\n"}]}]}],"\n",["$","p",null,{"children":"At that point, I saw that the build was messing around with the folders of the output of TypeScript. So I modified the path and was good to go."}],"\n",["$","h1",null,{"children":"Conclusion"}],"\n",["$","p",null,{"children":"At this point, the image was created with a build that was successful."}],"\n",["$","p",null,{"children":["$","img",null,{"src":"/images/blog/azure_kubernetes_deployement.png","alt":""}]}],"\n",["$","p",null,{"children":"I would say that the experience was enriching. However, one question kept getting in the back of my mind: why isn't the Azure Portal guiding me with more than a single keyword for the failure. As we saw, by messing around with commands, we found the root cause, but some support would have been great. Nonetheless, if something happens to you, now you should be equipped to diagnose a little bit better."}],"\n",["$","div",null,{"children":[["$","h2",null,{"children":"Azure Blog Posts: Docker Images & Kubernetes"}],["$","ol",null,{"children":[["$","li",null,{"children":["$","a",null,{"href":"azure-docker-container-repository","children":"How to host Docker images on Microsoft Azure"}]}],["$","li",null,{"children":["$","a",null,{"href":"azure-docker-container-repository-github","children":"How to use Kubernetes with Microsoft Azure and GitHub and how to debug if it does not workout"}]}],["$","li",null,{"children":["$","a",null,{"href":"azure-intro-kubernetes","children":"An Introduction to Microsoft Azure and Kubernetes using Helm and Docker Images"}]}],["$","li",null,{"children":["$","a",null,{"href":"azure-kubernetes-public-access","children":"How to Access your Web Application on Kubernetes Azure"}]}],["$","li",null,{"children":["$","a",null,{"href":"azure-kubernetes-pod-debug-crash","children":"How to Debug a Kubernetes Pod that Crash at Startup (works on Microsoft Azure Kubernetes)?"}]}],["$","li",null,{"children":["$","a",null,{"href":"helpchart-introduction","children":"How to use Helm Chart to configure dynamically your Kubernetes file for beginner?"}]}]]}]]}]]]}]]}],["$","div",null,{"className":"BlogBody_paginationBar__1gsMc","children":[["$","div",null,{"className":"BlogBody_paginationTitle__H_eFX","children":"Chronological Blog Articles by Page"}],["$","div",null,{"className":"BlogBody_paginationLinks__nk8zd","children":[["$","$L6","1",{"className":"","href":"/blog/page/1","children":1}],["$","$L6","2",{"className":"","href":"/blog/page/2","children":2}],["$","$L6","3",{"className":"","href":"/blog/page/3","children":3}],["$","$L6","4",{"className":"","href":"/blog/page/4","children":4}],["$","$L6","5",{"className":"","href":"/blog/page/5","children":5}],["$","$L6","6",{"className":"","href":"/blog/page/6","children":6}],["$","$L6","7",{"className":"","href":"/blog/page/7","children":7}],["$","$L6","8",{"className":"","href":"/blog/page/8","children":8}],["$","$L6","9",{"className":"","href":"/blog/page/9","children":9}],["$","$L6","10",{"className":"","href":"/blog/page/10","children":10}],["$","$L6","11",{"className":"","href":"/blog/page/11","children":11}],["$","$L6","12",{"className":"","href":"/blog/page/12","children":12}],["$","$L6","13",{"className":"","href":"/blog/page/13","children":13}],["$","$L6","14",{"className":"","href":"/blog/page/14","children":14}],["$","$L6","15",{"className":"","href":"/blog/page/15","children":15}],["$","$L6","16",{"className":"","href":"/blog/page/16","children":16}],["$","$L6","17",{"className":"","href":"/blog/page/17","children":17}],["$","$L6","18",{"className":"","href":"/blog/page/18","children":18}],["$","$L6","19",{"className":"","href":"/blog/page/19","children":19}],["$","$L6","20",{"className":"","href":"/blog/page/20","children":20}],["$","$L6","21",{"className":"","href":"/blog/page/21","children":21}],["$","$L6","22",{"className":"","href":"/blog/page/22","children":22}],["$","$L6","23",{"className":"","href":"/blog/page/23","children":23}],["$","$L6","24",{"className":"","href":"/blog/page/24","children":24}],["$","$L6","25",{"className":"","href":"/blog/page/25","children":25}],["$","$L6","26",{"className":"","href":"/blog/page/26","children":26}],["$","$L6","27",{"className":"","href":"/blog/page/27","children":27}],["$","$L6","28",{"className":"","href":"/blog/page/28","children":28}],["$","$L6","29",{"className":"","href":"/blog/page/29","children":29}],["$","$L6","30",{"className":"","href":"/blog/page/30","children":30}],["$","$L6","31",{"className":"","href":"/blog/page/31","children":31}],["$","$L6","32",{"className":"","href":"/blog/page/32","children":32}],["$","$L6","33",{"className":"","href":"/blog/page/33","children":33}],["$","$L6","34",{"className":"","href":"/blog/page/34","children":34}],["$","$L6","35",{"className":"","href":"/blog/page/35","children":35}],["$","$L6","36",{"className":"","href":"/blog/page/36","children":36}],["$","$L6","37",{"className":"","href":"/blog/page/37","children":37}],["$","$L6","38",{"className":"","href":"/blog/page/38","children":38}],["$","$L6","39",{"className":"","href":"/blog/page/39","children":39}],["$","$L6","40",{"className":"","href":"/blog/page/40","children":40}],["$","$L6","41",{"className":"","href":"/blog/page/41","children":41}],["$","$L6","42",{"className":"","href":"/blog/page/42","children":42}],["$","$L6","43",{"className":"","href":"/blog/page/43","children":43}],["$","$L6","44",{"className":"","href":"/blog/page/44","children":44}],["$","$L6","45",{"className":"","href":"/blog/page/45","children":45}],["$","$L6","46",{"className":"","href":"/blog/page/46","children":46}],["$","$L6","47",{"className":"","href":"/blog/page/47","children":47}],["$","$L6","48",{"className":"","href":"/blog/page/48","children":48}],["$","$L6","49",{"className":"","href":"/blog/page/49","children":49}],["$","$L6","50",{"className":"","href":"/blog/page/50","children":50}],["$","$L6","51",{"className":"","href":"/blog/page/51","children":51}],["$","$L6","52",{"className":"","href":"/blog/page/52","children":52}],["$","$L6","53",{"className":"","href":"/blog/page/53","children":53}],["$","$L6","54",{"className":"","href":"/blog/page/54","children":54}],["$","$L6","55",{"className":"","href":"/blog/page/55","children":55}],["$","$L6","56",{"className":"","href":"/blog/page/56","children":56}],["$","$L6","57",{"className":"","href":"/blog/page/57","children":57}],["$","$L6","58",{"className":"","href":"/blog/page/58","children":58}],["$","$L6","59",{"className":"","href":"/blog/page/59","children":59}],["$","$L6","60",{"className":"","href":"/blog/page/60","children":60}],["$","$L6","61",{"className":"","href":"/blog/page/61","children":61}],["$","$L6","62",{"className":"","href":"/blog/page/62","children":62}],["$","$L6","63",{"className":"","href":"/blog/page/63","children":63}],["$","$L6","64",{"className":"","href":"/blog/page/64","children":64}],["$","$L6","65",{"className":"","href":"/blog/page/65","children":65}],["$","$L6","66",{"className":"","href":"/blog/page/66","children":66}],["$","$L6","67",{"className":"","href":"/blog/page/67","children":67}],["$","$L6","68",{"className":"","href":"/blog/page/68","children":68}],["$","$L6","69",{"className":"","href":"/blog/page/69","children":69}],["$","$L6","70",{"className":"","href":"/blog/page/70","children":70}],["$","$L6","71",{"className":"","href":"/blog/page/71","children":71}],["$","$L6","72",{"className":"","href":"/blog/page/72","children":72}],["$","$L6","73",{"className":"","href":"/blog/page/73","children":73}],["$","$L6","74",{"className":"","href":"/blog/page/74","children":74}],["$","$L6","75",{"className":"","href":"/blog/page/75","children":75}],["$","$L6","76",{"className":"","href":"/blog/page/76","children":76}],["$","$L6","77",{"className":"","href":"/blog/page/77","children":77}],["$","$L6","78",{"className":"","href":"/blog/page/78","children":78}],["$","$L6","79",{"className":"","href":"/blog/page/79","children":79}],["$","$L6","80",{"className":"","href":"/blog/page/80","children":80}],["$","$L6","81",{"className":"","href":"/blog/page/81","children":81}]]}]]}],null]}]
7:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"charSet":"utf-8"}],["$","title","2",{"children":"Patrick Desjardins Blog - How to use Kubernetes with Microsoft Azure and GitHub and how to debug if it does not workout"}],["$","meta","3",{"name":"description","content":"How to use Kubernetes with Microsoft Azure and GitHub and how to debug if it does not workout"}]]
1:null
