3:I[9275,[],""]
5:I[1343,[],""]
6:I[231,["231","static/chunks/231-d291986acc57095e.js","173","static/chunks/173-1ff9408fc5d1e856.js","308","static/chunks/app/blog/%5Bslug%5D/page-b7aa7f195c3b21e3.js"],""]
4:["slug","how-to-build-nodejs-with-openssl","d"]
0:["-ebut_SCJdCDKpkR_XmE0",[[["",{"children":["blog",{"children":[["slug","how-to-build-nodejs-with-openssl","d"],{"children":["__PAGE__?{\"slug\":\"how-to-build-nodejs-with-openssl\"}",{}]}]}]},"$undefined","$undefined",true],["",{"children":["blog",{"children":[["slug","how-to-build-nodejs-with-openssl","d"],{"children":["__PAGE__",{},[["$L1","$L2"],null],null]},["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children","$4","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/585ef9e6d39b193c.css","precedence":"next","crossOrigin":"$undefined"}]]}],null]},[["$","div",null,{"className":"layout_bodystyle__9TFhb","children":["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":null}]}],null],null]},[["$","html",null,{"lang":"en","children":["$","body",null,{"className":"layout_bodystyle__4ncsS","children":["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":["$","div",null,{"style":{"display":"flex","alignItems":"center","justifyContent":"center","height":"100vh"},"children":["$","div",null,{"style":{"width":"50%","height":"20%","backgroundColor":"#ffeded","borderRadius":12,"padding":12,"textAlign":"center"},"children":[["$","h1",null,{"children":"Not Found"}],["$","p",null,{"children":"Could not find requested resource"}],["$","$L6",null,{"href":"/","children":"Return Home"}]]}]}],"notFoundStyles":[],"styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/378d2a9747ade719.css","precedence":"next","crossOrigin":"$undefined"}]]}]}]}],null],null],[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/53d73aaa6ce0fadc.css","precedence":"next","crossOrigin":"$undefined"}]],"$L7"]]]]
8:I[8173,["231","static/chunks/231-d291986acc57095e.js","173","static/chunks/173-1ff9408fc5d1e856.js","308","static/chunks/app/blog/%5Bslug%5D/page-b7aa7f195c3b21e3.js"],"Image"]
2:["$","div",null,{"className":"BlogBody_BlogBody__600mT","children":[["$","header",null,{"className":"BlogBody_siteTitle__f7uyb","children":"Patrick Desjardins Blog"}],["$","nav",null,{"children":["$","ul",null,{"className":"BlogBody_navLinks__ZV12t","children":["$","li",null,{"className":"BlogBody_navLinkItem__Pml2e","children":[["$","$L6",null,{"className":"BlogBody_navLinkText__ZtH2y","href":"/","children":"Main Page"}],["$","$L6",null,{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog","children":"Blog"}],[["$","$L6","2024",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2024","children":2024}],["$","$L6","2023",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2023","children":2023}],["$","$L6","2022",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2022","children":2022}],["$","$L6","2021",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2021","children":2021}],["$","$L6","2020",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2020","children":2020}],["$","$L6","2019",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2019","children":2019}],["$","$L6","2018",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2018","children":2018}],["$","$L6","2017",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2017","children":2017}],["$","$L6","2016",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2016","children":2016}],["$","$L6","2015",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2015","children":2015}],["$","$L6","2014",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2014","children":2014}],["$","$L6","2013",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2013","children":2013}],["$","$L6","2012",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2012","children":2012}],["$","$L6","2011",{"className":"BlogBody_navLinkText__ZtH2y","href":"/blog/for/2011","children":2011}]]]}]}]}],["$","div",null,{"className":"BlogBody_blogPictureContainer__IAbPL","children":["$","$L8",null,{"className":"BlogBody_blogTopPicture__L6lao","alt":"Patrick Desjardins picture from a conference","src":"/images/backgrounds/patrickdesjardins_conference_bw.jpeg","width":800,"height":260}]}],["$","main",null,{"className":"BlogBody_main__XrdKY","children":[["$","h1",null,{"className":"BlogBody_heading__bYRBe","children":"How to Build NodeJS with OpenSSL?"}],["$","div",null,{"className":"Page_blogPostContainer__AUIcf","children":[["$","p",null,{"className":"Page_blogPostDate__wVWWB","children":["Posted on: ","2023-08-15"]}],[["$","p",null,{"children":"Once in a while, your work environment could be more optimal for what you try to achieve. The current situation was that I had to use a MacOS with LibreSSL under a supervised man-in-the-middle security loop that mangled the SSL certificates. The network had changed, and using Microsoft Identity Client (MSAL) started to fail on renegotiation. I had little power because I had no exposure, no privilege to change the trickiness of the certificates."}],"\n",["$","p",null,{"children":"The quick solution was to fall back to Node 14, which was built (the binary) in a way that it was still working. The three years old version of Node does not use the newest OpenSSL libs that support RFC5764 and is compatible with the environment I am developing. However, the production version of Node worked fine with the latest LTS (18+). The described solution explains how to build your version of Node on your machine using a specific OpenSSL version and then use NVM to use the binary without renegotiation problems."}],"\n",["$","h1",null,{"children":"The Problem"}],"\n",["$","p",null,{"children":"Upon network and security changes, the communication using MSAL started to fail with the following error:"}],"\n",["$","pre",null,{"className":"language-sh","children":["$","code",null,{"className":"language-sh code-highlight","children":["$","span",null,{"className":"code-line","children":["error ",["$","span",null,{"className":"token keyword","children":"in"}]," secret or public key callback: ",["$","span",null,{"className":"token function","children":"write"}]," EPROTO ",["$","span",null,{"className":"token punctuation","children":".."}],["$","span",null,{"className":"token punctuation","children":".."}],["$","span",null,{"className":"token punctuation","children":".."}],["$","span",null,{"className":"token punctuation","children":".."}],". routines:final_renegotiate:unsafe legacy renegociation disabled.\n"]}]}]}],"\n",["$","p",null,{"children":["The error might sound that changing some switches on Node, like adding the ",["$","code",null,{"children":"--tls-max=v1.2"}]," or ",["$","code",null,{"children":"--openssl-config"}]," with a configuration file, fix the issue, but in my case, it wasn't. The main culprit is my MacOS is configured to use ",["$","code",null,{"children":"LibreSSL"}],". Other tentative using ",["$","code",null,{"children":"HTTPS"}]," ",["$","code",null,{"children":"secureOptions"}]," with ",["$","code",null,{"children":"SSL_OP_ALLOW_UNSAFE_LEGECY_RENEGOTIATION"}]," does not work. The problem is around OpenSSL."]}],"\n",["$","h1",null,{"children":"The Solution: Building NodeJS with OpenSSL"}],"\n",["$","p",null,{"children":"The current environment is rigorous and only allows a little change. However, using Homebrew, we can install OpenSSL. That is the first step that allows us to get OpenSSL instead of LibreSSL."}],"\n",["$","pre",null,{"className":"language-sh","children":["$","code",null,{"className":"language-sh code-highlight","children":["$","span",null,{"className":"code-line","children":["brew ",["$","span",null,{"className":"token function","children":"install"}]," openssl@1.1\n"]}]}]}],"\n",["$","p",null,{"children":["Then, the idea is to get NodeJS source code, and build the code to have a binary that uses the insalled ",["$","code",null,{"children":"openssel@1.1"}],"."]}],"\n",["$","p",null,{"children":"Getting the source code is a single GIT command. Then, you need to target the tag of the version you desire. In my case, I wanted to run version 18.17."}],"\n",["$","pre",null,{"className":"language-sh","children":["$","code",null,{"className":"language-sh code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token function","children":"git"}]," clone https://github.com/nodejs/node.git\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token function","children":"git"}]," checkout v18.17.0\n"]}]]}]}],"\n",["$","p",null,{"children":"Then you need to export a few flags that will tell the C++ compiler to use the OpenSSL library during compilation:"}],"\n",["$","pre",null,{"className":"language-sh","children":["$","code",null,{"className":"language-sh code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token builtin class-name","children":"export"}]," ",["$","span",null,{"className":"token assign-left variable","children":"LDFLAGS"}],["$","span",null,{"className":"token operator","children":"="}],["$","span",null,{"className":"token string","children":"\"-L/opt/homebrew/opt/openssl@1.1/lib\""}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token builtin class-name","children":"export"}]," ",["$","span",null,{"className":"token assign-left variable","children":"CPPFLAGS"}],["$","span",null,{"className":"token operator","children":"="}],["$","span",null,{"className":"token string","children":"\"-I/opt/homebrew/opt/openssl@1.1/include\""}],"\n"]}]]}]}],"\n",["$","p",null,{"children":"Before building, you need to call a Python script to configure OpenSSL. The script is in the source code."}],"\n",["$","pre",null,{"className":"language-sh","children":["$","code",null,{"className":"language-sh code-highlight","children":["$","span",null,{"className":"code-line","children":"./configure --shared-openssl\n"}]}]}],"\n",["$","p",null,{"children":"Finally, time to build. This step is time-consuming. In my case, it takes about 1 hour."}],"\n",["$","pre",null,{"className":"language-plaintext","children":["$","code",null,{"className":"language-plaintext code-highlight","children":["$","span",null,{"className":"code-line","children":"make -j4\n"}]}]}],"\n",["$","p",null,{"children":["The ",["$","code",null,{"children":"j4"}]," switch allows a performance boost using a parallelist build."]}],"\n",["$","h1",null,{"children":"Using the Binary"}],"\n",["$","p",null,{"children":["Once the build is completed, you can try the binary using ",["$","code",null,{"children":"./out/release/node -v"}],". That should output the version you used, in my case 18.17."]}],"\n",["$","p",null,{"children":"However, the binary is still inside the folder that you compiled Node. There are many options. You can create a symbolic link to the binary. However, I was already using NVM. NVM enable switching between different NodeJS version. Handy if you work on many projects. The solution I found is hacky but works well."}],"\n",["$","p",null,{"children":"First, install the official version into your project (not the NodeJS source code project)."}],"\n",["$","pre",null,{"className":"language-sh","children":["$","code",null,{"className":"language-sh code-highlight","children":[["$","span",null,{"className":"code-line","children":["nvm ",["$","span",null,{"className":"token function","children":"install"}]," v18.17.0\n"]}],["$","span",null,{"className":"code-line","children":"nvm use v18.17.0\n"}]]}]}],"\n",["$","p",null,{"children":["That will download into your ",["$","code",null,{"children":"~/.nvm/versions/node"}]," folder, a cache version of the official version. The folder of the version contains more than just Node. It includes NPM and other libraries."]}],"\n",["$","p",null,{"children":"Then, copy the binary to overwrite the one in the cache:"}],"\n",["$","pre",null,{"className":"language-sh","children":["$","code",null,{"className":"language-sh code-highlight","children":["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token function","children":"cp"}]," ./out/Release/node /Users/pdesjardins/.nvm/versions/node/v18.17.0/bin/node\n"]}]}]}],"\n",["$","p",null,{"children":["Then, anytime you use ",["$","code",null,{"children":"nvm use"}]," on version 18.17.0, regardless of where on your machine, it will use the binary you compiled."]}],"\n",["$","h1",null,{"children":"Conclusion"}],"\n",["$","p",null,{"children":"The problem and the solution could be better. It would be better if the environment would support natively renegotiation and other newest features. However, sometimes, what is the best is not available. Thus, the workaround of compiling the system using the needed SSL library with the convenience of a development tool like NVM is good enough to unblock the development."}]]]}]]}],["$","div",null,{"className":"BlogBody_paginationBar__1gsMc","children":[["$","div",null,{"className":"BlogBody_paginationTitle__H_eFX","children":"Chronological Blog Articles by Page"}],["$","div",null,{"className":"BlogBody_paginationLinks__nk8zd","children":[["$","$L6","1",{"className":"","href":"/blog/page/1","children":1}],["$","$L6","2",{"className":"","href":"/blog/page/2","children":2}],["$","$L6","3",{"className":"","href":"/blog/page/3","children":3}],["$","$L6","4",{"className":"","href":"/blog/page/4","children":4}],["$","$L6","5",{"className":"","href":"/blog/page/5","children":5}],["$","$L6","6",{"className":"","href":"/blog/page/6","children":6}],["$","$L6","7",{"className":"","href":"/blog/page/7","children":7}],["$","$L6","8",{"className":"","href":"/blog/page/8","children":8}],["$","$L6","9",{"className":"","href":"/blog/page/9","children":9}],["$","$L6","10",{"className":"","href":"/blog/page/10","children":10}],["$","$L6","11",{"className":"","href":"/blog/page/11","children":11}],["$","$L6","12",{"className":"","href":"/blog/page/12","children":12}],["$","$L6","13",{"className":"","href":"/blog/page/13","children":13}],["$","$L6","14",{"className":"","href":"/blog/page/14","children":14}],["$","$L6","15",{"className":"","href":"/blog/page/15","children":15}],["$","$L6","16",{"className":"","href":"/blog/page/16","children":16}],["$","$L6","17",{"className":"","href":"/blog/page/17","children":17}],["$","$L6","18",{"className":"","href":"/blog/page/18","children":18}],["$","$L6","19",{"className":"","href":"/blog/page/19","children":19}],["$","$L6","20",{"className":"","href":"/blog/page/20","children":20}],["$","$L6","21",{"className":"","href":"/blog/page/21","children":21}],["$","$L6","22",{"className":"","href":"/blog/page/22","children":22}],["$","$L6","23",{"className":"","href":"/blog/page/23","children":23}],["$","$L6","24",{"className":"","href":"/blog/page/24","children":24}],["$","$L6","25",{"className":"","href":"/blog/page/25","children":25}],["$","$L6","26",{"className":"","href":"/blog/page/26","children":26}],["$","$L6","27",{"className":"","href":"/blog/page/27","children":27}],["$","$L6","28",{"className":"","href":"/blog/page/28","children":28}],["$","$L6","29",{"className":"","href":"/blog/page/29","children":29}],["$","$L6","30",{"className":"","href":"/blog/page/30","children":30}],["$","$L6","31",{"className":"","href":"/blog/page/31","children":31}],["$","$L6","32",{"className":"","href":"/blog/page/32","children":32}],["$","$L6","33",{"className":"","href":"/blog/page/33","children":33}],["$","$L6","34",{"className":"","href":"/blog/page/34","children":34}],["$","$L6","35",{"className":"","href":"/blog/page/35","children":35}],["$","$L6","36",{"className":"","href":"/blog/page/36","children":36}],["$","$L6","37",{"className":"","href":"/blog/page/37","children":37}],["$","$L6","38",{"className":"","href":"/blog/page/38","children":38}],["$","$L6","39",{"className":"","href":"/blog/page/39","children":39}],["$","$L6","40",{"className":"","href":"/blog/page/40","children":40}],["$","$L6","41",{"className":"","href":"/blog/page/41","children":41}],["$","$L6","42",{"className":"","href":"/blog/page/42","children":42}],["$","$L6","43",{"className":"","href":"/blog/page/43","children":43}],["$","$L6","44",{"className":"","href":"/blog/page/44","children":44}],["$","$L6","45",{"className":"","href":"/blog/page/45","children":45}],["$","$L6","46",{"className":"","href":"/blog/page/46","children":46}],["$","$L6","47",{"className":"","href":"/blog/page/47","children":47}],["$","$L6","48",{"className":"","href":"/blog/page/48","children":48}],["$","$L6","49",{"className":"","href":"/blog/page/49","children":49}],["$","$L6","50",{"className":"","href":"/blog/page/50","children":50}],["$","$L6","51",{"className":"","href":"/blog/page/51","children":51}],["$","$L6","52",{"className":"","href":"/blog/page/52","children":52}],["$","$L6","53",{"className":"","href":"/blog/page/53","children":53}],["$","$L6","54",{"className":"","href":"/blog/page/54","children":54}],["$","$L6","55",{"className":"","href":"/blog/page/55","children":55}],["$","$L6","56",{"className":"","href":"/blog/page/56","children":56}],["$","$L6","57",{"className":"","href":"/blog/page/57","children":57}],["$","$L6","58",{"className":"","href":"/blog/page/58","children":58}],["$","$L6","59",{"className":"","href":"/blog/page/59","children":59}],["$","$L6","60",{"className":"","href":"/blog/page/60","children":60}],["$","$L6","61",{"className":"","href":"/blog/page/61","children":61}],["$","$L6","62",{"className":"","href":"/blog/page/62","children":62}],["$","$L6","63",{"className":"","href":"/blog/page/63","children":63}],["$","$L6","64",{"className":"","href":"/blog/page/64","children":64}],["$","$L6","65",{"className":"","href":"/blog/page/65","children":65}],["$","$L6","66",{"className":"","href":"/blog/page/66","children":66}],["$","$L6","67",{"className":"","href":"/blog/page/67","children":67}],["$","$L6","68",{"className":"","href":"/blog/page/68","children":68}],["$","$L6","69",{"className":"","href":"/blog/page/69","children":69}],["$","$L6","70",{"className":"","href":"/blog/page/70","children":70}],["$","$L6","71",{"className":"","href":"/blog/page/71","children":71}],["$","$L6","72",{"className":"","href":"/blog/page/72","children":72}],["$","$L6","73",{"className":"","href":"/blog/page/73","children":73}],["$","$L6","74",{"className":"","href":"/blog/page/74","children":74}],["$","$L6","75",{"className":"","href":"/blog/page/75","children":75}],["$","$L6","76",{"className":"","href":"/blog/page/76","children":76}],["$","$L6","77",{"className":"","href":"/blog/page/77","children":77}],["$","$L6","78",{"className":"","href":"/blog/page/78","children":78}]]}]]}]]}]
7:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"charSet":"utf-8"}],["$","title","2",{"children":"Patrick Desjardins Blog - How to Build NodeJS with OpenSSL?"}],["$","meta","3",{"name":"description","content":"How to Build NodeJS with OpenSSL?"}]]
1:null
