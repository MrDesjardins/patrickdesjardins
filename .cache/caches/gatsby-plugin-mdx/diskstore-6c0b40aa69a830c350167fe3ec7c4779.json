{"expireTime":9007200886478383000,"key":"gatsby-plugin-mdx-entire-payload-41654067e87811264af2570226af3c65--undefined","val":{"mdast":{"type":"root","children":[{"type":"paragraph","children":[{"type":"text","value":"Browsers involve very rapidly and since few years it's possible to write JavaScript that runs in the background of the browser. That means that it's possible to run code even if the user is not on the website. This is useful for many scenarios and today we will see one feature which is the ","position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":292,"offset":292},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"push notification","position":{"start":{"line":2,"column":294,"offset":294},"end":{"line":2,"column":311,"offset":311},"indent":[]}}],"position":{"start":{"line":2,"column":292,"offset":292},"end":{"line":2,"column":313,"offset":313},"indent":[]}},{"type":"text","value":". The particular environment that we will describe is to use a service worker that wait a message from a Asp.Net Azure web job written in C# that will push a message at a particular time depending of some value to a specific user. The end result will be that the browser will popup a message box at the bottom right if the user is not on the website or if the user is on the website will display a HTML notification directly on the page.","position":{"start":{"line":2,"column":313,"offset":313},"end":{"line":2,"column":750,"offset":750},"indent":[]}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":750,"offset":750},"indent":[]}},{"type":"paragraph","children":[{"type":"image","title":null,"url":"images/NotificationChromeWebPush.png","alt":null,"position":{"start":{"line":4,"column":1,"offset":752},"end":{"line":4,"column":42,"offset":793},"indent":[]}}],"position":{"start":{"line":4,"column":1,"offset":752},"end":{"line":4,"column":42,"offset":793},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"This article is the part one of two which concentrates on the front-end, not the C# code that runs on the server. We will cover the registration of ","position":{"start":{"line":6,"column":1,"offset":795},"end":{"line":6,"column":149,"offset":943},"indent":[]}},{"type":"link","title":null,"url":"https://firebase.google.com/","children":[{"type":"text","value":"Google Firebase","position":{"start":{"line":6,"column":150,"offset":944},"end":{"line":6,"column":165,"offset":959},"indent":[]}}],"position":{"start":{"line":6,"column":149,"offset":943},"end":{"line":6,"column":196,"offset":990},"indent":[]}},{"type":"text","value":", the service worker's code and the JavaScript code to add on your website.","position":{"start":{"line":6,"column":196,"offset":990},"end":{"line":6,"column":271,"offset":1065},"indent":[]}}],"position":{"start":{"line":6,"column":1,"offset":795},"end":{"line":6,"column":271,"offset":1065},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"The first step if to register an account with Google Firebase. This is not very obvious since almost all example on the web (at this date) uses the raw Service Worker + Push Notification API with the legacy Google system instead of Firebase. Both are pretty compatible in term of server contracts to generate the message, however, on the client side, it's pretty different. Firebase acts as a wrapper on the native Service Worker API and Push Notification API. You can still use the API directly, and in some case, it's the only way to access advanced feature.","position":{"start":{"line":8,"column":1,"offset":1067},"end":{"line":8,"column":561,"offset":1627},"indent":[]}}],"position":{"start":{"line":8,"column":1,"offset":1067},"end":{"line":8,"column":561,"offset":1627},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"To create a Firebase account, you need to ","position":{"start":{"line":10,"column":1,"offset":1629},"end":{"line":10,"column":43,"offset":1671},"indent":[]}},{"type":"link","title":null,"url":"https://console.firebase.google.com","children":[{"type":"text","value":"https://console.firebase.google.com","position":{"start":{"line":10,"column":43,"offset":1671},"end":{"line":10,"column":78,"offset":1706},"indent":[]}}],"position":{"start":{"line":10,"column":43,"offset":1671},"end":{"line":10,"column":78,"offset":1706},"indent":[]}},{"type":"text","value":" and create an account and a project. ","position":{"start":{"line":10,"column":78,"offset":1706},"end":{"line":10,"column":116,"offset":1744},"indent":[]}},{"type":"image","title":null,"url":"images/CreateFirebaseProject-1024x736.png","alt":null,"position":{"start":{"line":10,"column":116,"offset":1744},"end":{"line":10,"column":162,"offset":1790},"indent":[]}}],"position":{"start":{"line":10,"column":1,"offset":1629},"end":{"line":10,"column":162,"offset":1790},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Firebase is a library that is accessible via API keys and JavaScript API. You can also invoke the API through a Rest API which we will see in the second part. The first challenge is to figure out where to get the right API key because the system has many. The first step is to create the Service Worker. This is registered when the user goes into your website to run in the background of the browser. The default is to create a file called \"firebase-messaging-sw.js\" and to put that file at the root of your website. The location of the file is important because the service worker can only access assert that are sibling or child to the script registered.","position":{"start":{"line":12,"column":1,"offset":1792},"end":{"line":12,"column":657,"offset":2448},"indent":[]}}],"position":{"start":{"line":12,"column":1,"offset":1792},"end":{"line":12,"column":657,"offset":2448},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Here is the full code that I have for my Service Worker:","position":{"start":{"line":14,"column":1,"offset":2450},"end":{"line":14,"column":57,"offset":2506},"indent":[]}}],"position":{"start":{"line":14,"column":1,"offset":2450},"end":{"line":14,"column":57,"offset":2506},"indent":[]}},{"type":"code","lang":"typescript","meta":null,"value":"importScripts(\"https://www.gstatic.com/firebasejs/3.5.0/firebase-app.js\");\nimportScripts(\"https://www.gstatic.com/firebasejs/3.5.0/firebase-messaging.js\");\n\nvar config = {\n  apiKey: \"AIzaSyDe0Z0NtygDUDySNMRtl2MIV5m4Hp7IAm0\",\n  authDomain: \"bourse-virtuelle.firebaseapp.com\",\n  messagingSenderId: \"555061918002\",\n};\nfirebase.initializeApp(config);\n\nvar messaging = firebase.messaging();\nmessaging.setBackgroundMessageHandler(function (payload) {\n  var dataFromServer = JSON.parse(payload.data.notification);\n  var notificationTitle = dataFromServer.title;\n  var notificationOptions = {\n    body: dataFromServer.body,\n    icon: dataFromServer.icon,\n    data: { url: dataFromServer.url },\n  };\n  return self.registration.showNotification(\n    notificationTitle,\n    notificationOptions\n  );\n});\n\nself.addEventListener(\"notificationclick\", function (event) {\n  var urlToRedirect = event.notification.data.url;\n  event.notification.close();\n  event.waitUntil(self.clients.openWindow(urlToRedirect));\n});","position":{"start":{"line":16,"column":1,"offset":2508},"end":{"line":47,"column":4,"offset":3524},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"In short, it uses 2 Firebase scripts. One for the Firebase and one for the messaging which is the wrapper around the push notification api. The configuration is tricky. The apiKey is taken from the Firebase's console, under the desired project, under the project settings gear, in the ","position":{"start":{"line":49,"column":1,"offset":3526},"end":{"line":49,"column":286,"offset":3811},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"General","position":{"start":{"line":49,"column":288,"offset":3813},"end":{"line":49,"column":295,"offset":3820},"indent":[]}}],"position":{"start":{"line":49,"column":286,"offset":3811},"end":{"line":49,"column":297,"offset":3822},"indent":[]}},{"type":"text","value":"tab. ","position":{"start":{"line":49,"column":297,"offset":3822},"end":{"line":49,"column":302,"offset":3827},"indent":[]}},{"type":"image","title":null,"url":"images/WebApiKeyForFirebase-1024x572.png","alt":null,"position":{"start":{"line":49,"column":302,"offset":3827},"end":{"line":49,"column":347,"offset":3872},"indent":[]}}],"position":{"start":{"line":49,"column":1,"offset":3526},"end":{"line":49,"column":347,"offset":3872},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"The ","position":{"start":{"line":51,"column":1,"offset":3874},"end":{"line":51,"column":5,"offset":3878},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"messagingSenderId","position":{"start":{"line":51,"column":7,"offset":3880},"end":{"line":51,"column":24,"offset":3897},"indent":[]}}],"position":{"start":{"line":51,"column":5,"offset":3878},"end":{"line":51,"column":26,"offset":3899},"indent":[]}},{"type":"text","value":" is an id that is available tab next to the ","position":{"start":{"line":51,"column":26,"offset":3899},"end":{"line":51,"column":70,"offset":3943},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"General","position":{"start":{"line":51,"column":72,"offset":3945},"end":{"line":51,"column":79,"offset":3952},"indent":[]}}],"position":{"start":{"line":51,"column":70,"offset":3943},"end":{"line":51,"column":81,"offset":3954},"indent":[]}},{"type":"text","value":" tab, called ","position":{"start":{"line":51,"column":81,"offset":3954},"end":{"line":51,"column":94,"offset":3967},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"Cloud Messaging","position":{"start":{"line":51,"column":96,"offset":3969},"end":{"line":51,"column":111,"offset":3984},"indent":[]}}],"position":{"start":{"line":51,"column":94,"offset":3967},"end":{"line":51,"column":113,"offset":3986},"indent":[]}},{"type":"text","value":".","position":{"start":{"line":51,"column":113,"offset":3986},"end":{"line":51,"column":114,"offset":3987},"indent":[]}}],"position":{"start":{"line":51,"column":1,"offset":3874},"end":{"line":51,"column":114,"offset":3987},"indent":[]}},{"type":"paragraph","children":[{"type":"image","title":null,"url":"images/SenderId-1024x505.png","alt":null,"position":{"start":{"line":53,"column":1,"offset":3989},"end":{"line":53,"column":34,"offset":4022},"indent":[]}}],"position":{"start":{"line":53,"column":1,"offset":3989},"end":{"line":53,"column":34,"offset":4022},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"The initialize command will connect the service worker to the server to listen to new messages. The ","position":{"start":{"line":55,"column":1,"offset":4024},"end":{"line":55,"column":101,"offset":4124},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"setBackgroundMessageHandler","position":{"start":{"line":55,"column":103,"offset":4126},"end":{"line":55,"column":130,"offset":4153},"indent":[]}}],"position":{"start":{"line":55,"column":101,"offset":4124},"end":{"line":55,"column":132,"offset":4155},"indent":[]}},{"type":"text","value":" function is called when a new message occurs when the user is not having the website in focus. It means that if the user has the website in a browser's tab that it not the current one, or if the user is not having the website open at all, or if the browser is minimized that this message will be invoked. The case about if the user is having focus will be treated later.","position":{"start":{"line":55,"column":132,"offset":4155},"end":{"line":55,"column":503,"offset":4526},"indent":[]}}],"position":{"start":{"line":55,"column":1,"offset":4024},"end":{"line":55,"column":503,"offset":4526},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"This code get the data from the server. In my case, it's under the property ","position":{"start":{"line":57,"column":1,"offset":4528},"end":{"line":57,"column":77,"offset":4604},"indent":[]}},{"type":"emphasis","children":[{"type":"text","value":"data","position":{"start":{"line":57,"column":78,"offset":4605},"end":{"line":57,"column":82,"offset":4609},"indent":[]}}],"position":{"start":{"line":57,"column":77,"offset":4604},"end":{"line":57,"column":83,"offset":4610},"indent":[]}},{"type":"text","value":" and ","position":{"start":{"line":57,"column":83,"offset":4610},"end":{"line":57,"column":88,"offset":4615},"indent":[]}},{"type":"emphasis","children":[{"type":"text","value":"notification","position":{"start":{"line":57,"column":89,"offset":4616},"end":{"line":57,"column":101,"offset":4628},"indent":[]}}],"position":{"start":{"line":57,"column":88,"offset":4615},"end":{"line":57,"column":102,"offset":4629},"indent":[]}},{"type":"text","value":". I set the title, the main message, the icon. The URL is there but didn't work at this time. That is why the second method, which use directly the push notification api to hook on ","position":{"start":{"line":57,"column":102,"offset":4629},"end":{"line":57,"column":283,"offset":4810},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"notificationclick","position":{"start":{"line":57,"column":285,"offset":4812},"end":{"line":57,"column":302,"offset":4829},"indent":[]}}],"position":{"start":{"line":57,"column":283,"offset":4810},"end":{"line":57,"column":304,"offset":4831},"indent":[]}},{"type":"text","value":". This method handles when the user click the notification to open a specific URL. For example, in my case, the notification occurs when a specific event occurs and clicking the notification opens a specific page where the user can see the result of the action.","position":{"start":{"line":57,"column":304,"offset":4831},"end":{"line":57,"column":565,"offset":5092},"indent":[]}}],"position":{"start":{"line":57,"column":1,"offset":4528},"end":{"line":57,"column":565,"offset":5092},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"The next step is to have a page where the user can subscribe to the push notification. In my case, it's done in the user's profile. I have a checkbox, if checked, the browser will request the authorization to the user to install the service worker. So, in my profile.js page I have the following code:","position":{"start":{"line":59,"column":1,"offset":5094},"end":{"line":59,"column":302,"offset":5395},"indent":[]}}],"position":{"start":{"line":59,"column":1,"offset":5094},"end":{"line":59,"column":302,"offset":5395},"indent":[]}},{"type":"code","lang":"typescript","meta":null,"value":"$(document).ready(function () {\n  initialiseUI();\n});\n\nfunction initialiseUI() {\n  $(document).on(\n    \"click\",\n    \"#\" + window.Application.Variables.IsHavingNotification,\n    function requestPushNotification() {\n      var $ctrl = $(this);\n      if ($ctrl.is(\":checked\")) {\n        console.log(\"checked\");\n        subscribeUser();\n      } else {\n        console.log(\"unchecked\");\n        unsubscribeUser();\n      }\n    }\n  );\n}\n\nfunction subscribeUser() {\n  var isSubscribed = false;\n  var messaging = firebase.messaging();\n  messaging\n    .requestPermission()\n    .then(function () {\n      messaging\n        .getToken()\n        .then(function (currentToken) {\n          if (currentToken) {\n            updateSubscriptionOnServer(currentToken);\n            isSubscribed = true;\n          } else {\n            updateSubscriptionOnServer(null);\n          }\n          $(\"#\" + window.Application.Variables.IsHavingNotificationt).prop(\n            \"checked\",\n            isSubscribed\n          );\n        })\n        .catch(function (err) {\n          isSubscribed = false;\n          updateSubscriptionOnServer(null);\n        });\n    })\n    .catch(function (err) {\n      console.log(\"Unable to get permission to notify.\", err);\n    });\n}\n\nfunction unsubscribeUser() {\n  var messaging = firebase.messaging();\n  messaging\n    .getToken()\n    .then(function (currentToken) {\n      messaging\n        .deleteToken(currentToken)\n        .then(function () {\n          updateSubscriptionOnServer(null);\n        })\n        .catch(function (err) {\n          console.log(\"Unable to delete token. \", err);\n        });\n    })\n    .catch(function (err) {\n      console.log(\"Error retrieving Instance ID token. \", err);\n    });\n}\n\nfunction updateSubscriptionOnServer(subscription) {\n  var subscriptionDetail = { key: \"\" };\n  if (subscription) {\n    subscriptionDetail = { key: subscription };\n  } else {\n    console.log(\"delete on the server the token\");\n  }\n  var apiUrl = window.Application.Url.UrlNotifications;\n  var dateToSent = subscriptionDetail;\n  $.ajax({\n    url: apiUrl,\n    type: \"POST\",\n    data: dateToSent,\n    cache: true,\n    dataType: \"json\",\n    success: function (json) {\n      if (json.IsValid) {\n      } else {\n      }\n    },\n    error: function (xmlHttpRequest, textStatus, errorThrown) {\n      console.log(\"some error occured\", textStatus, errorThrown);\n    },\n    always: function () {},\n  });\n}","position":{"start":{"line":61,"column":1,"offset":5397},"end":{"line":158,"column":4,"offset":7814},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"We allow to subscribe and unsubscribe. When subscribing, we request the permission to send the notification by the browser. Then, we get the token provided my Firebase. This is needed to be able to save the token back to the server to have targeted message from the server later. With this token, we will be able to send specific message to specific user. This is where the ","position":{"start":{"line":160,"column":1,"offset":7816},"end":{"line":160,"column":375,"offset":8190},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"updateSubscriptionOnServer","position":{"start":{"line":160,"column":377,"offset":8192},"end":{"line":160,"column":403,"offset":8218},"indent":[]}}],"position":{"start":{"line":160,"column":375,"offset":8190},"end":{"line":160,"column":405,"offset":8220},"indent":[]}},{"type":"text","value":" come to play. It sends by Ajax the token, and it's saved in the database. In my case, I added a column in the user's table to keep track of the token. The unsubscribe sends a null value and set null in the column. This way, the server can look and see if the user has or not a Firebase token and only send a message when a token is defined.","position":{"start":{"line":160,"column":405,"offset":8220},"end":{"line":160,"column":746,"offset":8561},"indent":[]}}],"position":{"start":{"line":160,"column":1,"offset":7816},"end":{"line":160,"column":746,"offset":8561},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"To verify that all the previous steps are well executed, you can look in Chrome developer tool under ","position":{"start":{"line":162,"column":1,"offset":8563},"end":{"line":162,"column":102,"offset":8664},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"Application","position":{"start":{"line":162,"column":104,"offset":8666},"end":{"line":162,"column":115,"offset":8677},"indent":[]}}],"position":{"start":{"line":162,"column":102,"offset":8664},"end":{"line":162,"column":117,"offset":8679},"indent":[]}},{"type":"text","value":" and see for the service worker.","position":{"start":{"line":162,"column":117,"offset":8679},"end":{"line":162,"column":149,"offset":8711},"indent":[]}}],"position":{"start":{"line":162,"column":1,"offset":8563},"end":{"line":162,"column":149,"offset":8711},"indent":[]}},{"type":"paragraph","children":[{"type":"image","title":null,"url":"images/ChromeApplicationTab-1024x226.png","alt":null,"position":{"start":{"line":164,"column":1,"offset":8713},"end":{"line":164,"column":46,"offset":8758},"indent":[]}}],"position":{"start":{"line":164,"column":1,"offset":8713},"end":{"line":164,"column":46,"offset":8758},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"It's important to understand that what we are doing only work under localhost or with HTTPS' website. From Chrome'S debug panel, you can unregister, or click \"Update on reload\" to force a reinstallation of the service worker. This can be handy when developing to be sure to always have the latest version of your service worker.","position":{"start":{"line":166,"column":1,"offset":8760},"end":{"line":166,"column":329,"offset":9088},"indent":[]}}],"position":{"start":{"line":166,"column":1,"offset":8760},"end":{"line":166,"column":329,"offset":9088},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"The next step is to have your website listen to incoming messages. This cover the scenario when the user is on the website and that we do not want to use the browser notification. To do, we need to use some code that we already used in the service worker concerning Firebase's initialization. In my case, I added in the master page (","position":{"start":{"line":168,"column":1,"offset":9090},"end":{"line":168,"column":334,"offset":9423},"indent":[]}},{"type":"text","value":"_","position":{"start":{"line":168,"column":334,"offset":9423},"end":{"line":168,"column":336,"offset":9425},"indent":[]}},{"type":"text","value":"layout.cshtml) a reference to Firebase script to initialize the library. It looks like that:","position":{"start":{"line":168,"column":336,"offset":9425},"end":{"line":168,"column":428,"offset":9517},"indent":[]}}],"position":{"start":{"line":168,"column":1,"offset":9090},"end":{"line":168,"column":428,"offset":9517},"indent":[]}},{"type":"code","lang":null,"meta":null,"value":" <script src=\"https://www.gstatic.com/firebasejs/3.6.2/firebase.js\"></script> </script>\n <script> var config = {\n   apiKey: \"AIzaSyDe0Z0NtygDUDySNMRtl2MIV5m4Hp7IAm0\",\n   authDomain: \"bourse-virtuelle.firebaseapp.com\",\n   messagingSenderId: \"555061918002\",\n   };\n firebase.initializeApp(config); </script>","position":{"start":{"line":170,"column":1,"offset":9519},"end":{"line":178,"column":4,"offset":9831},"indent":[1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"I also have a global JavaScript file where I added the listener to message which are used in every page I have.","position":{"start":{"line":180,"column":1,"offset":9833},"end":{"line":180,"column":112,"offset":9944},"indent":[]}}],"position":{"start":{"line":180,"column":1,"offset":9833},"end":{"line":180,"column":112,"offset":9944},"indent":[]}},{"type":"code","lang":"typescript","meta":null,"value":"$(document).ready(function () {\n  var messaging = firebase.messaging();\n  messaging.onMessage(function (payload) {\n    var dataFromServer = JSON.parse(payload.data.notification);\n    var myMessageBar = new MessageBar();\n    myMessageBar.setMessage(dataFromServer.title + \" : \" + dataFromServer.body);\n  });\n});","position":{"start":{"line":182,"column":1,"offset":9946},"end":{"line":191,"column":4,"offset":10274},"indent":[1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"The listener is ","position":{"start":{"line":193,"column":1,"offset":10276},"end":{"line":193,"column":17,"offset":10292},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"onMessage","position":{"start":{"line":193,"column":19,"offset":10294},"end":{"line":193,"column":28,"offset":10303},"indent":[]}}],"position":{"start":{"line":193,"column":17,"offset":10292},"end":{"line":193,"column":30,"offset":10305},"indent":[]}},{"type":"text","value":" is fired when the user has the focus on the website. So, instead of having the service worker to handle the message, this handler is receiving the data. This give the advantage to be able to add the message directly in the webpage Dom, something that the service worker cannot do. It also has the convenience of having the notification in the field of view of the user instead of having a notification outside.","position":{"start":{"line":193,"column":30,"offset":10305},"end":{"line":193,"column":441,"offset":10716},"indent":[]}}],"position":{"start":{"line":193,"column":1,"offset":10276},"end":{"line":193,"column":441,"offset":10716},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"At this point, you can use any HTTP tools to send a message to Firebase. You can use console.log to output the token and forge a HTTP request with your web api and sender id. I won't give detail in this post and will give how to do it in a future post about how to handle it with a webjob in C# which will send a HTTP request.","position":{"start":{"line":195,"column":1,"offset":10718},"end":{"line":195,"column":327,"offset":11044},"indent":[]}}],"position":{"start":{"line":195,"column":1,"offset":10718},"end":{"line":195,"column":327,"offset":11044},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Service worker allows you do to a lot more than just using the push notification. This article covered the basis of how to use Google Firebase has a backbone to have your own backend infrastructure (covered in a future article) to send a message and to have your client receiving the message. Several pieces of code is needed in specific places.","position":{"start":{"line":197,"column":1,"offset":11046},"end":{"line":197,"column":346,"offset":11391},"indent":[]}}],"position":{"start":{"line":197,"column":1,"offset":11046},"end":{"line":197,"column":346,"offset":11391},"indent":[]}},{"type":"export","value":"export const _frontmatter = {\"title\":\"Service Worker, Push Notification and Asp.Net MVC - Part 1 of 3 Client Side\",\"date\":\"2017-01-03\",\"categories\":[\"asp-mvc\",\"asp-net\",\"javascript\"]}","position":{"start":{"line":200,"column":1,"offset":11394},"end":{"line":200,"column":184,"offset":11577},"indent":[]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":200,"column":184,"offset":11577}}},"scopeImports":["import * as React from 'react'"],"scopeIdentifiers":["React"],"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Service Worker, Push Notification and Asp.Net MVC - Part 1 of 3 Client Side\",\n  \"date\": \"2017-01-03\",\n  \"categories\": [\"asp-mvc\", \"asp-net\", \"javascript\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"Browsers involve very rapidly and since few years it's possible to write JavaScript that runs in the background of the browser. That means that it's possible to run code even if the user is not on the website. This is useful for many scenarios and today we will see one feature which is the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"push notification\"), \". The particular environment that we will describe is to use a service worker that wait a message from a Asp.Net Azure web job written in C# that will push a message at a particular time depending of some value to a specific user. The end result will be that the browser will popup a message box at the bottom right if the user is not on the website or if the user is on the website will display a HTML notification directly on the page.\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"554px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/0d119c8100654898119218eaab7851c0/04abd/NotificationChromeWebPush.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"24.333333333333332%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAr0lEQVQY01WP0Q7CIAxF9/8/aSbKhrKCjnYtg2Lc1Mzz1LS9ybmdqtYNVRVhImLmZVmQCBFzzojIzIhpIRKR/ZmZ13Xtaq2tNVVtraV5tlfrnPP+fjEXY0xKyQ7W3dxgbd+fQwhtI+f8Dp96M4V4HVyIj1JKjPERI4SARNPkAWB+PgN8MkdKKd2fdhYAmABERFVLqd9jbZvaj3EcRaRbDwi/O9PWbd/sevtwxHvPzC/S6yFilBtzQQAAAABJRU5ErkJggg==')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"NotificationChromeWebPush\",\n    \"title\": \"NotificationChromeWebPush\",\n    \"src\": \"/static/0d119c8100654898119218eaab7851c0/04abd/NotificationChromeWebPush.png\",\n    \"srcSet\": [\"/static/0d119c8100654898119218eaab7851c0/5a46d/NotificationChromeWebPush.png 300w\", \"/static/0d119c8100654898119218eaab7851c0/04abd/NotificationChromeWebPush.png 554w\"],\n    \"sizes\": \"(max-width: 554px) 100vw, 554px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"This article is the part one of two which concentrates on the front-end, not the C# code that runs on the server. We will cover the registration of \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://firebase.google.com/\"\n  }, \"Google Firebase\"), \", the service worker's code and the JavaScript code to add on your website.\"), mdx(\"p\", null, \"The first step if to register an account with Google Firebase. This is not very obvious since almost all example on the web (at this date) uses the raw Service Worker + Push Notification API with the legacy Google system instead of Firebase. Both are pretty compatible in term of server contracts to generate the message, however, on the client side, it's pretty different. Firebase acts as a wrapper on the native Service Worker API and Push Notification API. You can still use the API directly, and in some case, it's the only way to access advanced feature.\"), mdx(\"p\", null, \"To create a Firebase account, you need to \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://console.firebase.google.com\"\n  }, \"https://console.firebase.google.com\"), \" and create an account and a project. \", mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"1024px\"\n    }\n  }, \"\\n      \", mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"72%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACP0lEQVQ4y3WS3WoTQRTH97qP4Av4EhFafQcRvPFCFKSKt95V/ChIi30DCzUgaEX0Km1tQVoV9KYXJmaTKPnYj2R3srO7s1/Z3fnLTJIma9oDP84wM+c/Z845ymblJ15UTrFxVMf6lxaeHzbxdL8ueXagYvO4i61v2gXoeHncxnqliscHKp7s1aDcfHOCG7s1XN/9g2uvVayUm7habkq/Um5geUeVXNmuobRdRUn6GkqvqljeqePyxlcsPXyPpQdvcWltHwrmjadImIssYkhDH3nExuvAx0UW+Qz3V9dw+84j/Kp2oHDOIRAWhhHanS503UBP02CYfWi6jm63hzCKkOU5cs7PyLJcxvUMG9WWDdvDTJDLCxkCxsAYg+/7kiSJkec5kjiW5/IjhZixaBhzdMyg+OUw5dBYBjPI5JpEGawwR5By6Wk8RuwLy/mYdCKqdxtQ0jTDPKMJs3VaYLrPcyE6DwexHSjWkKIAcaQfTPx5OA5Fw3TwoU7wUR3ikzrEu98EJ+3/BIWIMbBg9C3o/QFMi2BIPYntuPJOn1B4rovvbYK7nw3cOzSwemTg1p6BrR9mUZCIIMuCKbqraYji+Kz4rs/kg7Z4eJLliLkIKYWtD5EGLpjrzgQHhMJxfdlJQZqmmB8pzw8KZRCi/SGFblGofwkGzjj7BcH5sRDjIjhPUCDKoJkWGi0dhI5LsvBlMYdi9kZJgiRJZKZSkC0KWo6Lvk1k3ad7SvFFCtfz4fkMPgsKEOqd23GR5bRhQvAfPf4HpE+iwuMAAAAASUVORK5CYII=')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"CreateFirebaseProject 1024x736\",\n    \"title\": \"CreateFirebaseProject 1024x736\",\n    \"src\": \"/static/dc5243835543d850c4ebfe72ef05f81f/2bef9/CreateFirebaseProject-1024x736.png\",\n    \"srcSet\": [\"/static/dc5243835543d850c4ebfe72ef05f81f/5a46d/CreateFirebaseProject-1024x736.png 300w\", \"/static/dc5243835543d850c4ebfe72ef05f81f/0a47e/CreateFirebaseProject-1024x736.png 600w\", \"/static/dc5243835543d850c4ebfe72ef05f81f/2bef9/CreateFirebaseProject-1024x736.png 1024w\"],\n    \"sizes\": \"(max-width: 1024px) 100vw, 1024px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n    \")), mdx(\"p\", null, \"Firebase is a library that is accessible via API keys and JavaScript API. You can also invoke the API through a Rest API which we will see in the second part. The first challenge is to figure out where to get the right API key because the system has many. The first step is to create the Service Worker. This is registered when the user goes into your website to run in the background of the browser. The default is to create a file called \\\"firebase-messaging-sw.js\\\" and to put that file at the root of your website. The location of the file is important because the service worker can only access assert that are sibling or child to the script registered.\"), mdx(\"p\", null, \"Here is the full code that I have for my Service Worker:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-typescript\"\n  }, \"importScripts(\\\"https://www.gstatic.com/firebasejs/3.5.0/firebase-app.js\\\");\\nimportScripts(\\\"https://www.gstatic.com/firebasejs/3.5.0/firebase-messaging.js\\\");\\n\\nvar config = {\\n  apiKey: \\\"AIzaSyDe0Z0NtygDUDySNMRtl2MIV5m4Hp7IAm0\\\",\\n  authDomain: \\\"bourse-virtuelle.firebaseapp.com\\\",\\n  messagingSenderId: \\\"555061918002\\\",\\n};\\nfirebase.initializeApp(config);\\n\\nvar messaging = firebase.messaging();\\nmessaging.setBackgroundMessageHandler(function (payload) {\\n  var dataFromServer = JSON.parse(payload.data.notification);\\n  var notificationTitle = dataFromServer.title;\\n  var notificationOptions = {\\n    body: dataFromServer.body,\\n    icon: dataFromServer.icon,\\n    data: { url: dataFromServer.url },\\n  };\\n  return self.registration.showNotification(\\n    notificationTitle,\\n    notificationOptions\\n  );\\n});\\n\\nself.addEventListener(\\\"notificationclick\\\", function (event) {\\n  var urlToRedirect = event.notification.data.url;\\n  event.notification.close();\\n  event.waitUntil(self.clients.openWindow(urlToRedirect));\\n});\\n\")), mdx(\"p\", null, \"In short, it uses 2 Firebase scripts. One for the Firebase and one for the messaging which is the wrapper around the push notification api. The configuration is tricky. The apiKey is taken from the Firebase's console, under the desired project, under the project settings gear, in the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"General\"), \"tab. \", mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"1024px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/1e545b730c25eb373fb4f94da0fae97c/2bef9/WebApiKeyForFirebase-1024x572.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"55.99999999999999%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB60lEQVQoz42QyW4TQRCGGx4B8RK8F0cunDAghXCAgIEbUiAcuURWlKAQR8ig5AEQQlmY2AkmOWDkZfZ96ZkPdc+MWC7Q0qfqrqr+axFLOx+5t3vE3cEpt99/ZXlwxoMPp9wfjHi4N+bR/jfNyv6Ylb2xtq1v+e0hne1DlvpHdLYOuLX5GdHpf+LO4Iyb7y64sXvO9Z1zrjwfcvmZgeh+QTw+ruke/7q3PDFquo19aiCqLKWIApAZUHJhJlzrTbn6eop4OUGsTbj06gditb5r34sJQvnUe/V7bdtYnCQoClmizsxM6Z/Y9A4WbAwt3owstkc264bJ5tBi48SiZ9R+xbphsdXkqZjIsowkSUjTFKiIo5zAcbBnM/LAIwt90sBDRoGepAgD8tAnC2qK3+7KLxz12bYbQZBS4vghSZYTpRlZIclkSRAn+GFEGKekeUFWlHXsL0QQBPi+T1nWIxdS4gUhcRwThqHuXh3P8zBNU/uqqs5VE1E1UFFVFUJ9VIJ5nv8hqN5qHe1JkwRVvCgKXbyUUlsloijLRlB1oEQVZSmRssT1Q6I41uR5oUVUUcu29Xpq6+C4Dp4XMV8kOE6smxCtWNuhqmraLtOFxcJymDcsbPefqDwtqPZT76aqBR2XuWlhux626zf2//gJbBEO7CbkOIUAAAAASUVORK5CYII=')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"WebApiKeyForFirebase 1024x572\",\n    \"title\": \"WebApiKeyForFirebase 1024x572\",\n    \"src\": \"/static/1e545b730c25eb373fb4f94da0fae97c/2bef9/WebApiKeyForFirebase-1024x572.png\",\n    \"srcSet\": [\"/static/1e545b730c25eb373fb4f94da0fae97c/5a46d/WebApiKeyForFirebase-1024x572.png 300w\", \"/static/1e545b730c25eb373fb4f94da0fae97c/0a47e/WebApiKeyForFirebase-1024x572.png 600w\", \"/static/1e545b730c25eb373fb4f94da0fae97c/2bef9/WebApiKeyForFirebase-1024x572.png 1024w\"],\n    \"sizes\": \"(max-width: 1024px) 100vw, 1024px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"The \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"messagingSenderId\"), \" is an id that is available tab next to the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"General\"), \" tab, called \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Cloud Messaging\"), \".\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"1024px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/93b439778e6ce540a478650931705b71/2bef9/SenderId-1024x505.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"49.33333333333333%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB5UlEQVQoz32R227TQBCG9w14DSQQQpXghlsegEfhCRCK1JSmgEAFiVfglIIqKrWglkNvuChVL9K0FNmpEhw7a3vt9fn4o1knht4w0qf5d7wzOzNm3a0DdLYH6Oz+Qm/3DI/3TvFo7wzr+xqe7etY/6a1vPg+wZNPQ3Q2D7G8dYT7Gz9w7/0BVj4c4unOEdY+DsB6n0+w+nWM5S9j3N05x6XnP8HWhmDdAdjKMVj3uPFKD8AeDMFWTxp6c0g/PG00yhSoUpC5fo472xzX+zPcejfD7U2OmxsWlt5auPbGwlLfUuerr00Vu9G3cOWVicsv/8KSLEeaFyiqGlFS4DcXODc5RhOOseHAdDwVWzB1PBg2ITC1BSb8Isz3fRBVVSk8GSAMQyRJgizLkWXZPz6DlBJBECCOU0RRijRN22+EKkjJZEVZwgtCGIYBTdOhj0aN13Voug7OOeIkQRDSo6WiKCuVW6MxRi9QwbquUZYl/CBEICVc120RrgtPCNXB/4xqsCiK1IhUjJBBBCFDGNxpmXIXXPiYOUJh2a5iyh2YtqsgTeticRzPO6zmHUbwfAlzxsFdAXsOxaI4gfB8lRgl6UXiBCntkEamPRZ53v4UWrr0fdU5aXWWEnmeqxjpoijU/cVkC/4A7ffHyXP6jZIAAAAASUVORK5CYII=')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"SenderId 1024x505\",\n    \"title\": \"SenderId 1024x505\",\n    \"src\": \"/static/93b439778e6ce540a478650931705b71/2bef9/SenderId-1024x505.png\",\n    \"srcSet\": [\"/static/93b439778e6ce540a478650931705b71/5a46d/SenderId-1024x505.png 300w\", \"/static/93b439778e6ce540a478650931705b71/0a47e/SenderId-1024x505.png 600w\", \"/static/93b439778e6ce540a478650931705b71/2bef9/SenderId-1024x505.png 1024w\"],\n    \"sizes\": \"(max-width: 1024px) 100vw, 1024px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"The initialize command will connect the service worker to the server to listen to new messages. The \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"setBackgroundMessageHandler\"), \" function is called when a new message occurs when the user is not having the website in focus. It means that if the user has the website in a browser's tab that it not the current one, or if the user is not having the website open at all, or if the browser is minimized that this message will be invoked. The case about if the user is having focus will be treated later.\"), mdx(\"p\", null, \"This code get the data from the server. In my case, it's under the property \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"data\"), \" and \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"notification\"), \". I set the title, the main message, the icon. The URL is there but didn't work at this time. That is why the second method, which use directly the push notification api to hook on \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"notificationclick\"), \". This method handles when the user click the notification to open a specific URL. For example, in my case, the notification occurs when a specific event occurs and clicking the notification opens a specific page where the user can see the result of the action.\"), mdx(\"p\", null, \"The next step is to have a page where the user can subscribe to the push notification. In my case, it's done in the user's profile. I have a checkbox, if checked, the browser will request the authorization to the user to install the service worker. So, in my profile.js page I have the following code:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-typescript\"\n  }, \"$(document).ready(function () {\\n  initialiseUI();\\n});\\n\\nfunction initialiseUI() {\\n  $(document).on(\\n    \\\"click\\\",\\n    \\\"#\\\" + window.Application.Variables.IsHavingNotification,\\n    function requestPushNotification() {\\n      var $ctrl = $(this);\\n      if ($ctrl.is(\\\":checked\\\")) {\\n        console.log(\\\"checked\\\");\\n        subscribeUser();\\n      } else {\\n        console.log(\\\"unchecked\\\");\\n        unsubscribeUser();\\n      }\\n    }\\n  );\\n}\\n\\nfunction subscribeUser() {\\n  var isSubscribed = false;\\n  var messaging = firebase.messaging();\\n  messaging\\n    .requestPermission()\\n    .then(function () {\\n      messaging\\n        .getToken()\\n        .then(function (currentToken) {\\n          if (currentToken) {\\n            updateSubscriptionOnServer(currentToken);\\n            isSubscribed = true;\\n          } else {\\n            updateSubscriptionOnServer(null);\\n          }\\n          $(\\\"#\\\" + window.Application.Variables.IsHavingNotificationt).prop(\\n            \\\"checked\\\",\\n            isSubscribed\\n          );\\n        })\\n        .catch(function (err) {\\n          isSubscribed = false;\\n          updateSubscriptionOnServer(null);\\n        });\\n    })\\n    .catch(function (err) {\\n      console.log(\\\"Unable to get permission to notify.\\\", err);\\n    });\\n}\\n\\nfunction unsubscribeUser() {\\n  var messaging = firebase.messaging();\\n  messaging\\n    .getToken()\\n    .then(function (currentToken) {\\n      messaging\\n        .deleteToken(currentToken)\\n        .then(function () {\\n          updateSubscriptionOnServer(null);\\n        })\\n        .catch(function (err) {\\n          console.log(\\\"Unable to delete token. \\\", err);\\n        });\\n    })\\n    .catch(function (err) {\\n      console.log(\\\"Error retrieving Instance ID token. \\\", err);\\n    });\\n}\\n\\nfunction updateSubscriptionOnServer(subscription) {\\n  var subscriptionDetail = { key: \\\"\\\" };\\n  if (subscription) {\\n    subscriptionDetail = { key: subscription };\\n  } else {\\n    console.log(\\\"delete on the server the token\\\");\\n  }\\n  var apiUrl = window.Application.Url.UrlNotifications;\\n  var dateToSent = subscriptionDetail;\\n  $.ajax({\\n    url: apiUrl,\\n    type: \\\"POST\\\",\\n    data: dateToSent,\\n    cache: true,\\n    dataType: \\\"json\\\",\\n    success: function (json) {\\n      if (json.IsValid) {\\n      } else {\\n      }\\n    },\\n    error: function (xmlHttpRequest, textStatus, errorThrown) {\\n      console.log(\\\"some error occured\\\", textStatus, errorThrown);\\n    },\\n    always: function () {},\\n  });\\n}\\n\")), mdx(\"p\", null, \"We allow to subscribe and unsubscribe. When subscribing, we request the permission to send the notification by the browser. Then, we get the token provided my Firebase. This is needed to be able to save the token back to the server to have targeted message from the server later. With this token, we will be able to send specific message to specific user. This is where the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"updateSubscriptionOnServer\"), \" come to play. It sends by Ajax the token, and it's saved in the database. In my case, I added a column in the user's table to keep track of the token. The unsubscribe sends a null value and set null in the column. This way, the server can look and see if the user has or not a Firebase token and only send a message when a token is defined.\"), mdx(\"p\", null, \"To verify that all the previous steps are well executed, you can look in Chrome developer tool under \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Application\"), \" and see for the service worker.\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"1024px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/e0ba51ca2eec3f175c40ee16f9b6c019/2bef9/ChromeApplicationTab-1024x226.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"21.999999999999996%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAuElEQVQY003Py5KDIBBAUf//N3U0EaV5iCBNcqfUpGYWp6BY3G66YRgwxiAihBBwIohYSskcR2HPt/P+pVppTVFVXu12vtVa6MZx5Iw650gpsy4eYwRrPc5FRM4hkVIatb6p9cVx/ImpsaWGuIwPB900TczzfAWtTcSYCX7jaTw/D8f4kCtcil6xWtvnvG27XlJuLPag6/uevh+ub3q/f7ZorC4wL57VRkJIbEnRf6Ev1durvUlJ+QUEizTCTmGCpAAAAABJRU5ErkJggg==')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"ChromeApplicationTab 1024x226\",\n    \"title\": \"ChromeApplicationTab 1024x226\",\n    \"src\": \"/static/e0ba51ca2eec3f175c40ee16f9b6c019/2bef9/ChromeApplicationTab-1024x226.png\",\n    \"srcSet\": [\"/static/e0ba51ca2eec3f175c40ee16f9b6c019/5a46d/ChromeApplicationTab-1024x226.png 300w\", \"/static/e0ba51ca2eec3f175c40ee16f9b6c019/0a47e/ChromeApplicationTab-1024x226.png 600w\", \"/static/e0ba51ca2eec3f175c40ee16f9b6c019/2bef9/ChromeApplicationTab-1024x226.png 1024w\"],\n    \"sizes\": \"(max-width: 1024px) 100vw, 1024px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"It's important to understand that what we are doing only work under localhost or with HTTPS' website. From Chrome'S debug panel, you can unregister, or click \\\"Update on reload\\\" to force a reinstallation of the service worker. This can be handy when developing to be sure to always have the latest version of your service worker.\"), mdx(\"p\", null, \"The next step is to have your website listen to incoming messages. This cover the scenario when the user is on the website and that we do not want to use the browser notification. To do, we need to use some code that we already used in the service worker concerning Firebase's initialization. In my case, I added in the master page (\", \"_\", \"layout.cshtml) a reference to Firebase script to initialize the library. It looks like that:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \" <script src=\\\"https://www.gstatic.com/firebasejs/3.6.2/firebase.js\\\"></script> </script>\\n <script> var config = {\\n   apiKey: \\\"AIzaSyDe0Z0NtygDUDySNMRtl2MIV5m4Hp7IAm0\\\",\\n   authDomain: \\\"bourse-virtuelle.firebaseapp.com\\\",\\n   messagingSenderId: \\\"555061918002\\\",\\n   };\\n firebase.initializeApp(config); </script>\\n\")), mdx(\"p\", null, \"I also have a global JavaScript file where I added the listener to message which are used in every page I have.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-typescript\"\n  }, \"$(document).ready(function () {\\n  var messaging = firebase.messaging();\\n  messaging.onMessage(function (payload) {\\n    var dataFromServer = JSON.parse(payload.data.notification);\\n    var myMessageBar = new MessageBar();\\n    myMessageBar.setMessage(dataFromServer.title + \\\" : \\\" + dataFromServer.body);\\n  });\\n});\\n\")), mdx(\"p\", null, \"The listener is \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"onMessage\"), \" is fired when the user has the focus on the website. So, instead of having the service worker to handle the message, this handler is receiving the data. This give the advantage to be able to add the message directly in the webpage Dom, something that the service worker cannot do. It also has the convenience of having the notification in the field of view of the user instead of having a notification outside.\"), mdx(\"p\", null, \"At this point, you can use any HTTP tools to send a message to Firebase. You can use console.log to output the token and forge a HTTP request with your web api and sender id. I won't give detail in this post and will give how to do it in a future post about how to handle it with a webjob in C# which will send a HTTP request.\"), mdx(\"p\", null, \"Service worker allows you do to a lot more than just using the push notification. This article covered the basis of how to use Google Firebase has a backbone to have your own backend infrastructure (covered in a future article) to send a message and to have your client receiving the message. Several pieces of code is needed in specific places.\"));\n}\n;\nMDXContent.isMDXComponent = true;","rawMDXOutput":"/* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsxRuntime classic */\n/* @jsx mdx */\n\nexport const _frontmatter = {\n  \"title\": \"Service Worker, Push Notification and Asp.Net MVC - Part 1 of 3 Client Side\",\n  \"date\": \"2017-01-03\",\n  \"categories\": [\"asp-mvc\", \"asp-net\", \"javascript\"]\n};\n\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = \"wrapper\"\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n    <p>{`Browsers involve very rapidly and since few years it's possible to write JavaScript that runs in the background of the browser. That means that it's possible to run code even if the user is not on the website. This is useful for many scenarios and today we will see one feature which is the `}<strong parentName=\"p\">{`push notification`}</strong>{`. The particular environment that we will describe is to use a service worker that wait a message from a Asp.Net Azure web job written in C# that will push a message at a particular time depending of some value to a specific user. The end result will be that the browser will popup a message box at the bottom right if the user is not on the website or if the user is on the website will display a HTML notification directly on the page.`}</p>\n    <p><span parentName=\"p\" {...{\n        \"className\": \"gatsby-resp-image-wrapper\",\n        \"style\": {\n          \"position\": \"relative\",\n          \"display\": \"block\",\n          \"marginLeft\": \"auto\",\n          \"marginRight\": \"auto\",\n          \"maxWidth\": \"554px\"\n        }\n      }}>{`\n      `}<a parentName=\"span\" {...{\n          \"className\": \"gatsby-resp-image-link\",\n          \"href\": \"/static/0d119c8100654898119218eaab7851c0/04abd/NotificationChromeWebPush.png\",\n          \"style\": {\n            \"display\": \"block\"\n          },\n          \"target\": \"_blank\",\n          \"rel\": \"noopener\"\n        }}>{`\n    `}<span parentName=\"a\" {...{\n            \"className\": \"gatsby-resp-image-background-image\",\n            \"style\": {\n              \"paddingBottom\": \"24.333333333333332%\",\n              \"position\": \"relative\",\n              \"bottom\": \"0\",\n              \"left\": \"0\",\n              \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAr0lEQVQY01WP0Q7CIAxF9/8/aSbKhrKCjnYtg2Lc1Mzz1LS9ybmdqtYNVRVhImLmZVmQCBFzzojIzIhpIRKR/ZmZ13Xtaq2tNVVtraV5tlfrnPP+fjEXY0xKyQ7W3dxgbd+fQwhtI+f8Dp96M4V4HVyIj1JKjPERI4SARNPkAWB+PgN8MkdKKd2fdhYAmABERFVLqd9jbZvaj3EcRaRbDwi/O9PWbd/sevtwxHvPzC/S6yFilBtzQQAAAABJRU5ErkJggg==')\",\n              \"backgroundSize\": \"cover\",\n              \"display\": \"block\"\n            }\n          }}></span>{`\n  `}<img parentName=\"a\" {...{\n            \"className\": \"gatsby-resp-image-image\",\n            \"alt\": \"NotificationChromeWebPush\",\n            \"title\": \"NotificationChromeWebPush\",\n            \"src\": \"/static/0d119c8100654898119218eaab7851c0/04abd/NotificationChromeWebPush.png\",\n            \"srcSet\": [\"/static/0d119c8100654898119218eaab7851c0/5a46d/NotificationChromeWebPush.png 300w\", \"/static/0d119c8100654898119218eaab7851c0/04abd/NotificationChromeWebPush.png 554w\"],\n            \"sizes\": \"(max-width: 554px) 100vw, 554px\",\n            \"style\": {\n              \"width\": \"100%\",\n              \"height\": \"100%\",\n              \"margin\": \"0\",\n              \"verticalAlign\": \"middle\",\n              \"position\": \"absolute\",\n              \"top\": \"0\",\n              \"left\": \"0\"\n            },\n            \"loading\": \"lazy\",\n            \"decoding\": \"async\"\n          }}></img>{`\n  `}</a>{`\n    `}</span></p>\n    <p>{`This article is the part one of two which concentrates on the front-end, not the C# code that runs on the server. We will cover the registration of `}<a parentName=\"p\" {...{\n        \"href\": \"https://firebase.google.com/\"\n      }}>{`Google Firebase`}</a>{`, the service worker's code and the JavaScript code to add on your website.`}</p>\n    <p>{`The first step if to register an account with Google Firebase. This is not very obvious since almost all example on the web (at this date) uses the raw Service Worker + Push Notification API with the legacy Google system instead of Firebase. Both are pretty compatible in term of server contracts to generate the message, however, on the client side, it's pretty different. Firebase acts as a wrapper on the native Service Worker API and Push Notification API. You can still use the API directly, and in some case, it's the only way to access advanced feature.`}</p>\n    <p>{`To create a Firebase account, you need to `}<a parentName=\"p\" {...{\n        \"href\": \"https://console.firebase.google.com\"\n      }}>{`https://console.firebase.google.com`}</a>{` and create an account and a project. `}<span parentName=\"p\" {...{\n        \"className\": \"gatsby-resp-image-wrapper\",\n        \"style\": {\n          \"position\": \"relative\",\n          \"display\": \"block\",\n          \"marginLeft\": \"auto\",\n          \"marginRight\": \"auto\",\n          \"maxWidth\": \"1024px\"\n        }\n      }}>{`\n      `}<span parentName=\"span\" {...{\n          \"className\": \"gatsby-resp-image-background-image\",\n          \"style\": {\n            \"paddingBottom\": \"72%\",\n            \"position\": \"relative\",\n            \"bottom\": \"0\",\n            \"left\": \"0\",\n            \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACP0lEQVQ4y3WS3WoTQRTH97qP4Av4EhFafQcRvPFCFKSKt95V/ChIi30DCzUgaEX0Km1tQVoV9KYXJmaTKPnYj2R3srO7s1/Z3fnLTJIma9oDP84wM+c/Z845ymblJ15UTrFxVMf6lxaeHzbxdL8ueXagYvO4i61v2gXoeHncxnqliscHKp7s1aDcfHOCG7s1XN/9g2uvVayUm7habkq/Um5geUeVXNmuobRdRUn6GkqvqljeqePyxlcsPXyPpQdvcWltHwrmjadImIssYkhDH3nExuvAx0UW+Qz3V9dw+84j/Kp2oHDOIRAWhhHanS503UBP02CYfWi6jm63hzCKkOU5cs7PyLJcxvUMG9WWDdvDTJDLCxkCxsAYg+/7kiSJkec5kjiW5/IjhZixaBhzdMyg+OUw5dBYBjPI5JpEGawwR5By6Wk8RuwLy/mYdCKqdxtQ0jTDPKMJs3VaYLrPcyE6DwexHSjWkKIAcaQfTPx5OA5Fw3TwoU7wUR3ikzrEu98EJ+3/BIWIMbBg9C3o/QFMi2BIPYntuPJOn1B4rovvbYK7nw3cOzSwemTg1p6BrR9mUZCIIMuCKbqraYji+Kz4rs/kg7Z4eJLliLkIKYWtD5EGLpjrzgQHhMJxfdlJQZqmmB8pzw8KZRCi/SGFblGofwkGzjj7BcH5sRDjIjhPUCDKoJkWGi0dhI5LsvBlMYdi9kZJgiRJZKZSkC0KWo6Lvk1k3ad7SvFFCtfz4fkMPgsKEOqd23GR5bRhQvAfPf4HpE+iwuMAAAAASUVORK5CYII=')\",\n            \"backgroundSize\": \"cover\",\n            \"display\": \"block\"\n          }\n        }}></span>{`\n  `}<img parentName=\"span\" {...{\n          \"className\": \"gatsby-resp-image-image\",\n          \"alt\": \"CreateFirebaseProject 1024x736\",\n          \"title\": \"CreateFirebaseProject 1024x736\",\n          \"src\": \"/static/dc5243835543d850c4ebfe72ef05f81f/2bef9/CreateFirebaseProject-1024x736.png\",\n          \"srcSet\": [\"/static/dc5243835543d850c4ebfe72ef05f81f/5a46d/CreateFirebaseProject-1024x736.png 300w\", \"/static/dc5243835543d850c4ebfe72ef05f81f/0a47e/CreateFirebaseProject-1024x736.png 600w\", \"/static/dc5243835543d850c4ebfe72ef05f81f/2bef9/CreateFirebaseProject-1024x736.png 1024w\"],\n          \"sizes\": \"(max-width: 1024px) 100vw, 1024px\",\n          \"style\": {\n            \"width\": \"100%\",\n            \"height\": \"100%\",\n            \"margin\": \"0\",\n            \"verticalAlign\": \"middle\",\n            \"position\": \"absolute\",\n            \"top\": \"0\",\n            \"left\": \"0\"\n          },\n          \"loading\": \"lazy\",\n          \"decoding\": \"async\"\n        }}></img>{`\n    `}</span></p>\n    <p>{`Firebase is a library that is accessible via API keys and JavaScript API. You can also invoke the API through a Rest API which we will see in the second part. The first challenge is to figure out where to get the right API key because the system has many. The first step is to create the Service Worker. This is registered when the user goes into your website to run in the background of the browser. The default is to create a file called \"firebase-messaging-sw.js\" and to put that file at the root of your website. The location of the file is important because the service worker can only access assert that are sibling or child to the script registered.`}</p>\n    <p>{`Here is the full code that I have for my Service Worker:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-typescript\"\n      }}>{`importScripts(\"https://www.gstatic.com/firebasejs/3.5.0/firebase-app.js\");\nimportScripts(\"https://www.gstatic.com/firebasejs/3.5.0/firebase-messaging.js\");\n\nvar config = {\n  apiKey: \"AIzaSyDe0Z0NtygDUDySNMRtl2MIV5m4Hp7IAm0\",\n  authDomain: \"bourse-virtuelle.firebaseapp.com\",\n  messagingSenderId: \"555061918002\",\n};\nfirebase.initializeApp(config);\n\nvar messaging = firebase.messaging();\nmessaging.setBackgroundMessageHandler(function (payload) {\n  var dataFromServer = JSON.parse(payload.data.notification);\n  var notificationTitle = dataFromServer.title;\n  var notificationOptions = {\n    body: dataFromServer.body,\n    icon: dataFromServer.icon,\n    data: { url: dataFromServer.url },\n  };\n  return self.registration.showNotification(\n    notificationTitle,\n    notificationOptions\n  );\n});\n\nself.addEventListener(\"notificationclick\", function (event) {\n  var urlToRedirect = event.notification.data.url;\n  event.notification.close();\n  event.waitUntil(self.clients.openWindow(urlToRedirect));\n});\n`}</code></pre>\n    <p>{`In short, it uses 2 Firebase scripts. One for the Firebase and one for the messaging which is the wrapper around the push notification api. The configuration is tricky. The apiKey is taken from the Firebase's console, under the desired project, under the project settings gear, in the `}<strong parentName=\"p\">{`General`}</strong>{`tab. `}<span parentName=\"p\" {...{\n        \"className\": \"gatsby-resp-image-wrapper\",\n        \"style\": {\n          \"position\": \"relative\",\n          \"display\": \"block\",\n          \"marginLeft\": \"auto\",\n          \"marginRight\": \"auto\",\n          \"maxWidth\": \"1024px\"\n        }\n      }}>{`\n      `}<a parentName=\"span\" {...{\n          \"className\": \"gatsby-resp-image-link\",\n          \"href\": \"/static/1e545b730c25eb373fb4f94da0fae97c/2bef9/WebApiKeyForFirebase-1024x572.png\",\n          \"style\": {\n            \"display\": \"block\"\n          },\n          \"target\": \"_blank\",\n          \"rel\": \"noopener\"\n        }}>{`\n    `}<span parentName=\"a\" {...{\n            \"className\": \"gatsby-resp-image-background-image\",\n            \"style\": {\n              \"paddingBottom\": \"55.99999999999999%\",\n              \"position\": \"relative\",\n              \"bottom\": \"0\",\n              \"left\": \"0\",\n              \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB60lEQVQoz42QyW4TQRCGGx4B8RK8F0cunDAghXCAgIEbUiAcuURWlKAQR8ig5AEQQlmY2AkmOWDkZfZ96ZkPdc+MWC7Q0qfqrqr+axFLOx+5t3vE3cEpt99/ZXlwxoMPp9wfjHi4N+bR/jfNyv6Ylb2xtq1v+e0hne1DlvpHdLYOuLX5GdHpf+LO4Iyb7y64sXvO9Z1zrjwfcvmZgeh+QTw+ruke/7q3PDFquo19aiCqLKWIApAZUHJhJlzrTbn6eop4OUGsTbj06gditb5r34sJQvnUe/V7bdtYnCQoClmizsxM6Z/Y9A4WbAwt3owstkc264bJ5tBi48SiZ9R+xbphsdXkqZjIsowkSUjTFKiIo5zAcbBnM/LAIwt90sBDRoGepAgD8tAnC2qK3+7KLxz12bYbQZBS4vghSZYTpRlZIclkSRAn+GFEGKekeUFWlHXsL0QQBPi+T1nWIxdS4gUhcRwThqHuXh3P8zBNU/uqqs5VE1E1UFFVFUJ9VIJ5nv8hqN5qHe1JkwRVvCgKXbyUUlsloijLRlB1oEQVZSmRssT1Q6I41uR5oUVUUcu29Xpq6+C4Dp4XMV8kOE6smxCtWNuhqmraLtOFxcJymDcsbPefqDwtqPZT76aqBR2XuWlhux626zf2//gJbBEO7CbkOIUAAAAASUVORK5CYII=')\",\n              \"backgroundSize\": \"cover\",\n              \"display\": \"block\"\n            }\n          }}></span>{`\n  `}<img parentName=\"a\" {...{\n            \"className\": \"gatsby-resp-image-image\",\n            \"alt\": \"WebApiKeyForFirebase 1024x572\",\n            \"title\": \"WebApiKeyForFirebase 1024x572\",\n            \"src\": \"/static/1e545b730c25eb373fb4f94da0fae97c/2bef9/WebApiKeyForFirebase-1024x572.png\",\n            \"srcSet\": [\"/static/1e545b730c25eb373fb4f94da0fae97c/5a46d/WebApiKeyForFirebase-1024x572.png 300w\", \"/static/1e545b730c25eb373fb4f94da0fae97c/0a47e/WebApiKeyForFirebase-1024x572.png 600w\", \"/static/1e545b730c25eb373fb4f94da0fae97c/2bef9/WebApiKeyForFirebase-1024x572.png 1024w\"],\n            \"sizes\": \"(max-width: 1024px) 100vw, 1024px\",\n            \"style\": {\n              \"width\": \"100%\",\n              \"height\": \"100%\",\n              \"margin\": \"0\",\n              \"verticalAlign\": \"middle\",\n              \"position\": \"absolute\",\n              \"top\": \"0\",\n              \"left\": \"0\"\n            },\n            \"loading\": \"lazy\",\n            \"decoding\": \"async\"\n          }}></img>{`\n  `}</a>{`\n    `}</span></p>\n    <p>{`The `}<strong parentName=\"p\">{`messagingSenderId`}</strong>{` is an id that is available tab next to the `}<strong parentName=\"p\">{`General`}</strong>{` tab, called `}<strong parentName=\"p\">{`Cloud Messaging`}</strong>{`.`}</p>\n    <p><span parentName=\"p\" {...{\n        \"className\": \"gatsby-resp-image-wrapper\",\n        \"style\": {\n          \"position\": \"relative\",\n          \"display\": \"block\",\n          \"marginLeft\": \"auto\",\n          \"marginRight\": \"auto\",\n          \"maxWidth\": \"1024px\"\n        }\n      }}>{`\n      `}<a parentName=\"span\" {...{\n          \"className\": \"gatsby-resp-image-link\",\n          \"href\": \"/static/93b439778e6ce540a478650931705b71/2bef9/SenderId-1024x505.png\",\n          \"style\": {\n            \"display\": \"block\"\n          },\n          \"target\": \"_blank\",\n          \"rel\": \"noopener\"\n        }}>{`\n    `}<span parentName=\"a\" {...{\n            \"className\": \"gatsby-resp-image-background-image\",\n            \"style\": {\n              \"paddingBottom\": \"49.33333333333333%\",\n              \"position\": \"relative\",\n              \"bottom\": \"0\",\n              \"left\": \"0\",\n              \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB5UlEQVQoz32R227TQBCG9w14DSQQQpXghlsegEfhCRCK1JSmgEAFiVfglIIqKrWglkNvuChVL9K0FNmpEhw7a3vt9fn4o1knht4w0qf5d7wzOzNm3a0DdLYH6Oz+Qm/3DI/3TvFo7wzr+xqe7etY/6a1vPg+wZNPQ3Q2D7G8dYT7Gz9w7/0BVj4c4unOEdY+DsB6n0+w+nWM5S9j3N05x6XnP8HWhmDdAdjKMVj3uPFKD8AeDMFWTxp6c0g/PG00yhSoUpC5fo472xzX+zPcejfD7U2OmxsWlt5auPbGwlLfUuerr00Vu9G3cOWVicsv/8KSLEeaFyiqGlFS4DcXODc5RhOOseHAdDwVWzB1PBg2ITC1BSb8Isz3fRBVVSk8GSAMQyRJgizLkWXZPz6DlBJBECCOU0RRijRN22+EKkjJZEVZwgtCGIYBTdOhj0aN13Voug7OOeIkQRDSo6WiKCuVW6MxRi9QwbquUZYl/CBEICVc120RrgtPCNXB/4xqsCiK1IhUjJBBBCFDGNxpmXIXXPiYOUJh2a5iyh2YtqsgTeticRzPO6zmHUbwfAlzxsFdAXsOxaI4gfB8lRgl6UXiBCntkEamPRZ53v4UWrr0fdU5aXWWEnmeqxjpoijU/cVkC/4A7ffHyXP6jZIAAAAASUVORK5CYII=')\",\n              \"backgroundSize\": \"cover\",\n              \"display\": \"block\"\n            }\n          }}></span>{`\n  `}<img parentName=\"a\" {...{\n            \"className\": \"gatsby-resp-image-image\",\n            \"alt\": \"SenderId 1024x505\",\n            \"title\": \"SenderId 1024x505\",\n            \"src\": \"/static/93b439778e6ce540a478650931705b71/2bef9/SenderId-1024x505.png\",\n            \"srcSet\": [\"/static/93b439778e6ce540a478650931705b71/5a46d/SenderId-1024x505.png 300w\", \"/static/93b439778e6ce540a478650931705b71/0a47e/SenderId-1024x505.png 600w\", \"/static/93b439778e6ce540a478650931705b71/2bef9/SenderId-1024x505.png 1024w\"],\n            \"sizes\": \"(max-width: 1024px) 100vw, 1024px\",\n            \"style\": {\n              \"width\": \"100%\",\n              \"height\": \"100%\",\n              \"margin\": \"0\",\n              \"verticalAlign\": \"middle\",\n              \"position\": \"absolute\",\n              \"top\": \"0\",\n              \"left\": \"0\"\n            },\n            \"loading\": \"lazy\",\n            \"decoding\": \"async\"\n          }}></img>{`\n  `}</a>{`\n    `}</span></p>\n    <p>{`The initialize command will connect the service worker to the server to listen to new messages. The `}<strong parentName=\"p\">{`setBackgroundMessageHandler`}</strong>{` function is called when a new message occurs when the user is not having the website in focus. It means that if the user has the website in a browser's tab that it not the current one, or if the user is not having the website open at all, or if the browser is minimized that this message will be invoked. The case about if the user is having focus will be treated later.`}</p>\n    <p>{`This code get the data from the server. In my case, it's under the property `}<em parentName=\"p\">{`data`}</em>{` and `}<em parentName=\"p\">{`notification`}</em>{`. I set the title, the main message, the icon. The URL is there but didn't work at this time. That is why the second method, which use directly the push notification api to hook on `}<strong parentName=\"p\">{`notificationclick`}</strong>{`. This method handles when the user click the notification to open a specific URL. For example, in my case, the notification occurs when a specific event occurs and clicking the notification opens a specific page where the user can see the result of the action.`}</p>\n    <p>{`The next step is to have a page where the user can subscribe to the push notification. In my case, it's done in the user's profile. I have a checkbox, if checked, the browser will request the authorization to the user to install the service worker. So, in my profile.js page I have the following code:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-typescript\"\n      }}>{`$(document).ready(function () {\n  initialiseUI();\n});\n\nfunction initialiseUI() {\n  $(document).on(\n    \"click\",\n    \"#\" + window.Application.Variables.IsHavingNotification,\n    function requestPushNotification() {\n      var $ctrl = $(this);\n      if ($ctrl.is(\":checked\")) {\n        console.log(\"checked\");\n        subscribeUser();\n      } else {\n        console.log(\"unchecked\");\n        unsubscribeUser();\n      }\n    }\n  );\n}\n\nfunction subscribeUser() {\n  var isSubscribed = false;\n  var messaging = firebase.messaging();\n  messaging\n    .requestPermission()\n    .then(function () {\n      messaging\n        .getToken()\n        .then(function (currentToken) {\n          if (currentToken) {\n            updateSubscriptionOnServer(currentToken);\n            isSubscribed = true;\n          } else {\n            updateSubscriptionOnServer(null);\n          }\n          $(\"#\" + window.Application.Variables.IsHavingNotificationt).prop(\n            \"checked\",\n            isSubscribed\n          );\n        })\n        .catch(function (err) {\n          isSubscribed = false;\n          updateSubscriptionOnServer(null);\n        });\n    })\n    .catch(function (err) {\n      console.log(\"Unable to get permission to notify.\", err);\n    });\n}\n\nfunction unsubscribeUser() {\n  var messaging = firebase.messaging();\n  messaging\n    .getToken()\n    .then(function (currentToken) {\n      messaging\n        .deleteToken(currentToken)\n        .then(function () {\n          updateSubscriptionOnServer(null);\n        })\n        .catch(function (err) {\n          console.log(\"Unable to delete token. \", err);\n        });\n    })\n    .catch(function (err) {\n      console.log(\"Error retrieving Instance ID token. \", err);\n    });\n}\n\nfunction updateSubscriptionOnServer(subscription) {\n  var subscriptionDetail = { key: \"\" };\n  if (subscription) {\n    subscriptionDetail = { key: subscription };\n  } else {\n    console.log(\"delete on the server the token\");\n  }\n  var apiUrl = window.Application.Url.UrlNotifications;\n  var dateToSent = subscriptionDetail;\n  $.ajax({\n    url: apiUrl,\n    type: \"POST\",\n    data: dateToSent,\n    cache: true,\n    dataType: \"json\",\n    success: function (json) {\n      if (json.IsValid) {\n      } else {\n      }\n    },\n    error: function (xmlHttpRequest, textStatus, errorThrown) {\n      console.log(\"some error occured\", textStatus, errorThrown);\n    },\n    always: function () {},\n  });\n}\n`}</code></pre>\n    <p>{`We allow to subscribe and unsubscribe. When subscribing, we request the permission to send the notification by the browser. Then, we get the token provided my Firebase. This is needed to be able to save the token back to the server to have targeted message from the server later. With this token, we will be able to send specific message to specific user. This is where the `}<strong parentName=\"p\">{`updateSubscriptionOnServer`}</strong>{` come to play. It sends by Ajax the token, and it's saved in the database. In my case, I added a column in the user's table to keep track of the token. The unsubscribe sends a null value and set null in the column. This way, the server can look and see if the user has or not a Firebase token and only send a message when a token is defined.`}</p>\n    <p>{`To verify that all the previous steps are well executed, you can look in Chrome developer tool under `}<strong parentName=\"p\">{`Application`}</strong>{` and see for the service worker.`}</p>\n    <p><span parentName=\"p\" {...{\n        \"className\": \"gatsby-resp-image-wrapper\",\n        \"style\": {\n          \"position\": \"relative\",\n          \"display\": \"block\",\n          \"marginLeft\": \"auto\",\n          \"marginRight\": \"auto\",\n          \"maxWidth\": \"1024px\"\n        }\n      }}>{`\n      `}<a parentName=\"span\" {...{\n          \"className\": \"gatsby-resp-image-link\",\n          \"href\": \"/static/e0ba51ca2eec3f175c40ee16f9b6c019/2bef9/ChromeApplicationTab-1024x226.png\",\n          \"style\": {\n            \"display\": \"block\"\n          },\n          \"target\": \"_blank\",\n          \"rel\": \"noopener\"\n        }}>{`\n    `}<span parentName=\"a\" {...{\n            \"className\": \"gatsby-resp-image-background-image\",\n            \"style\": {\n              \"paddingBottom\": \"21.999999999999996%\",\n              \"position\": \"relative\",\n              \"bottom\": \"0\",\n              \"left\": \"0\",\n              \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAuElEQVQY003Py5KDIBBAUf//N3U0EaV5iCBNcqfUpGYWp6BY3G66YRgwxiAihBBwIohYSskcR2HPt/P+pVppTVFVXu12vtVa6MZx5Iw650gpsy4eYwRrPc5FRM4hkVIatb6p9cVx/ImpsaWGuIwPB900TczzfAWtTcSYCX7jaTw/D8f4kCtcil6xWtvnvG27XlJuLPag6/uevh+ub3q/f7ZorC4wL57VRkJIbEnRf6Ev1durvUlJ+QUEizTCTmGCpAAAAABJRU5ErkJggg==')\",\n              \"backgroundSize\": \"cover\",\n              \"display\": \"block\"\n            }\n          }}></span>{`\n  `}<img parentName=\"a\" {...{\n            \"className\": \"gatsby-resp-image-image\",\n            \"alt\": \"ChromeApplicationTab 1024x226\",\n            \"title\": \"ChromeApplicationTab 1024x226\",\n            \"src\": \"/static/e0ba51ca2eec3f175c40ee16f9b6c019/2bef9/ChromeApplicationTab-1024x226.png\",\n            \"srcSet\": [\"/static/e0ba51ca2eec3f175c40ee16f9b6c019/5a46d/ChromeApplicationTab-1024x226.png 300w\", \"/static/e0ba51ca2eec3f175c40ee16f9b6c019/0a47e/ChromeApplicationTab-1024x226.png 600w\", \"/static/e0ba51ca2eec3f175c40ee16f9b6c019/2bef9/ChromeApplicationTab-1024x226.png 1024w\"],\n            \"sizes\": \"(max-width: 1024px) 100vw, 1024px\",\n            \"style\": {\n              \"width\": \"100%\",\n              \"height\": \"100%\",\n              \"margin\": \"0\",\n              \"verticalAlign\": \"middle\",\n              \"position\": \"absolute\",\n              \"top\": \"0\",\n              \"left\": \"0\"\n            },\n            \"loading\": \"lazy\",\n            \"decoding\": \"async\"\n          }}></img>{`\n  `}</a>{`\n    `}</span></p>\n    <p>{`It's important to understand that what we are doing only work under localhost or with HTTPS' website. From Chrome'S debug panel, you can unregister, or click \"Update on reload\" to force a reinstallation of the service worker. This can be handy when developing to be sure to always have the latest version of your service worker.`}</p>\n    <p>{`The next step is to have your website listen to incoming messages. This cover the scenario when the user is on the website and that we do not want to use the browser notification. To do, we need to use some code that we already used in the service worker concerning Firebase's initialization. In my case, I added in the master page (`}{`_`}{`layout.cshtml) a reference to Firebase script to initialize the library. It looks like that:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{` <script src=\"https://www.gstatic.com/firebasejs/3.6.2/firebase.js\"></script> </script>\n <script> var config = {\n   apiKey: \"AIzaSyDe0Z0NtygDUDySNMRtl2MIV5m4Hp7IAm0\",\n   authDomain: \"bourse-virtuelle.firebaseapp.com\",\n   messagingSenderId: \"555061918002\",\n   };\n firebase.initializeApp(config); </script>\n`}</code></pre>\n    <p>{`I also have a global JavaScript file where I added the listener to message which are used in every page I have.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-typescript\"\n      }}>{`$(document).ready(function () {\n  var messaging = firebase.messaging();\n  messaging.onMessage(function (payload) {\n    var dataFromServer = JSON.parse(payload.data.notification);\n    var myMessageBar = new MessageBar();\n    myMessageBar.setMessage(dataFromServer.title + \" : \" + dataFromServer.body);\n  });\n});\n`}</code></pre>\n    <p>{`The listener is `}<strong parentName=\"p\">{`onMessage`}</strong>{` is fired when the user has the focus on the website. So, instead of having the service worker to handle the message, this handler is receiving the data. This give the advantage to be able to add the message directly in the webpage Dom, something that the service worker cannot do. It also has the convenience of having the notification in the field of view of the user instead of having a notification outside.`}</p>\n    <p>{`At this point, you can use any HTTP tools to send a message to Firebase. You can use console.log to output the token and forge a HTTP request with your web api and sender id. I won't give detail in this post and will give how to do it in a future post about how to handle it with a webjob in C# which will send a HTTP request.`}</p>\n    <p>{`Service worker allows you do to a lot more than just using the push notification. This article covered the basis of how to use Google Firebase has a backbone to have your own backend infrastructure (covered in a future article) to send a message and to have your client receiving the message. Several pieces of code is needed in specific places.`}</p>\n\n    </MDXLayout>;\n}\n\n;\nMDXContent.isMDXComponent = true;"}}