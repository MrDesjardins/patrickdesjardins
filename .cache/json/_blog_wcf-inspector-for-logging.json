{"data":{"mdx":{"frontmatter":{"title":"WCF Inspector for logging","date":"November 21, 2013"},"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"WCF Inspector for logging\",\n  \"date\": \"2013-11-21\",\n  \"categories\": [\"wcf\", \"webservices\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"We have already talk about how to log every call of your WCF service with a \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"./how-to-use-log-every-call-of-your-wcf-services-methods\"\n  }, \"custom factory for all your WCF service\"), \". This is a good way to log or to verify access to all your service methods. The main point was to create a factory which is called every calls it's done. Once it generated, it creates a new service behavior to which it needs to have a new operation behavior and invoker.\"), mdx(\"p\", null, \"This time, the solution to log every method call it is by using inspector. An inspector is a filter that is executed before and after a request is executed. First of all, this solution works by configuring in the web.config a behavior. An entry to system.serviceModel > extensions > behaviorExtensions needs to be added and will be used to system.serviceModel > endpointBehaviors > behavior.\"), mdx(\"p\", null, \"Here is an example of the web.config:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-xml\"\n  }, \" <system.serviceModel> <extensions> <behaviorExtensions> <add name=\\\"myLogBehavior\\\" type=\\\"MyServiceA.LogFileBehaviorExtensionElement, MyServiceA\\\" /> </behaviorExtensions> </extensions> ... <services> <service name=\\\"MyServiceA.Service1\\\"> <endpoint address=\\\"\\\" behaviorConfiguration=\\\"behavior1\\\" binding=\\\"wsHttpBinding\\\" bindingConfiguration=\\\"\\\" contract=\\\"MyServiceA.IService1\\\" /> </service> </services> <behaviors> <endpointBehaviors> <behavior name=\\\"behavior1\\\"> <myLogBehavior logFileName=\\\"c:\\\\\\\\log.txt\\\" /> </behavior> </endpointBehaviors>\\n\\n... \\n\")), mdx(\"p\", null, \"Three parts are important. The first one is the extension that define the behavior extension. This allow us to create configuration outside the code that is defined inside the web.config. A name is specify that is referred later inside the web.config, and the second attribute is the name of the extension inside the code. In the example above, the code display a LogFileBehaviorExtensionElement that is inside the MyServiceA namespace. The second part is the service's endpoint itself. This is where we specify the contract, the binding and also the behaviorConfiguration. This behavior configuration lead us to the third important part which is the behavior that we have created. The third part is the endpointBehaviors where it specify the behavior. In the example, it's named \\\"behavior1\\\" which is referenced inside the endpoint. Inside this third part, the myLogBehavior define a parameter where it's the file log name.\"), mdx(\"p\", null, \"The next step is to create the behavior extension element inside the code. \"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" /// <summary> /// Allow to join the end point behavior via web.config + parameter for the web.config /// </summary> public class LogFileBehaviorExtensionElement : BehaviorExtensionElement { [ConfigurationProperty(\\\"logFileName\\\")] public string LogFileName { get { return (string)base[\\\"logFileName\\\"]; } set { base[\\\"logFileName\\\"] = value; } }\\n\\nprotected override object CreateBehavior() { return new LogOutputBehavior(this.LogFileName); }\\n\\npublic override Type BehaviorType { get { return typeof(LogOutputBehavior); } } } \\n\")), mdx(\"p\", null, \"As you can see, this contain a configuration property which is the attribute of the file name defined in the web.config. It also create the behavior. The next class to create is the endpoint behavior. This is where we add the inspector to the endpoint. This mean that every method of the service will have the inspector hooked to them. If it's not the desired behavior, it's also possible to hook an inspector with a custom attribute.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" /// <summary> /// Allow to hook an inspector /// </summary> public class LogOutputBehavior : IEndpointBehavior { private string logFileName; public LogOutputBehavior(string logFileName) { this.logFileName = logFileName; }\\n\\npublic void AddBindingParameters(ServiceEndpoint endpoint, BindingParameterCollection bindingParameters) { }\\n\\npublic void ApplyClientBehavior(ServiceEndpoint endpoint, ClientRuntime clientRuntime) { }\\n\\npublic void ApplyDispatchBehavior(ServiceEndpoint endpoint, EndpointDispatcher endpointDispatcher) { LogOutputMessageInspector inspector = new LogOutputMessageInspector(this.logFileName); endpointDispatcher.DispatchRuntime.MessageInspectors.Add(inspector); }\\n\\npublic void Validate(ServiceEndpoint endpoint) { } } \\n\")), mdx(\"p\", null, \"The behavior create the inspector.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \" /// <summary> /// The inspector /// </summary> public class LogOutputMessageInspector : IDispatchMessageInspector { private string logFileName; public LogOutputMessageInspector(string logFileName) { this.logFileName = logFileName; } public object AfterReceiveRequest(ref Message request, IClientChannel channel, InstanceContext instanceContext) { MessageBuffer buffer = request.CreateBufferedCopy(Int32.MaxValue); request = buffer.CreateMessage(); File.AppendAllText(this.logFileName, \\\"[\\\"+DateTime.Now+\\\"] Request : \\\" + request.ToString()); return null; } public void BeforeSendReply(ref Message reply, object correlationState) { MessageBuffer buffer = reply.CreateBufferedCopy(Int32.MaxValue); reply = buffer.CreateMessage(); File.AppendAllText(this.logFileName, \\\"[\\\" + DateTime.Now + \\\"] Reply : \\\" + reply.ToString()); }\\n\\n} \\n\")), mdx(\"p\", null, \"This is the inspector! We have the AfterReceiveRequest, that is called just before the method of the controller in entered and the BeforeSendReply that is called after the method is called. This Allow you to create an entry in the log and to know the starting and ending time of the call. You can also have access to the message sent. This is in soap format. Here is an example:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-xml\"\n  }, \" [2013-11-09 14:21:01] Reply : <s:Envelope xmlns:a=\\\"http://www.w3.org/2005/08/addressing\\\" xmlns:s=\\\"http://www.w3.org/2003/05/soap-envelope\\\"> <s:Header> <a:Action s:mustUnderstand=\\\"1\\\">http://tempuri.org/IService1/GetDataResponse</a:Action> <a:RelatesTo>urn:uuid:af68f512-6948-4c2f-b0a8-36cbd9799ebf</a:RelatesTo> </s:Header> <s:Body> <GetDataResponse xmlns=\\\"http://tempuri.org/\\\"> <GetDataResult>You entered: 0</GetDataResult> </GetDataResponse> </s:Body> </s:Envelope> \\n\")), mdx(\"p\", null, \"You have all the information you want. In real, you would like to parse this xml to get the method name which is inside the envelope>header>action or by using the Message property Headers and use the Action property to get the method called. It's also possible to get HttpRequest information is the endpoint is an http one.\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"400px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/06daa0fe3052457f22d8370d23a345c4/e17e5/MessageWithHttpRequest-400x289.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"72.33333333333334%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACYUlEQVQ4y4WT60/TYBTG+3dLQkjUoB+IogEB4xcTDZjwyRhjouJAhMC4mRAYm7t0W9e1W9v13vXyM++LLARQT/LknPR9ztNznr5VjuoniNB7FarnX1Hr3zk52ubwYJt6bR+tW8YyjnH6R8SRgx/4BGFIkozJsow8zymKYgKlfPge2yxTq2xyfLBB5bREo1qi197CMvYx+/uY2i5Wbxezt0OnuYGp7WAZe7jWoey1zf1JVpqqRuWiQbPRwbZtgsDD91w81yPPM4oivwQFcRzTajZRWy3aalvWtVoNTdPQezp9vY9iDCwq5xXiOJKrZ1ku17gJEWEYYhqmFA6DkCAIicLoD6eQUHRjSLVao9Vs4brunWLSJwrZbPQNfN+X3CukaSr9EzzFcly6XY1GvcHIGf1dsCiIogjf8+W0Vx/hJk8Z2iMazRYDcyCJ/5wwiuh2ulhDC9M0pee3BC3bRVXb0tC73njdQyEoVk6SRPopvLwl6Lo+pu3i+eFklat8c2UhpLZU0iy7k3Mp6AlBj55ukMQRcXSJNB2Ljsm1EbV41u10cMT18j0JccVGjkMYBJKjOCOPJM2oqTojL8D1I4kgTknSgjjNJZKswA8Tuj2DeJzjjCIGVoBuerh+Is8FT7HskRy9dGbx+SJhq1Ww2cwpNXK+1TNK1/FrzJfTIR/LOus/NNZ2DNb3TD78dPh0FkiOEkWJ/CPEKkWW8r9Ix7Fw7xpyyLPJuTI7/5rpR8vMzC7ydGmVJy/e8mxlTdbzy6uyFvn5y3fMLb5henaJqQcLTD1Y5J7MC0w9XGDm8Qr3517xG4P/GEExjiU1AAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"MessageWithHttpRequest 400x289\",\n    \"title\": \"MessageWithHttpRequest 400x289\",\n    \"src\": \"/static/06daa0fe3052457f22d8370d23a345c4/e17e5/MessageWithHttpRequest-400x289.png\",\n    \"srcSet\": [\"/static/06daa0fe3052457f22d8370d23a345c4/5a46d/MessageWithHttpRequest-400x289.png 300w\", \"/static/06daa0fe3052457f22d8370d23a345c4/e17e5/MessageWithHttpRequest-400x289.png 400w\"],\n    \"sizes\": \"(max-width: 400px) 100vw, 400px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"This is it for WCF inspector.\"));\n}\n;\nMDXContent.isMDXComponent = true;"}},"pageContext":{"id":"446ee197-08d3-56fe-9cd4-93943477f0dc"}}